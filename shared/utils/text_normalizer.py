"""
–£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞ —Ç–æ–≤–∞—Ä–æ–≤
"""
import re
import html
import unicodedata


def normalize_product_name(text: str) -> str:
    """
    –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞, —É–¥–∞–ª—è—è –Ω–µ–æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–µ —Å–∏–º–≤–æ–ª—ã –∏ –ª–∏—à–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã
    
    Args:
        text: –ò—Å—Ö–æ–¥–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
        
    Returns:
        –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
    """
    if not text:
        return ""
    
    # 1. HTML-–¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ
    text = html.unescape(text)
    
    # 2. –£–¥–∞–ª–µ–Ω–∏–µ HTML-—Ç–µ–≥–æ–≤ (–≤–∫–ª—é—á–∞—è <notr>, <br> –∏ –¥—Ä—É–≥–∏–µ)
    text = re.sub(r'<[^>]+>', '', text)
    
    # 3. –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ Unicode
    # –ú—è–≥–∫–∏–π –ø–µ—Ä–µ–Ω–æ—Å (U+00AD), –Ω–µ—Ä–∞–∑—Ä—ã–≤–Ω—ã–π –ø—Ä–æ–±–µ–ª (U+00A0) –∏ –¥—Ä—É–≥–∏–µ
    text = re.sub(r'[\u00ad\u00a0\u200b\u200c\u200d\u2060\ufeff]', '', text)
    
    # 4. –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è Unicode (NFD -> NFC)
    text = unicodedata.normalize('NFC', text)
    
    # 5. –ó–∞–º–µ–Ω–∞ —ë ‚Üí –µ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è (—Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫)
    # –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è match_score, —Ç–∞–∫ –∫–∞–∫ "—á—ë—Ä–Ω–∞—è" –∏ "—á–µ—Ä–Ω–∞—è" –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å
    text = text.replace('—ë', '–µ').replace('–Å', '–ï')
    
    # 6. –£–¥–∞–ª–µ–Ω–∏–µ –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤ –∏ —Ç–∞–±—É–ª—è—Ü–∏–π
    text = re.sub(r'\s+', ' ', text).strip()
    
    return text


def normalize_product_names_batch(names: list[str]) -> list[str]:
    """
    –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç —Å–ø–∏—Å–æ–∫ –Ω–∞–∑–≤–∞–Ω–∏–π —Ç–æ–≤–∞—Ä–æ–≤
    
    Args:
        names: –°–ø–∏—Å–æ–∫ –∏—Å—Ö–æ–¥–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π
        
    Returns:
        –°–ø–∏—Å–æ–∫ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π
    """
    return [normalize_product_name(name) for name in names]


def test_normalize_product_name():
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏"""
    test_cases = [
        # –ú—è–≥–∫–∏–π –ø–µ—Ä–µ–Ω–æ—Å
        ("–ö–æ–ª¬≠–±–∞¬≠—Å–∞ –°–∞–ª—å¬≠—á–∏¬≠—á–æ–Ω –ß–µ—Ä¬≠–∫–∏¬≠–∑–æ¬≠–≤–æ 300 –≥", "–ö–æ–ª–±–∞—Å–∞ –°–∞–ª—å—á–∏—á–æ–Ω –ß–µ—Ä–∫–∏–∑–æ–≤–æ 300 –≥"),
        # HTML —Ç–µ–≥–∏
        ("–ú–æ–ª–æ¬≠–∫–æ 3,2% <notr>–ò–∑ –õ–∞–≤–∫–∏</notr> 930 –º–ª", "–ú–æ–ª–æ–∫–æ 3,2% –ò–∑ –õ–∞–≤–∫–∏ 930 –º–ª"),
        # –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã
        ("–•–ª–µ–±    –±–µ–ª—ã–π   –Ω–∞—Ä–µ–∑–Ω–æ–π", "–•–ª–µ–± –±–µ–ª—ã–π –Ω–∞—Ä–µ–∑–Ω–æ–π"),
        # –ù–µ—Ä–∞–∑—Ä—ã–≤–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã
        ("–ú–∞—Å–ª–æ\u00a0—Å–ª–∏–≤–æ—á–Ω–æ–µ\u00a0200–≥", "–ú–∞—Å–ª–æ —Å–ª–∏–≤–æ—á–Ω–æ–µ 200–≥"),
        # –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ª—É—á–∞–π
        ("–ô–æ¬≠–≥—É—Ä—Ç <b>–î–∞–Ω–æ–Ω</b>  \u00a0 –∫–ª—É–±¬≠–Ω–∏¬≠–∫–∞", "–ô–æ–≥—É—Ä—Ç –î–∞–Ω–æ–Ω –∫–ª—É–±–Ω–∏–∫–∞"),
        # –û–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç (–Ω–µ –¥–æ–ª–∂–µ–Ω –∏–∑–º–µ–Ω–∏—Ç—å—Å—è)
        ("–ú–æ–ª–æ–∫–æ 3.2% 1–ª", "–ú–æ–ª–æ–∫–æ 3.2% 1–ª"),
        # –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞
        ("", ""),
        # –¢–æ–ª—å–∫–æ –ø—Ä–æ–±–µ–ª—ã –∏ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã
        ("\u00ad\u00a0  \t", "")
    ]
    
    print("üß™ Testing normalize_product_name function:")
    print("=" * 80)
    
    for i, (input_text, expected) in enumerate(test_cases, 1):
        result = normalize_product_name(input_text)
        status = "‚úÖ PASS" if result == expected else "‚ùå FAIL"
        
        print(f"Test {i}: {status}")
        print(f"  Input:    '{input_text}'")
        print(f"  Expected: '{expected}'") 
        print(f"  Got:      '{result}'")
        if result != expected:
            print(f"  Diff:     Expected length {len(expected)}, got {len(result)}")
        print()
    
    print("=" * 80)
    print("Testing completed!")


if __name__ == "__main__":
    test_normalize_product_name()
