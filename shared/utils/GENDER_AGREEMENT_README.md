# Согласование прилагательных по роду в альтернативах

## Проблема

При использовании альтернатив через слеш `/`, общие прилагательные не согласовывались с родом товара:

**Было:**
```
"форель / семга / лосось слабосоленая" 
→ "Лосось слабосоленая" ❌ (неправильно)
```

**Стало:**
```
"форель / семга / лосось слабосоленая"
→ "Лосось слабосоленый" ✅ (правильно!)
```

## Решение

Создано 2 новых модуля:

### 1. `shared/utils/brand_registry.py`
Реестр брендов для защиты от неправильного склонения:
- `is_brand_text()` - проверка наличия бренда в тексте
- `get_brand_words_in_text()` - получение слов брендов
- Защищает фразы типа "Русское Море" от изменения

### 2. `shared/utils/gender_agreement.py`
Автоматическое согласование прилагательных по роду:
- **Словарь рода продуктов** (~200+ продуктов: форель→ж, лосось→м, молоко→ср)
- **Таблица окончаний** (ая→ый, ий→ая, ое→ый, и т.д.)
- **Функции:**
  - `get_product_gender()` - определение рода продукта
  - `detect_adjective_gender()` - определение рода прилагательного
  - `change_adjective_gender()` - изменение окончания
  - `apply_gender_agreement()` - применение согласования к тексту

### 3. Обновлен `shared/utils/alternatives_parser.py`
Добавлена интеграция согласования в `parse_alternatives()`:
```python
# При формировании альтернатив
agreed_suffix = apply_gender_agreement(alt_clean, common_suffix, main_gender)
alternatives.append(f"{alt_clean} {agreed_suffix}")
```

## Примеры работы

### Пример 1: Женский → Мужской род
```python
parse_alternatives("форель / семга / лосось слабосоленая русское море")
{
    "main": "форель слабосоленая русское море",
    "alternatives": [
        "семга слабосоленая русское море",  # ж→ж (не меняется)
        "лосось слабосоленый русское море"  # ж→м (согласовано!)
    ]
}
```

### Пример 2: Средний → Мужской род
```python
parse_alternatives("молоко / кефир цельное 3.2%")
{
    "main": "молоко цельное 3.2%",
    "alternatives": ["кефир цельный 3.2%"]  # ср→м
}
```

### Пример 3: Защита брендов
```python
# "русское море" не изменяется, т.к. это бренд
parse_alternatives("форель / лосось слабосоленая русское море")
# → "лосось слабосоленый русское море" 
#    (только "слабосоленая" изменилось, "русское" осталось)
```

## Тестирование

Все модули имеют встроенные тесты:

```bash
# Тест согласования по роду
python3 shared/utils/gender_agreement.py

# Тест парсера альтернатив
python3 shared/utils/alternatives_parser.py
```

## Интеграция в проект

Модуль уже интегрирован в `order-service/main.py`:
```python
from shared.utils.alternatives_parser import parse_alternatives

# При создании заказа
alternatives_data = parse_alternatives(product.name)
main_name = alternatives_data['main']
alternatives_list = alternatives_data['alternatives']
```

## Расширение словаря

Чтобы добавить новый продукт в словарь рода:

1. Откройте `shared/utils/gender_agreement.py`
2. Добавьте в `PRODUCT_GENDER`:
```python
'новый_продукт': 'm',  # или 'f', 'n'
```

Чтобы добавить новый бренд:

1. Откройте `shared/utils/brand_registry.py`
2. Добавьте в `BRAND_PHRASES`:
```python
'новый бренд',
```

## Статус

✅ Все тесты пройдены
✅ Интегрировано в order-service
✅ Готово к использованию
