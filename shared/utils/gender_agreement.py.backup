"""
–ú–æ–¥—É–ª—å –¥–ª—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è –ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ —Ä–æ–¥—É –≤ –Ω–∞–∑–≤–∞–Ω–∏—è—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤
"""
import re
from typing import Literal, List, Dict, Optional
from shared.utils.brand_registry import is_brand_text, get_brand_words_in_text

Gender = Literal['m', 'f', 'n', 'unknown']


# ============================================================================
# –°–õ–û–í–ê–†–¨ –†–û–î–ê –ü–†–û–î–£–ö–¢–û–í
# ============================================================================

PRODUCT_GENDER = {
    # –†—ã–±–∞ –∏ –º–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç—ã
    '—Ñ–æ—Ä–µ–ª—å': 'f',
    '—Å–µ–º–≥–∞': 'f',
    '—Å–µ–º–≥—É': 'f',
    '–≥–æ—Ä–±—É—à–∞': 'f',
    '–≥–æ—Ä–±—É—à—É': 'f',
    '–∫–µ—Ç–∞': 'f',
    '–∫–µ—Ç—É': 'f',
    '—Å–∫—É–º–±—Ä–∏—è': 'f',
    '—Å–∫—É–º–±—Ä–∏—é': 'f',
    '—Å–µ–ª—å–¥—å': 'f',
    '—Å–µ–ª–µ–¥–∫–∞': 'f',
    '—Ç—Ä–µ—Å–∫–∞': 'f',
    '—Ç—Ä–µ—Å–∫—É': 'f',
    '–ª–æ—Å–æ—Å—å': 'm',
    '–ª–æ—Å–æ—Å–æ—Å—å': 'm',
    '–∫–∞—Ä–ø': 'm',
    '–∫–∞—Ä–ø–∞': 'm',
    '–æ–∫—É–Ω—å': 'm',
    '–æ–∫—É–Ω—è': 'm',
    '—Å—É–¥–∞–∫': 'm',
    '—Å—É–¥–∞–∫–∞': 'm',
    '—Ç—É–Ω–µ—Ü': 'm',
    '—Ç—É–Ω—Ü–∞': 'm',
    '–ø–∞–ª—Ç—É—Å': 'm',
    '–ø–∞–ª—Ç—É—Å–∞': 'm',
    '—Å–æ–º': 'm',
    '—Å–æ–º–∞': 'm',
    '–∏–∫—Ä–∞': 'f',
    '–∏–∫—Ä—É': 'f',
    '–∫—Ä–µ–≤–µ—Ç–∫–∞': 'f',
    '–∫—Ä–µ–≤–µ—Ç–∫–∏': 'f',
    '–∫—Ä–∞–±': 'm',
    '–∫—Ä–∞–±–∞': 'm',
    '–∫–∞–ª—å–º–∞—Ä': 'm',
    '–∫–∞–ª—å–º–∞—Ä–∞': 'm',
    '–º–∏–¥–∏—è': 'f',
    '–º–∏–¥–∏–∏': 'f',
    
    # –ú–æ–ª–æ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã
    '–º–æ–ª–æ–∫–æ': 'n',
    '–∫–µ—Ñ–∏—Ä': 'm',
    '–∫–µ—Ñ–∏—Ä–∞': 'm',
    '–π–æ–≥—É—Ä—Ç': 'm',
    '–π–æ–≥—É—Ä—Ç–∞': 'm',
    '—Ç–≤–æ—Ä–æ–≥': 'm',
    '—Ç–≤–æ—Ä–æ–≥–∞': 'm',
    '—Å–º–µ—Ç–∞–Ω–∞': 'f',
    '—Å–º–µ—Ç–∞–Ω—É': 'f',
    '—Å–ª–∏–≤–∫–∏': 'f',
    '—Ä—è–∂–µ–Ω–∫–∞': 'f',
    '—Ä—è–∂–µ–Ω–∫—É': 'f',
    '–ø—Ä–æ—Å—Ç–æ–∫–≤–∞—à–∞': 'f',
    '–ø—Ä–æ—Å—Ç–æ–∫–≤–∞—à—É': 'f',
    '–º–∞—Å–ª–æ': 'n',
    '—Å—ã—Ä': 'm',
    '—Å—ã—Ä–∞': 'm',
    '—Å—ã—Ä–æ–∫': 'm',
    '—Å—ã—Ä–∫–∞': 'm',
    '—Ç–≤–æ—Ä–æ–∂–æ–∫': 'm',
    '—Ç–≤–æ—Ä–æ–∂–∫–∞': 'm',
    
    # –ú—è—Å–æ –∏ –ø—Ç–∏—Ü–∞
    '–∫—É—Ä–∏—Ü–∞': 'f',
    '–∫—É—Ä–∏—Ü—É': 'f',
    '–∫—É—Ä–∏—Ü': 'f',
    '–∏–Ω–¥–µ–π–∫–∞': 'f',
    '–∏–Ω–¥–µ–π–∫—É': 'f',
    '—É—Ç–∫–∞': 'f',
    '—É—Ç–∫—É': 'f',
    '–≥—É—Å—å': 'm',
    '–≥—É—Å—è': 'm',
    '–≥–æ–≤—è–¥–∏–Ω–∞': 'f',
    '–≥–æ–≤—è–¥–∏–Ω—É': 'f',
    '—Å–≤–∏–Ω–∏–Ω–∞': 'f',
    '—Å–≤–∏–Ω–∏–Ω—É': 'f',
    '–±–∞—Ä–∞–Ω–∏–Ω–∞': 'f',
    '–±–∞—Ä–∞–Ω–∏–Ω—É': 'f',
    '—Ç–µ–ª—è—Ç–∏–Ω–∞': 'f',
    '—Ç–µ–ª—è—Ç–∏–Ω—É': 'f',
    '—Ñ–∞—Ä—à': 'm',
    '—Ñ–∞—Ä—à–∞': 'm',
    '–∫–æ–ª–±–∞—Å–∞': 'f',
    '–∫–æ–ª–±–∞—Å—É': 'f',
    '—Å–æ—Å–∏—Å–∫–∞': 'f',
    '—Å–æ—Å–∏—Å–∫–∏': 'f',
    '—Å–∞—Ä–¥–µ–ª—å–∫–∞': 'f',
    '—Å–∞—Ä–¥–µ–ª—å–∫–∏': 'f',
    '–≤–µ—Ç—á–∏–Ω–∞': 'f',
    '–≤–µ—Ç—á–∏–Ω—É': 'f',
    '–±–µ–∫–æ–Ω': 'm',
    '–±–µ–∫–æ–Ω–∞': 'm',
    '–≥—Ä—É–¥–∫–∞': 'f',
    '–≥—Ä—É–¥–∫—É': 'f',
    '—Ñ–∏–ª–µ': 'n',
    '–æ–∫–æ—Ä–æ–∫': 'm',
    '–æ–∫–æ—Ä–æ–∫–∞': 'm',
    
    # –û–≤–æ—â–∏
    '–∫–∞—Ä—Ç–æ—Ñ–µ–ª—å': 'm',
    '–∫–∞—Ä—Ç–æ—Ñ–µ–ª—è': 'm',
    '–∫–∞—Ä—Ç–æ—à–∫–∞': 'f',
    '–∫–∞—Ä—Ç–æ—à–∫—É': 'f',
    '–º–æ—Ä–∫–æ–≤—å': 'f',
    '–º–æ—Ä–∫–æ–≤–∫—É': 'f',
    '–∫–∞–ø—É—Å—Ç–∞': 'f',
    '–∫–∞–ø—É—Å—Ç—É': 'f',
    '–ª—É–∫': 'm',
    '–ª—É–∫–∞': 'm',
    '—á–µ—Å–Ω–æ–∫': 'm',
    '—á–µ—Å–Ω–æ–∫–∞': 'm',
    '—Å–≤–µ–∫–ª–∞': 'f',
    '—Å–≤–µ–∫–ª—É': 'f',
    '–æ–≥—É—Ä–µ—Ü': 'm',
    '–æ–≥—É—Ä—Ü–∞': 'm',
    '–ø–æ–º–∏–¥–æ—Ä': 'm',
    '–ø–æ–º–∏–¥–æ—Ä–∞': 'm',
    '—Ç–æ–º–∞—Ç': 'm',
    '—Ç–æ–º–∞—Ç–∞': 'm',
    '–ø–µ—Ä–µ—Ü': 'm',
    '–ø–µ—Ä—Ü–∞': 'm',
    '–±–∞–∫–ª–∞–∂–∞–Ω': 'm',
    '–±–∞–∫–ª–∞–∂–∞–Ω–∞': 'm',
    '–∫–∞–±–∞—á–æ–∫': 'm',
    '–∫–∞–±–∞—á–∫–∞': 'm',
    '—Ç—ã–∫–≤–∞': 'f',
    '—Ç—ã–∫–≤—É': 'f',
    '—Ä–µ–¥–∏—Å': 'm',
    '—Ä–µ–¥–∏—Å–∞': 'm',
    '—Ä–µ–¥—å–∫–∞': 'f',
    '—Ä–µ–¥—å–∫—É': 'f',
    '—Å–∞–ª–∞—Ç': 'm',
    '—Å–∞–ª–∞—Ç–∞': 'm',
    '–∑–µ–ª–µ–Ω—å': 'f',
    '–ø–µ—Ç—Ä—É—à–∫–∞': 'f',
    '–ø–µ—Ç—Ä—É—à–∫—É': 'f',
    '—É–∫—Ä–æ–ø': 'm',
    '—É–∫—Ä–æ–ø–∞': 'm',
    '–∫–∏–Ω–∑–∞': 'f',
    '–∫–∏–Ω–∑—É': 'f',
    '–±–∞–∑–∏–ª–∏–∫': 'm',
    '–±–∞–∑–∏–ª–∏–∫–∞': 'm',
    '—à–ø–∏–Ω–∞—Ç': 'm',
    '—à–ø–∏–Ω–∞—Ç–∞': 'm',
    
    # –§—Ä—É–∫—Ç—ã –∏ —è–≥–æ–¥—ã
    '—è–±–ª–æ–∫–æ': 'n',
    '–≥—Ä—É—à–∞': 'f',
    '–≥—Ä—É—à—É': 'f',
    '–±–∞–Ω–∞–Ω': 'm',
    '–±–∞–Ω–∞–Ω–∞': 'm',
    '–∞–ø–µ–ª—å—Å–∏–Ω': 'm',
    '–∞–ø–µ–ª—å—Å–∏–Ω–∞': 'm',
    '–º–∞–Ω–¥–∞—Ä–∏–Ω': 'm',
    '–º–∞–Ω–¥–∞—Ä–∏–Ω–∞': 'm',
    '–ª–∏–º–æ–Ω': 'm',
    '–ª–∏–º–æ–Ω–∞': 'm',
    '–≥—Ä–µ–π–ø—Ñ—Ä—É—Ç': 'm',
    '–≥—Ä–µ–π–ø—Ñ—Ä—É—Ç–∞': 'm',
    '–∫–∏–≤–∏': 'n',
    '–∞–Ω–∞–Ω–∞—Å': 'm',
    '–∞–Ω–∞–Ω–∞—Å–∞': 'm',
    '–º–∞–Ω–≥–æ': 'n',
    '–∞–≤–æ–∫–∞–¥–æ': 'n',
    '–ø–µ—Ä—Å–∏–∫': 'm',
    '–ø–µ—Ä—Å–∏–∫–∞': 'm',
    '–∞–±—Ä–∏–∫–æ—Å': 'm',
    '–∞–±—Ä–∏–∫–æ—Å–∞': 'm',
    '—Å–ª–∏–≤–∞': 'f',
    '—Å–ª–∏–≤—É': 'f',
    '–≤–∏–Ω–æ–≥—Ä–∞–¥': 'm',
    '–≤–∏–Ω–æ–≥—Ä–∞–¥–∞': 'm',
    '–∞—Ä–±—É–∑': 'm',
    '–∞—Ä–±—É–∑–∞': 'm',
    '–¥—ã–Ω—è': 'f',
    '–¥—ã–Ω—é': 'f',
    '–∫–ª—É–±–Ω–∏–∫–∞': 'f',
    '–∫–ª—É–±–Ω–∏–∫—É': 'f',
    '–∑–µ–º–ª—è–Ω–∏–∫–∞': 'f',
    '–∑–µ–º–ª—è–Ω–∏–∫—É': 'f',
    '–º–∞–ª–∏–Ω–∞': 'f',
    '–º–∞–ª–∏–Ω—É': 'f',
    '—á–µ—Ä–Ω–∏–∫–∞': 'f',
    '—á–µ—Ä–Ω–∏–∫—É': 'f',
    '–≥–æ–ª—É–±–∏–∫–∞': 'f',
    '–≥–æ–ª—É–±–∏–∫—É': 'f',
    '—Å–º–æ—Ä–æ–¥–∏–Ω–∞': 'f',
    '—Å–º–æ—Ä–æ–¥–∏–Ω—É': 'f',
    '–∫–ª—é–∫–≤–∞': 'f',
    '–∫–ª—é–∫–≤—É': 'f',
    '–±—Ä—É—Å–Ω–∏–∫–∞': 'f',
    '–±—Ä—É—Å–Ω–∏–∫—É': 'f',
    
    # –ù–∞–ø–∏—Ç–∫–∏
    '—Å–æ–∫': 'm',
    '—Å–æ–∫–∞': 'm',
    '–≤–æ–¥–∞': 'f',
    '–≤–æ–¥—É': 'f',
    '—á–∞–π': 'm',
    '—á–∞—è': 'm',
    '–∫–æ—Ñ–µ': 'm',
    '–∫–≤–∞—Å': 'm',
    '–∫–≤–∞—Å–∞': 'm',
    '–ª–∏–º–æ–Ω–∞–¥': 'm',
    '–ª–∏–º–æ–Ω–∞–¥–∞': 'm',
    '–º–æ—Ä—Å': 'm',
    '–º–æ—Ä—Å–∞': 'm',
    '–∫–æ–º–ø–æ—Ç': 'm',
    '–∫–æ–º–ø–æ—Ç–∞': 'm',
    '–Ω–∞–ø–∏—Ç–æ–∫': 'm',
    '–Ω–∞–ø–∏—Ç–∫–∞': 'm',
    
    # –ë–∞–∫–∞–ª–µ—è
    '—Ö–ª–µ–±': 'm',
    '—Ö–ª–µ–±–∞': 'm',
    '–±–∞—Ç–æ–Ω': 'm',
    '–±–∞—Ç–æ–Ω–∞': 'm',
    '–±—É–ª–∫–∞': 'f',
    '–±—É–ª–∫—É': 'f',
    '–ª–∞–≤–∞—à': 'm',
    '–ª–∞–≤–∞—à–∞': 'm',
    '–∫—Ä—É–ø–∞': 'f',
    '–∫—Ä—É–ø—É': 'f',
    '—Ä–∏—Å': 'm',
    '—Ä–∏—Å–∞': 'm',
    '–≥—Ä–µ—á–∫–∞': 'f',
    '–≥—Ä–µ—á–∫—É': 'f',
    '–æ–≤—Å—è–Ω–∫–∞': 'f',
    '–æ–≤—Å—è–Ω–∫—É': 'f',
    '–ø–µ—Ä–ª–æ–≤–∫–∞': 'f',
    '–ø–µ—Ä–ª–æ–≤–∫—É': 'f',
    '–ø—à–µ–Ω–æ': 'n',
    '–º–∞–Ω–∫–∞': 'f',
    '–º–∞–Ω–∫—É': 'f',
    '–º–∞–∫–∞—Ä–æ–Ω—ã': 'm',
    '—Å–ø–∞–≥–µ—Ç—Ç–∏': 'n',
    '–ø–∞—Å—Ç–∞': 'f',
    '–ø–∞—Å—Ç—É': 'f',
    '–º—É–∫–∞': 'f',
    '–º—É–∫—É': 'f',
    '—Å–∞—Ö–∞—Ä': 'm',
    '—Å–∞—Ö–∞—Ä–∞': 'm',
    '—Å–æ–ª—å': 'f',
    '—É–∫—Å—É—Å': 'm',
    '—É–∫—Å—É—Å–∞': 'm',
    '—Å–æ—É—Å': 'm',
    '—Å–æ—É—Å–∞': 'm',
    '–∫–µ—Ç—á—É–ø': 'm',
    '–∫–µ—Ç—á—É–ø–∞': 'm',
    '–º–∞–π–æ–Ω–µ–∑': 'm',
    '–º–∞–π–æ–Ω–µ–∑–∞': 'm',
    '–≥–æ—Ä—á–∏—Ü–∞': 'f',
    '–≥–æ—Ä—á–∏—Ü—É': 'f',
    
    # –Ø–π—Ü–∞
    '—è–π—Ü–æ': 'n',
    '—è–π—Ü–∞': 'n',
    '—è–∏—Ü': 'n',
    
    # –°–ª–∞–¥–æ—Å—Ç–∏
    '—à–æ–∫–æ–ª–∞–¥': 'm',
    '—à–æ–∫–æ–ª–∞–¥–∞': 'm',
    '–∫–æ–Ω—Ñ–µ—Ç–∞': 'f',
    '–∫–æ–Ω—Ñ–µ—Ç—ã': 'f',
    '–ø–µ—á–µ–Ω—å–µ': 'n',
    '–ø—Ä—è–Ω–∏–∫': 'm',
    '–ø—Ä—è–Ω–∏–∫–∞': 'm',
    '–≤–∞—Ñ–ª—è': 'f',
    '–≤–∞—Ñ–ª–∏': 'f',
    '—Ç–æ—Ä—Ç': 'm',
    '—Ç–æ—Ä—Ç–∞': 'm',
    '–ø–∏—Ä–æ–≥': 'm',
    '–ø–∏—Ä–æ–≥–∞': 'm',
    '–∫–µ–∫—Å': 'm',
    '–∫–µ–∫—Å–∞': 'm',
    '–ø–∏—Ä–æ–∂–Ω–æ–µ': 'n',
    '–∑–µ—Ñ–∏—Ä': 'm',
    '–∑–µ—Ñ–∏—Ä–∞': 'm',
    '–º–∞—Ä–º–µ–ª–∞–¥': 'm',
    '–º–∞—Ä–º–µ–ª–∞–¥–∞': 'm',
    '–≤–∞—Ä–µ–Ω—å–µ': 'n',
    '–¥–∂–µ–º': 'm',
    '–¥–∂–µ–º–∞': 'm',
    '–º–µ–¥': 'm',
    '–º–µ–¥–∞': 'm',
}


# ============================================================================
# –¢–ê–ë–õ–ò–¶–´ –û–ö–û–ù–ß–ê–ù–ò–ô –ü–†–ò–õ–ê–ì–ê–¢–ï–õ–¨–ù–´–•
# ============================================================================

ADJECTIVE_ENDINGS = {
    # –ñ–µ–Ω—Å–∫–∏–π —Ä–æ–¥ ‚Üí –ú—É–∂—Å–∫–æ–π —Ä–æ–¥
    ('–∞—è', 'm'): '—ã–π',
    ('—è—è', 'm'): '–∏–π',
    ('—å—è', 'm'): '–∏–π',
    
    # –ñ–µ–Ω—Å–∫–∏–π —Ä–æ–¥ ‚Üí –°—Ä–µ–¥–Ω–∏–π —Ä–æ–¥
    ('–∞—è', 'n'): '–æ–µ',
    ('—è—è', 'n'): '–µ–µ',
    ('—å—è', 'n'): '–µ–µ',
    
    # –ú—É–∂—Å–∫–æ–π —Ä–æ–¥ ‚Üí –ñ–µ–Ω—Å–∫–∏–π —Ä–æ–¥
    ('—ã–π', 'f'): '–∞—è',
    ('–∏–π', 'f'): '–∞—è',
    ('–æ–π', 'f'): '–∞—è',
    
    # –ú—É–∂—Å–∫–æ–π —Ä–æ–¥ ‚Üí –°—Ä–µ–¥–Ω–∏–π —Ä–æ–¥
    ('—ã–π', 'n'): '–æ–µ',
    ('–∏–π', 'n'): '–µ–µ',
    ('–æ–π', 'n'): '–æ–µ',
    
    # –°—Ä–µ–¥–Ω–∏–π —Ä–æ–¥ ‚Üí –ú—É–∂—Å–∫–æ–π —Ä–æ–¥
    ('–æ–µ', 'm'): '—ã–π',
    ('–µ–µ', 'm'): '–∏–π',
    
    # –°—Ä–µ–¥–Ω–∏–π —Ä–æ–¥ ‚Üí –ñ–µ–Ω—Å–∫–∏–π —Ä–æ–¥
    ('–æ–µ', 'f'): '–∞—è',
    ('–µ–µ', 'f'): '—è—è',
}


# ============================================================================
# –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò
# ============================================================================

def get_product_gender(product_name: str) -> Gender:
    """
    –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ä–æ–¥ –ø—Ä–æ–¥—É–∫—Ç–∞ –ø–æ —Å–ª–æ–≤–∞—Ä—é –∏–ª–∏ —ç–≤—Ä–∏—Å—Ç–∏–∫–∞–º
    
    Args:
        product_name: –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ª–æ–≤)
        
    Returns:
        'm' (–º—É–∂—Å–∫–æ–π), 'f' (–∂–µ–Ω—Å–∫–∏–π), 'n' (—Å—Ä–µ–¥–Ω–∏–π), 'unknown'
    """
    if not product_name:
        return 'unknown'
    
    # –ü—Ä–∏–≤–æ–¥–∏–º –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É –∏ –±–µ—Ä–µ–º –ø–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ
    words = product_name.lower().strip().split()
    if not words:
        return 'unknown'
    
    first_word = words[0]
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–ª–æ–≤–∞—Ä—å
    if first_word in PRODUCT_GENDER:
        return PRODUCT_GENDER[first_word]
    
    # –≠–≤—Ä–∏—Å—Ç–∏–∫–∏ –ø–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è–º
    if first_word.endswith(('–∞', '—è')) and not first_word.endswith(('–∏—è', '–∏–Ω–∞')):
        male_exceptions = ['–ø–∞–ø–∞', '–¥—è–¥—è', '—é–Ω–æ—à–∞', '—Å–ª—É–≥–∞']
        if first_word not in male_exceptions:
            return 'f'
    
    if first_word.endswith(('–æ', '–µ', '–º—è')):
        return 'n'
    
    if first_word.endswith('—å'):
        return 'f'
    
    return 'm'


def detect_adjective_gender(adjective: str) -> Gender:
    """
    –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ä–æ–¥ –ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø–æ –æ–∫–æ–Ω—á–∞–Ω–∏—é
    
    Args:
        adjective: –ü—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω–æ–µ
        
    Returns:
        'm', 'f', 'n' –∏–ª–∏ 'unknown'
    """
    adj_lower = adjective.lower().strip()
    
    if adj_lower.endswith(('–∞—è', '—è—è', '—å—è')):
        return 'f'
    
    if adj_lower.endswith(('—ã–π', '–∏–π', '–æ–π')):
        return 'm'
    
    if adj_lower.endswith(('–æ–µ', '–µ–µ', '—å–µ')):
        return 'n'
    
    return 'unknown'


def change_adjective_gender(adjective: str, target_gender: Gender) -> str:
    """
    –ò–∑–º–µ–Ω—è–µ—Ç –æ–∫–æ–Ω—á–∞–Ω–∏–µ –ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø–æ–¥ —Ü–µ–ª–µ–≤–æ–π —Ä–æ–¥
    
    Args:
        adjective: –ò—Å—Ö–æ–¥–Ω–æ–µ –ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω–æ–µ
        target_gender: –¶–µ–ª–µ–≤–æ–π —Ä–æ–¥ ('m', 'f', 'n')
        
    Returns:
        –ü—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω–æ–µ —Å –Ω–æ–≤—ã–º –æ–∫–æ–Ω—á–∞–Ω–∏–µ–º
    """
    if not adjective or target_gender == 'unknown':
        return adjective
    
    adj_lower = adjective.lower()
    current_gender = detect_adjective_gender(adj_lower)
    
    if current_gender == target_gender or current_gender == 'unknown':
        return adjective
    
    # –ò—â–µ–º –ø–æ–¥—Ö–æ–¥—è—â—É—é –∑–∞–º–µ–Ω—É –æ–∫–æ–Ω—á–∞–Ω–∏—è (–æ—Ç –¥–ª–∏–Ω–Ω–æ–≥–æ –∫ –∫–æ—Ä–æ—Ç–∫–æ–º—É)
    sorted_endings = sorted(
        ADJECTIVE_ENDINGS.items(),
        key=lambda x: len(x[0][0]),
        reverse=True
    )
    
    for (current_ending, target_g), new_ending in sorted_endings:
        if target_g == target_gender and adj_lower.endswith(current_ending):
            base = adjective[:-len(current_ending)]
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–≥–∏—Å—Ç—Ä –ø–µ—Ä–≤–æ–π –±—É–∫–≤—ã
            if adjective[0].isupper():
                return base + new_ending.capitalize() if new_ending[0].islower() else base + new_ending
            else:
                return base + new_ending
    
    return adjective


def detect_adjectives_in_text(text: str) -> List[Dict[str, any]]:
    """
    –ù–∞—Ö–æ–¥–∏—Ç –≤—Å–µ –ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω—ã–µ –≤ —Ç–µ–∫—Å—Ç–µ (–∏—Å–∫–ª—é—á–∞—è –±—Ä–µ–Ω–¥—ã)
    
    Args:
        text: –¢–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
        
    Returns:
        –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω—ã—Ö
    """
    if not text:
        return []
    
    # –ü–æ–ª—É—á–∞–µ–º —Å–ª–æ–≤–∞ –±—Ä–µ–Ω–¥–æ–≤ –≤ —ç—Ç–æ–º —Ç–µ–∫—Å—Ç–µ
    brand_words = get_brand_words_in_text(text)
    
    words = text.split()
    adjectives = []
    
    for i, word in enumerate(words):
        word_lower = word.lower().strip()
        
        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–ª–æ–≤–∞ –±—Ä–µ–Ω–¥–æ–≤
        if word_lower in brand_words:
            continue
        
        gender = detect_adjective_gender(word)
        if gender != 'unknown':
            adjectives.append({
                'word': word,
                'position': i,
                'gender': gender
            })
    
    return adjectives


def apply_gender_agreement(
    product_name: str,
    common_suffix: str,
    source_gender: Optional[Gender] = None
) -> str:
    """
    –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ —Ä–æ–¥—É
    
    Args:
        product_name: –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ª–æ—Å–æ—Å—å")
        common_suffix: –û–±—â–∞—è —á–∞—Å—Ç—å —Å –ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω—ã–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "—Å–ª–∞–±–æ—Å–æ–ª–µ–Ω–∞—è —Ä—É—Å—Å–∫–æ–µ –º–æ—Ä–µ")
        source_gender: –ò—Å—Ö–æ–¥–Ω—ã–π —Ä–æ–¥ –ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω—ã—Ö (–µ—Å–ª–∏ –∏–∑–≤–µ—Å—Ç–µ–Ω)
        
    Returns:
        –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞: "—Å–ª–∞–±–æ—Å–æ–ª–µ–Ω—ã–π —Ä—É—Å—Å–∫–æ–µ –º–æ—Ä–µ"
    """
    if not common_suffix or not common_suffix.strip():
        return common_suffix
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–æ–¥ —Ü–µ–ª–µ–≤–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞
    target_gender = get_product_gender(product_name)
    
    if target_gender == 'unknown':
        return common_suffix
    
    # –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω—ã–µ –≤ —Å—É—Ñ—Ñ–∏–∫—Å–µ (–∏—Å–∫–ª—é—á–∞—è –±—Ä–µ–Ω–¥—ã)
    adjectives = detect_adjectives_in_text(common_suffix)
    
    if not adjectives:
        return common_suffix
    
    # –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –∫ –∫–∞–∂–¥–æ–º—É –ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω–æ–º—É
    words = common_suffix.split()
    result_words = words.copy()
    
    for adj_info in adjectives:
        pos = adj_info['position']
        old_word = adj_info['word']
        new_word = change_adjective_gender(old_word, target_gender)
        
        if new_word != old_word:
            result_words[pos] = new_word
    
    return ' '.join(result_words)


# ============================================================================
# –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï
# ============================================================================

def test_gender_agreement():
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥—É–ª—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è –ø–æ —Ä–æ–¥—É"""
    print("üß™ Testing Gender Agreement Module")
    print("=" * 80)
    
    # –¢–µ—Å—Ç 1: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–æ–¥–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
    print("\n1Ô∏è‚É£ Testing product gender detection:")
    test_products = [
        ('—Ñ–æ—Ä–µ–ª—å', 'f'),
        ('–ª–æ—Å–æ—Å—å', 'm'),
        ('—Å–µ–º–≥–∞', 'f'),
        ('–º–æ–ª–æ–∫–æ', 'n'),
        ('–∫–µ—Ñ–∏—Ä', 'm'),
        ('—Ç–≤–æ—Ä–æ–≥', 'm'),
        ('—Å–º–µ—Ç–∞–Ω–∞', 'f'),
        ('—è–π—Ü–æ', 'n'),
    ]
    
    for product, expected in test_products:
        result = get_product_gender(product)
        status = "‚úÖ" if result == expected else "‚ùå"
        print(f"  {status} {product}: {result} (expected {expected})")
    
    # –¢–µ—Å—Ç 2: –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–æ–¥–∞ –ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω—ã—Ö
    print("\n2Ô∏è‚É£ Testing adjective gender change:")
    test_adjectives = [
        ('—Å–ª–∞–±–æ—Å–æ–ª–µ–Ω–∞—è', 'm', '—Å–ª–∞–±–æ—Å–æ–ª–µ–Ω—ã–π'),
        ('—Å–ª–∞–±–æ—Å–æ–ª–µ–Ω–∞—è', 'n', '—Å–ª–∞–±–æ—Å–æ–ª–µ–Ω–æ–µ'),
        ('—Å–≤–µ–∂–∏–π', 'f', '—Å–≤–µ–∂–∞—è'),
        ('—Å–≤–µ–∂–∏–π', 'n', '—Å–≤–µ–∂–µ–µ'),
        ('—Ü–µ–ª—å–Ω–æ–µ', 'm', '—Ü–µ–ª—å–Ω—ã–π'),
        ('—Ü–µ–ª—å–Ω–æ–µ', 'f', '—Ü–µ–ª—å–Ω–∞—è'),
    ]
    
    for adj, target, expected in test_adjectives:
        result = change_adjective_gender(adj, target)
        status = "‚úÖ" if result == expected else "‚ùå"
        print(f"  {status} {adj} ‚Üí {target}: {result} (expected {expected})")
    
    # –¢–µ—Å—Ç 3: –ü–æ–ª–Ω–æ–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ
    print("\n3Ô∏è‚É£ Testing full gender agreement:")
    test_cases = [
        ('–ª–æ—Å–æ—Å—å', '—Å–ª–∞–±–æ—Å–æ–ª–µ–Ω–∞—è —Ä—É—Å—Å–∫–æ–µ –º–æ—Ä–µ', '—Å–ª–∞–±–æ—Å–æ–ª–µ–Ω—ã–π —Ä—É—Å—Å–∫–æ–µ –º–æ—Ä–µ'),
        ('—Å–µ–º–≥–∞', '—Å–ª–∞–±–æ—Å–æ–ª–µ–Ω–∞—è —Ä—É—Å—Å–∫–æ–µ –º–æ—Ä–µ', '—Å–ª–∞–±–æ—Å–æ–ª–µ–Ω–∞—è —Ä—É—Å—Å–∫–æ–µ –º–æ—Ä–µ'),
        ('–∫–µ—Ñ–∏—Ä', '—Ü–µ–ª—å–Ω–æ–µ 3.2%', '—Ü–µ–ª—å–Ω—ã–π 3.2%'),
        ('–º–æ–ª–æ–∫–æ', '—Å–≤–µ–∂–∏–π –æ—Ö–ª–∞–∂–¥–µ–Ω–Ω—ã–π', '—Å–≤–µ–∂–µ–µ –æ—Ö–ª–∞–∂–¥–µ–Ω–Ω–æ–µ'),
    ]
    
    for product, suffix, expected in test_cases:
        result = apply_gender_agreement(product, suffix)
        status = "‚úÖ" if result == expected else "‚ùå"
        print(f"  {status} {product} + '{suffix}'")
        print(f"      Result:   '{result}'")
        print(f"      Expected: '{expected}'")
        print()
    
    print("=" * 80)
    print("Testing completed!")


if __name__ == "__main__":
    test_gender_agreement()
