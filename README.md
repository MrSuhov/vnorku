# Korzinka - –°–µ—Ä–≤–∏—Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø–æ–∫—É–ø–æ–∫ —á–µ—Ä–µ–∑ –õ–°–î

–°–µ—Ä–≤–∏—Å –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –ø–æ–∏—Å–∫–∞ –ª—É—á—à–∏—Ö —Ü–µ–Ω –∏ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –≤ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Å–ª—É–∂–±–∞—Ö –¥–æ—Å—Ç–∞–≤–∫–∏ (–õ–°–î) –∏ –æ—Ñ–æ—Ä–º–ª—è–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –∑–∞–∫–∞–∑—ã.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã:
- **telegram-bot** (8001): Telegram –±–æ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
- **api-gateway** (8002): API Gateway –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
- **order-service** (8003): –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏ –∞–Ω–∞–ª–∏–∑ –∑–∞–∫–∞–∑–æ–≤
- **rpa-service** (8004): RPA –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ –õ–°–î
- **notification-service** (8005): –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ SMS

### Shared –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
- **database**: –ú–æ–¥–µ–ª–∏ –ë–î –∏ –º–∏–≥—Ä–∞—Ü–∏–∏
- **models**: –û–±—â–∏–µ –º–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö
- **rpa**: RPA –¥–≤–∏–∂–æ–∫ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ QR/SMS
- **utils**: –£—Ç–∏–ª–∏—Ç—ã –∏ —Ö–µ–ª–ø–µ—Ä—ã

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Python 3.11+
- PostgreSQL 14+
- Redis 7+
- Chrome/Chromium –±—Ä–∞—É–∑–µ—Ä –¥–ª—è RPA

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:
```bash
# –°–æ–∑–¥–∞—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
python3 -m venv venv
source venv/bin/activate

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
pip install -r requirements.txt
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
```bash
# –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å .env —Ñ–∞–π–ª
cp .env.example .env
# –ó–∞–ø–æ–ª–Ω–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –≤ .env —Ñ–∞–π–ª–µ
```

### 3. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å PostgreSQL –∏ Redis
docker-compose up -d postgres redis

# –í—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
alembic upgrade head
```

### 4. –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤:

#### üöÄ **–ù–æ–≤—ã–π —Å–ø–æ—Å–æ–± (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π):**
```bash
# –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ —Å —É–º–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–æ–π –∑–∞–≤–∏—Å—à–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
./start_services.sh

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤  
./stop_services.sh
```

#### –°—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–± (—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞):
```bash
# –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –∫–∞–∂–¥–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
python services/telegram-bot/main.py     # Terminal 1
python services/api-gateway/main.py      # Terminal 2  
python services/order-service/main.py    # Terminal 3
python services/rpa-service/main.py      # Terminal 4
python services/notification-service/main.py # Terminal 5
```

## üöÄ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞–º–∏

### –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤:
```bash
./start_services.sh
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç:**
- ‚úÖ **–£–º–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞**: –º—è–≥–∫–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–∞–≤–∏—Å—à–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã (SIGTERM), –∑–∞—Ç–µ–º –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ (SIGKILL)
- ‚úÖ **–ü—Ä–æ–≤–µ—Ä–∫–∏**: –ø—Ä–æ–≤–µ—Ä—è–µ—Ç venv, .env —Ñ–∞–π–ª, —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤
- ‚úÖ **–ó–∞–ø—É—Å–∫**: –∑–∞–ø—É—Å–∫–∞–µ—Ç –≤—Å–µ 5 —Å–µ—Ä–≤–∏—Å–æ–≤ –≤ —Ñ–æ–Ω–µ
- ‚úÖ **Health checks**: –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –∑–∞–ø—É—Å–∫–∞ –∫–∞–∂–¥–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
- ‚úÖ **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ª–æ–≥–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ –≤ `logs/`

### –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤:
```bash
./stop_services.sh
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:
```bash
# –í—Å–µ –ª–æ–≥–∏
tail -f logs/*.log

# –û—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å  
tail -f logs/rpa-service.log

# –ü–æ–∏—Å–∫ –æ—à–∏–±–æ–∫
grep -i error logs/*.log
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ RPA

### Yandex QR –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è:
1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã: `./start_services.sh`
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ `/start` –≤ Telegram –±–æ—Ç–∞
3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é: `/auth yandex_lavka`
4. –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ RPA –ª–æ–≥–∏:

```bash
# –û—Å–Ω–æ–≤–Ω—ã–µ –ª–æ–≥–∏ RPA
tail -f logs/rpa-service.log

# –ü–æ–∏—Å–∫ –∫–ª—é—á–µ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π
grep -i verify_success logs/rpa-service.log
```

### –ö–ª—é—á–µ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è –≤ –ª–æ–≥–∞—Ö RPA:
- ‚úÖ `Executing step verify_success` - —à–∞–≥ –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å–ø–µ—Ö–∞
- ‚úÖ `SUCCESS step verify_success completed!` - —É—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
- ‚úÖ `Force-executing critical step after success: save_cookies` - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫—É–∫–∏
- ‚úÖ `Force-executing critical step after success: cleanup_session` - –æ—á–∏—Å—Ç–∫–∞
- ‚úÖ `Browser FORCE-CLOSED` - –∑–∞–∫—Ä—ã—Ç–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
korzinka/
‚îú‚îÄ‚îÄ services/               # –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã
‚îÇ   ‚îú‚îÄ‚îÄ telegram-bot/       # Telegram –±–æ—Ç (8001)
‚îÇ   ‚îú‚îÄ‚îÄ api-gateway/        # API Gateway (8002)  
‚îÇ   ‚îú‚îÄ‚îÄ order-service/      # –ó–∞–∫–∞–∑—ã –∏ –∞–Ω–∞–ª–∏–∑ (8003)
‚îÇ   ‚îú‚îÄ‚îÄ rpa-service/        # RPA –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è (8004)
‚îÇ   ‚îî‚îÄ‚îÄ notification-service/ # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (8005)
‚îú‚îÄ‚îÄ shared/                 # –û–±—â–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ database/           # –ë–î –º–æ–¥–µ–ª–∏ –∏ –º–∏–≥—Ä–∞—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ models/             # –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îú‚îÄ‚îÄ rpa/               # RPA –¥–≤–∏–∂–æ–∫
‚îÇ   ‚îî‚îÄ‚îÄ utils/             # –£—Ç–∏–ª–∏—Ç—ã
‚îú‚îÄ‚îÄ migrations/             # –ú–∏–≥—Ä–∞—Ü–∏–∏ Alembic
‚îú‚îÄ‚îÄ config/                 # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ logs/                   # –õ–æ–≥–∏ —Å–µ—Ä–≤–∏—Å–æ–≤
‚îú‚îÄ‚îÄ start_services.sh       # üöÄ –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
‚îú‚îÄ‚îÄ stop_services.sh        # üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
‚îî‚îÄ‚îÄ .service_pids          # PID —Ñ–∞–π–ª (–∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º—ã–π)
```

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è RPA

### Supported –õ–°–î:
- **Yandex Lavka**: QR-–∫–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
- **VkusVill**: SMS-–∫–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è  
- **Samokat**: –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è
- **Perekrestok**: –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è

### RPA Features:
- ‚úÖ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π RPA –¥–≤–∏–∂–æ–∫ —Å Playwright
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ XPath –∏ CSS —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤
- ‚úÖ QR-–∫–æ–¥ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram
- ‚úÖ SMS-–∫–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫—É–∫–∏
- ‚úÖ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ success-—à–∞–≥–æ–≤ —Å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º–∏ –¥–µ–π—Å—Ç–≤–∏—è–º–∏

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –ú–æ–¥–µ–ª–∏:
- **users**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏ –∏—Ö —Å—Ç–∞—Ç—É—Å—ã
- **lsd_configs**: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –õ–°–î –¥–ª—è RPA
- **user_sessions**: –°–µ—Å—Å–∏–∏ –∏ –∫—É–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- **orders**: –ó–∞–∫–∞–∑—ã –∏ –∏—Ö –∞–Ω–∞–ª–∏–∑
- **product_prices**: –¶–µ–Ω—ã —Ç–æ–≤–∞—Ä–æ–≤
- **promotions**: –ü—Ä–æ–º–æ–∫–æ–¥—ã –∏ —Å–∫–∏–¥–∫–∏

### –ú–∏–≥—Ä–∞—Ü–∏–∏:
```bash
# –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é
alembic revision --autogenerate -m "Description"

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
alembic upgrade head

# –ò—Å—Ç–æ—Ä–∏—è –º–∏–≥—Ä–∞—Ü–∏–π
alembic history
```

## API Endpoints

### Bot Service (8001):
- `POST /webhook` - Telegram webhook
- `GET /health` - Health check

### RPA Service (8004):
- `POST /auth/start` - –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- `GET /auth/status/{session_id}` - –°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- `POST /auth/continue` - –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º –≤–≤–æ–¥–æ–º
- `GET /health` - Health check

### Order Service (8003):
- `POST /orders` - –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
- `GET /orders/{order_id}` - –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞
- `POST /orders/{order_id}/analyze` - –ê–Ω–∞–ª–∏–∑ —Ü–µ–Ω
- `GET /health` - Health check

## –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –õ–°–î:
1. –°–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤ `lsd_configs` —Ç–∞–±–ª–∏—Ü–µ
2. –î–æ–±–∞–≤–∏—Ç—å RPA –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å —à–∞–≥–∞–º–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
3. –£–∫–∞–∑–∞—Ç—å —Å–µ–ª–µ–∫—Ç–æ—Ä—ã –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
4. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å success-—à–∞–≥ —Å —Ñ–ª–∞–≥–æ–º `"success": true`

### –û—Ç–ª–∞–¥–∫–∞ RPA:
```bash
# –í–∫–ª—é—á–∏—Ç—å debug —Ä–µ–∂–∏–º –≤ RPA –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
"debug": true

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤ –Ω–µ-headless —Ä–µ–∂–∏–º–µ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è
"headless": false
```

## Troubleshooting

### RPA –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
tail -f logs/rpa-service.log

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±—Ä–∞—É–∑–µ—Ä
which chrome
which chromium

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å RPA —Å–µ—Ä–≤–∏—Å
./stop_services.sh && ./start_services.sh
```

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
docker-compose ps

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ë–î
docker-compose restart postgres
```

### –ü–æ—Ä—Ç—ã –∑–∞–Ω—è—Ç—ã:
```bash
# –£–±–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ø–æ—Ä—Ç–∞—Ö 8001-8005
./stop_services.sh

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤–æ–±–æ–¥–Ω—ã–µ –ø–æ—Ä—Ç—ã
lsof -i :8001-8005
```

## –ö–æ–Ω—Ç—Ä–∏–±—å—é—Ü–∏—è

1. Fork —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
2. –°–æ–∑–¥–∞—Ç—å feature branch
3. –ö–æ–º–º–∏—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å —Ö–æ—Ä–æ—à–∏–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
4. –°–æ–∑–¥–∞—Ç—å Pull Request

---

**–°—Ç–∞—Ç—É—Å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:** üöÄ –ê–∫—Ç–∏–≤–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞  
**RPA —Å—Ç–∞—Ç—É—Å:** ‚úÖ Yandex QR –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç  
**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** üß™ –î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ñ–ª–æ—É —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
