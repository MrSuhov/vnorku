# Исправление парсинга единиц измерения "за N единица"

## Дата: 2025-10-04

## Проблема

При поиске товаров в Глобусе (и потенциально других ЛСД) товары с ценой "**за 100 г**" парсились некорректно:

**До исправления:**
- Текст: "за 100 г"
- `found_quantity`: **1** (неправильно!)
- `found_unit`: "г"
- `base_quantity`: 0.001 (1г в кг)
- `fprice`: 63 / 0.001 = **63000 ₽/кг** ❌

**Ожидаемое поведение:**
- Текст: "за 100 г"
- `found_quantity`: **100**
- `found_unit`: "г"
- `base_quantity`: 0.1 (100г в кг)
- `fprice`: 63 / 0.1 = **630 ₽/кг** ✅

---

## Решение

### Универсальный алгоритм извлечения "за N единица"

Добавлен паттерн для распознавания текста вида:
- "за 100 г"
- "за 1 кг"
- "за 500 мл"
- "за 1 шт"

**Regex паттерн:**
```python
r'за\s+([\d.,]+)\s*([а-яА-Яa-zA-Z]+)'
```

**Логика обработки:**

1. **Если текст содержит "за":**
   - Пытаемся извлечь `quantity` и `unit` через regex
   - Успех → используем извлеченные значения
   - Неудача → fallback: `quantity=1.0`, `unit=извлеченная_единица`

2. **Если текст НЕ содержит "за":**
   - Используем существующую логику для "300 г", "1 л" и т.д.

---

## Изменённые файлы

### `services/rpa-service/selenium_product_search.py`

**Функция:** `extract_item_data_selenium_enhanced()`

**Секции:**
- ПРИОРИТЕТ 2: обработка `unit_selector` (строки ~290-340)
- ПРИОРИТЕТ 3: обработка `data_selectors` (строки ~340-385)

---

## Тестовые кейсы

| Входной текст | Ожидаемый результат |
|---------------|---------------------|
| "за 100 г" | `quantity=100`, `unit="г"`, `fprice=630` |
| "за 1 кг" | `quantity=1`, `unit="кг"`, `fprice=63` |
| "за 500 мл" | `quantity=500`, `unit="мл"`, `fprice=126` |
| "300 г" | `quantity=300`, `unit="г"` (как раньше) |
| "1 шт" | `quantity=1`, `unit="шт"` (как раньше) |
| "за штуку" | `quantity=1`, `unit="шт"` (fallback) |

---

## Обратная совместимость

✅ **Полная обратная совместимость** со всеми ЛСД:
- Паттерн "за N unit" - новая логика
- Паттерны "300 г", "1 кг" - старая логика (не затронута)
- Нет хардкода для конкретных ЛСД
- Универсальное решение для всех магазинов

---

## Тестирование

**Товар для проверки:**
- Название: "Конфеты шоколадные Мишки в лесу"
- ЛСД: Глобус
- URL: https://online.globus.ru/search?q=Конфеты%20шоколадные%20Мишки%20в%20лесу
- Ожидаемый результат: `found_quantity=100`, `fprice=630 ₽/кг`

**Команда для тестирования:**
```bash
# Запустить поиск через RPA-сервис
# Проверить логи: /Users/ss/GenAI/korzinka/logs/rpa-service.log
# Проверить БД: SELECT found_quantity, fprice FROM lsd_stocks WHERE found_name LIKE '%Мишки%'
```

---

## Логирование

Добавлено подробное логирование для отладки:

```
✅ Extracted unit text from selector: 'за 100 г'
✅ Parsed 'за N unit' pattern: quantity=100.0, unit='г'
```

```
⚠️ Could not parse 'за N unit' pattern, using quantity=1.0 with unit='г'
```

---

## Автор

Исправление выполнено: 2025-10-04  
Протестировано на: Глобус (order_item_id=108)
