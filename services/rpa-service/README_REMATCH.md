# Match Score Update v5.2 + Rematch Utility

## üì¶ –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –û–±–Ω–æ–≤–ª–µ–Ω –∞–ª–≥–æ—Ä–∏—Ç–º —Ä–∞—Å—á–µ—Ç–∞ match_score (v5.2)
- **–§–∞–π–ª:** `/Users/ss/GenAI/korzinka/services/rpa-service/main.py`
- **–§—É–Ω–∫—Ü–∏—è:** `calculate_advanced_match_score()`
- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** `MATCH_SCORE_v52_UPDATE.md`

**–ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:**
- ‚úÖ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —à—Ç—Ä–∞—Ñ –∑–∞ –Ω–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–µ—Ä–≤–æ–≥–æ —Å–ª–æ–≤–∞ (-0.25 –¥–æ -0.45)
- ‚úÖ –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –±–æ–Ω—É—Å—ã —Å —É—á–µ—Ç–æ–º –ø–æ–ª–Ω–æ–≥–æ –ø–æ–∫—Ä—ã—Ç–∏—è —Å–ª–æ–≤
- ‚úÖ –°–º—è–≥—á–µ–Ω–∏–µ —à—Ç—Ä–∞—Ñ–æ–≤ –∫–æ–≥–¥–∞ –í–°–ï —Å–ª–æ–≤–∞ –Ω–∞–π–¥–µ–Ω—ã (100% –ø–æ–∫—Ä—ã—Ç–∏–µ)

### 2. –°–æ–∑–¥–∞–Ω–∞ —É—Ç–∏–ª–∏—Ç–∞ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ (Rematch Utility)
- **–°–∫—Ä–∏–ø—Ç:** `rematch.sh` (wrapper —Å –∞–∫—Ç–∏–≤–∞—Ü–∏–µ–π venv)
- **Python –º–æ–¥—É–ª—å:** `rematch_stocks.py`
- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** `REMATCH_UTILITY.md`

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
```bash
cd /Users/ss/GenAI/korzinka/services/rpa-service
./rematch.sh --stats
```

### –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏ (DRY RUN)
```bash
./rematch.sh --dry-run
```

### –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏ (–†–ï–ê–õ–¨–ù–û–ï –°–û–•–†–ê–ù–ï–ù–ò–ï)
```bash
./rematch.sh
```

### –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∑–∞–∫–∞–∑
```bash
./rematch.sh --order-id 123
```

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –¢–µ—Å—Ç–æ–≤—ã–µ –∫–µ–π—Å—ã (–¥–æ production)

| –ó–∞–ø—Ä–æ—Å | –ù–∞–π–¥–µ–Ω–Ω–æ–µ | –ë—ã–ª–æ v3.0 | –°—Ç–∞–ª–æ v5.2 | ‚úì |
|--------|-----------|-----------|------------|---|
| –ª–æ—Å–æ—Å—å —Å–ª–∞–±–æ—Å–æ–ª–µ–Ω–∞—è —Ä—É—Å—Å–∫–æ–µ –º–æ—Ä–µ | –°–µ–ª—å–¥—å –≤ –º–∞—Å–ª–µ –ê-–ª—è –ª–æ—Å–æ—Å—å... | 0.825 | **0.575** | ‚úÖ |
| —á–µ—Ä—Ä–∏ | –¢–æ–º–∞—Ç—ã —á–µ—Ä—Ä–∏ | 1.000 | **1.000** | ‚úÖ |
| —á–µ—Ä—Ä–∏ | –°–µ–º–µ–Ω–∞ —Ç–æ–º–∞—Ç...–ß–µ—Ä—Ä–∏ | 0.000 | **0.450** | ‚úÖ |
| —á–µ—Ä–∫–∏–∑–æ–≤–æ —Å–∞–ª—å—á–∏—á–æ–Ω | –ö–æ–ª–±–∞—Å–∞ —Å—ã—Ä–æ–∫–æ–ø—á–µ–Ω–∞—è –°–∞–ª—å—á–∏—á–æ–Ω –ß–µ—Ä–∫–∏–∑–æ–≤–æ | 0.900 | **0.850** | ‚úÖ |
| –º–æ–ª–æ–∫–æ | –ú–æ–ª–æ–∫–æ –ø–∞—Å—Ç–µ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–µ 3.2% | 1.000 | **1.000** | ‚úÖ |

### –†–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (dry-run –Ω–∞ 900 –∑–∞–ø–∏—Å—è—Ö)

**–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**
- –í—Å–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: **900 –∑–∞–ø–∏—Å–µ–π**
- –ë—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–æ: **341 –∑–∞–ø–∏—Å–µ–π** (37.9%)
- –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π: **559 –∑–∞–ø–∏—Å–µ–π** (62.1%)
- –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π (|Œî| > 0.1): **230 –∑–∞–ø–∏—Å–µ–π**

**–¢–æ–ø –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π (–Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è ‚Üí 0.000):**
- "—Ö–ª–µ–± –±–µ–∑–¥—Ä–æ–∂–∂–µ–≤–æ–π" vs "–ú–∏–Ω–∏-–õ–∞–≤–∞—à–∏" ‚Üí 0.650 ‚Üí **0.000** ‚úÖ
- "—á–µ—Ä–∫–∏–∑–æ–≤–æ —Å–∞–ª—å—á–∏—á–æ–Ω" vs "–ö–æ–ª–±–∞—Å–∞ –°–∞–ª—è–º–∏ –ß–µ—Ä–∫–∏–∑–æ–≤–æ" ‚Üí 0.650 ‚Üí **0.000** ‚úÖ
- "—è–±–ª–æ–∫–∏ –≥–æ–ª–¥–µ–Ω" vs "–°–æ–∫ —è–±–ª–æ—á–Ω—ã–π" ‚Üí 0.650 ‚Üí **0.000** ‚úÖ

## üìã –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é

### –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π workflow

```bash
# 1. –ë—ç–∫–∞–ø –ë–î (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
pg_dump korzinka > backup_before_rematch.sql

# 2. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ "–¥–æ"
./rematch.sh --stats > stats_before.txt

# 3. Dry-run –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
./rematch.sh --dry-run > rematch_preview.log

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å TOP-10 –∏–∑–º–µ–Ω–µ–Ω–∏–π
tail -50 rematch_preview.log

# 5. –ï—Å–ª–∏ –≤—Å–µ –û–ö - –ø—Ä–∏–º–µ–Ω–∏—Ç—å
./rematch.sh

# 6. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ "–ø–æ—Å–ª–µ"
./rematch.sh --stats > stats_after.txt

# 7. –°—Ä–∞–≤–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
diff stats_before.txt stats_after.txt
```

### –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤

```bash
# –ü–æ–¥—Ä–æ–±–Ω—ã–π –≤—ã–≤–æ–¥ –¥–ª—è –æ–¥–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞
./rematch.sh --order-id 123 --dry-run --verbose
```

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ê–ª–≥–æ—Ä–∏—Ç–º v5.2

**–§–æ—Ä–º—É–ª–∞:**
```
final_score = base_score + bonus - penalty
–≥–¥–µ:
  base_score = (–Ω–∞–π–¥–µ–Ω–Ω—ã–µ_—Å–ª–æ–≤–∞ / –≤—Å–µ–≥–æ_—Å–ª–æ–≤)
  penalty = —à—Ç—Ä–∞—Ñ_–∑–∞_–¥–ª–∏–Ω—É + —à—Ç—Ä–∞—Ñ_–∑–∞_–ø–µ—Ä–≤–æ–µ_—Å–ª–æ–≤–æ
  bonus = –±–æ–Ω—É—Å_–∑–∞_–ø–æ–∫—Ä—ã—Ç–∏–µ + –±–æ–Ω—É—Å_–∑–∞_—Ç–æ—á–Ω–æ—Å—Ç—å
```

**–ö–ª—é—á–µ–≤—ã–µ —à—Ç—Ä–∞—Ñ—ã:**
- –î–ª–∏–Ω–∞ > 2x: –¥–æ -0.3
- –ü–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ –Ω–µ –≤ —Ç–æ–ø-3:
  - 100% –ø–æ–∫—Ä—ã—Ç–∏–µ: -0.25 (–º—è–≥–∫–∏–π)
  - –ù–µ–ø–æ–ª–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ: -0.45 (–∂–µ—Å—Ç–∫–∏–π)

**–ë–æ–Ω—É—Å—ã (–ø—Ä–∏ penalty < 0.5):**
- –ü–æ–ª–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ: +0.15
- –¢–æ—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è: +0.1
- –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–µ—Ä–≤–æ–≥–æ —Å–ª–æ–≤–∞: +0.1 –¥–æ +0.2

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- **–°–∫–æ—Ä–æ—Å—Ç—å:** ~1000 –∑–∞–ø–∏—Å–µ–π/—Å–µ–∫
- **–ü–∞–º—è—Ç—å:** < 100 MB
- **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:** –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- `MATCH_SCORE_v52_UPDATE.md` - –¥–µ—Ç–∞–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–ª–≥–æ—Ä–∏—Ç–º–∞
- `REMATCH_UTILITY.md` - –ø–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ —É—Ç–∏–ª–∏—Ç–µ
- `test_match_v52_final.py` - —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã –∞–ª–≥–æ—Ä–∏—Ç–º–∞

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –ê–ª–≥–æ—Ä–∏—Ç–º –æ–±–Ω–æ–≤–ª–µ–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
2. ‚úÖ –£—Ç–∏–ª–∏—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
3. ‚è≠Ô∏è **–ü—Ä–∏–º–µ–Ω–∏—Ç—å rematch –∫ production –¥–∞–Ω–Ω—ã–º**
4. ‚è≠Ô∏è –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–∞—á–µ—Å—Ç–≤–∞ –ø–æ–∏—Å–∫–∞ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

## üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã

- –í–æ–ø—Ä–æ—Å—ã –ø–æ –∞–ª–≥–æ—Ä–∏—Ç–º—É ‚Üí `main.py:calculate_advanced_match_score()`
- –í–æ–ø—Ä–æ—Å—ã –ø–æ —É—Ç–∏–ª–∏—Ç–µ ‚Üí `REMATCH_UTILITY.md`
- –¢–µ—Å—Ç—ã ‚Üí `test_match_v52_final.py`
