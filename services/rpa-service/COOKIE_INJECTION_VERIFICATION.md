# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ó–∞–≥—Ä—É–∑–∫–∏ –°—Ç—Ä–∞–Ω–∏—Ü—ã –ü–æ—Å–ª–µ –ò–Ω—ä–µ–∫—Ü–∏–∏ –ö—É–∫

## –û–±–∑–æ—Ä

–î–æ–±–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ—Å–ª–µ –∏–Ω—ä–µ–∫—Ü–∏–∏ –∫—É–∫ –≤ –æ–±–∞ —Ç–∏–ø–∞ –±—Ä–∞—É–∑–µ—Ä–æ–≤:
- **CDP –±—Ä–∞—É–∑–µ—Ä** (`cdp_cookie_manager.py`)
- **Simple undetected –±—Ä–∞—É–∑–µ—Ä** (`simple_browser_manager.py`)

## –ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ?

–ü–æ—Å–ª–µ –∏–Ω—ä–µ–∫—Ü–∏–∏ –∫—É–∫ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –º–æ–∂–µ—Ç –Ω–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è –ø–æ —Ä–∞–∑–Ω—ã–º –ø—Ä–∏—á–∏–Ω–∞–º:
- –ê–Ω—Ç–∏–±–æ—Ç –∑–∞—â–∏—Ç–∞
- –°–µ—Ç–µ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
- –ü—Ä–æ–±–ª–µ–º—ã —Å –∫—É–∫–∞–º–∏
- –¢–∞–π–º–∞—É—Ç—ã

–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç:
1. –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –æ—Ç–∫—Ä—ã–ª–∞—Å—å
2. –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É –ø—Ä–∏ –Ω–µ—É–¥–∞—á–µ (–¥–æ 3 —Ä–∞–∑)
3. –ù–∞—á–∏–Ω–∞—Ç—å –ø–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?

### –õ–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏

–ü–æ—Å–ª–µ –∏–Ω—ä–µ–∫—Ü–∏–∏ –∫—É–∫ –∏ –ø–µ—Ä–µ—Ö–æ–¥–∞/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã:

```
–ü–æ–ø—ã—Ç–∫–∞ 1:
‚îú‚îÄ‚îÄ –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É (–∏–ª–∏ refresh)
‚îú‚îÄ‚îÄ –ü–∞—É–∑–∞ 1 —Å–µ–∫—É–Ω–¥–∞
‚îú‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏
‚îÇ   ‚îú‚îÄ‚îÄ URL —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–∂–∏–¥–∞–µ–º—ã–π –¥–æ–º–µ–Ω?
‚îÇ   ‚îî‚îÄ‚îÄ –≠–ª–µ–º–µ–Ω—Ç <body> –Ω–∞–π–¥–µ–Ω?
‚îî‚îÄ‚îÄ –£—Å–ø–µ—Ö? ‚Üí –í—ã—Ö–æ–¥
    –ù–µ—É–¥–∞—á–∞? ‚Üí –ü–∞—É–∑–∞ 3 —Å–µ–∫—É–Ω–¥—ã, –ø–æ–≤—Ç–æ—Ä–∏—Ç—å

–ü–æ–ø—ã—Ç–∫–∞ 2:
‚îî‚îÄ‚îÄ –¢–æ –∂–µ —Å–∞–º–æ–µ...

–ü–æ–ø—ã—Ç–∫–∞ 3:
‚îî‚îÄ‚îÄ –¢–æ –∂–µ —Å–∞–º–æ–µ...

–ü–æ—Å–ª–µ 3 –Ω–µ—É–¥–∞—á ‚Üí –û—à–∏–±–∫–∞
```

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏

–°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–π –µ—Å–ª–∏:
1. **URL –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π**: `driver.current_url` —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–∂–∏–¥–∞–µ–º—ã–π –¥–æ–º–µ–Ω
2. **Body –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç**: –Ω–∞–π–¥–µ–Ω —ç–ª–µ–º–µ–Ω—Ç `<body>` –≤ DOM

## –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

### 1. `cdp_cookie_manager.py`

#### –ù–æ–≤—ã–π –º–µ—Ç–æ–¥ `_verify_page_loaded()`

```python
def _verify_page_loaded(self, expected_url: str) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞
    
    Returns:
        True –µ—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞
    """
    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ URL
    current = self.driver.current_url
    expected_domain = urlparse(expected_url).netloc or expected_url
    
    if expected_domain not in current:
        return False
    
    # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ body
    body = self.driver.find_element(By.TAG_NAME, 'body')
    if not body:
        return False
    
    return True
```

#### –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–µ—Ç–æ–¥ `navigate_to_site()`

–¢–µ–ø–µ—Ä—å –≤–∫–ª—é—á–∞–µ—Ç —Ü–∏–∫–ª –ø—Ä–æ–≤–µ—Ä–∫–∏:

```python
def navigate_to_site(self, url: str, wait_time: int = 1) -> bool:
    # –¶–∏–∫–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ (–º–∞–∫—Å–∏–º—É–º 3 –ø–æ–ø—ã—Ç–∫–∏)
    max_attempts = 3
    for attempt in range(1, max_attempts + 1):
        # –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
        self.driver.get(url)
        time.sleep(min(wait_time, 1))
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏
        if self._verify_page_loaded(url):
            return True
        else:
            if attempt < max_attempts:
                time.sleep(3)  # –ü–∞—É–∑–∞ –ø–µ—Ä–µ–¥ retry
            else:
                return False
    
    return False
```

### 2. `simple_browser_manager.py`

#### –ù–æ–≤—ã–π —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –º–µ—Ç–æ–¥ `_check_page_loaded()`

```python
@staticmethod
def _check_page_loaded(driver: uc.Chrome, expected_domain: str) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞
    """
    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ URL
    current = driver.current_url
    if expected_domain not in current:
        return False
    
    # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ body
    body = driver.find_element(By.TAG_NAME, 'body')
    if not body:
        return False
    
    return True
```

#### –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–µ—Ç–æ–¥ `inject_cookies()`

–¢–µ–ø–µ—Ä—å –≤–∫–ª—é—á–∞–µ—Ç —Ü–∏–∫–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ—Å–ª–µ –∏–Ω—ä–µ–∫—Ü–∏–∏:

```python
@staticmethod
def inject_cookies(driver: uc.Chrome, cookies: list, domain: str) -> bool:
    # ... –∏–Ω—ä–µ–∫—Ü–∏—è –∫—É–∫ ...
    
    # –¶–∏–∫–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ (–º–∞–∫—Å–∏–º—É–º 3 –ø–æ–ø—ã—Ç–∫–∏)
    max_attempts = 3
    for attempt in range(1, max_attempts + 1):
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
        driver.refresh()
        time.sleep(1)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        if SimpleUndetectedBrowser._check_page_loaded(driver, domain):
            return True
        else:
            if attempt < max_attempts:
                time.sleep(3)  # –ü–∞—É–∑–∞ –ø–µ—Ä–µ–¥ retry
            else:
                return False
    
    return False
```

### 3. `main.py`

–£–ø—Ä–æ—â–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –¥–ª—è SIMPLE –±—Ä–∞—É–∑–µ—Ä–∞ - —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–µ—Ç–æ–¥ `SimpleUndetectedBrowser.inject_cookies()`:

```python
# –°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è (—É–¥–∞–ª–µ–Ω–∞):
# - –†—É—á–Ω–∞—è –∏–Ω—ä–µ–∫—Ü–∏—è –∫—É–∫ —á–µ—Ä–µ–∑ —Ü–∏–∫–ª
# - –†—É—á–Ω–æ–π refresh
# - –†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫—É–∫

# –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è:
from simple_browser_manager import SimpleUndetectedBrowser

success = SimpleUndetectedBrowser.inject_cookies(
    driver=driver,
    cookies=cookies,
    domain=url_base
)

if not success:
    raise Exception("SIMPLE browser cookie injection failed")
```

## –õ–æ–≥–∏

### –£—Å–ø–µ—à–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å –ø–µ—Ä–≤–æ–π –ø–æ–ø—ã—Ç–∫–∏

```
üåç Navigating to https://samokat.ru with pre-injected cookies...
üîÑ Attempt 1/3 to load page...
‚úÖ Page loaded: https://samokat.ru/
‚úÖ Page loaded successfully on attempt 1
   Current URL: https://samokat.ru/
```

### –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ –≤—Ç–æ—Ä–æ–π –ø–æ–ø—ã—Ç–∫–∏

```
üåç Navigating to https://samokat.ru with pre-injected cookies...
üîÑ Attempt 1/3 to load page...
‚ùå URL mismatch: expected 'samokat.ru' in 'about:blank'
‚ö†Ô∏è Page not loaded on attempt 1/3
‚è≥ Waiting 3 seconds before retry...
üîÑ Attempt 2/3 to load page...
‚úÖ Page loaded: https://samokat.ru/
‚úÖ Page loaded successfully on attempt 2
   Current URL: https://samokat.ru/
```

### –ù–µ—É–¥–∞—á–∞ –ø–æ—Å–ª–µ 3 –ø–æ–ø—ã—Ç–æ–∫

```
üåç Navigating to https://samokat.ru with pre-injected cookies...
üîÑ Attempt 1/3 to load page...
‚ùå Page load check failed: timeout
‚ö†Ô∏è Page not loaded on attempt 1/3
‚è≥ Waiting 3 seconds before retry...
üîÑ Attempt 2/3 to load page...
‚ùå Body element not found
‚ö†Ô∏è Page not loaded on attempt 2/3
‚è≥ Waiting 3 seconds before retry...
üîÑ Attempt 3/3 to load page...
‚ùå Page load check failed: stale element
‚ö†Ô∏è Page not loaded on attempt 3/3
‚ùå Failed to load page after 3 attempts
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:

1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤ —á–µ—Ä–µ–∑ RPA —Å–µ—Ä–≤–∏—Å
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ - –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ –ø–æ–ø—ã—Ç–∫–∞—Ö –∑–∞–≥—Ä—É–∑–∫–∏
3. –ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å —Å–µ—Ç—å—é/–∞–Ω—Ç–∏–±–æ—Ç–æ–º –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è retry

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

- –í—Å–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≤—è—Ç—Å—è –∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è `False` –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ
- –ü–æ—Å–ª–µ 3 –Ω–µ—É–¥–∞—á –º–µ—Ç–æ–¥ –∏–Ω—ä–µ–∫—Ü–∏–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `False`
- –ü–æ–∏—Å–∫ –Ω–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –µ—Å–ª–∏ –∏–Ω—ä–µ–∫—Ü–∏—è –Ω–µ—É—Å–ø–µ—à–Ω–∞

## –ü–∞—Ä–∞–º–µ—Ç—Ä—ã

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|----------|----------|
| –ú–∞–∫—Å–∏–º—É–º –ø–æ–ø—ã—Ç–æ–∫ | 3 | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ |
| –ü–∞—É–∑–∞ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏ | 3 —Å–µ–∫ | –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –ø–µ—Ä–µ–¥ retry |
| –ü–∞—É–∑–∞ –ø–æ—Å–ª–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ | 1 —Å–µ–∫ | –í—Ä–µ–º—è –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã |

## –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

- ‚úÖ CDP –±—Ä–∞—É–∑–µ—Ä (Selenium)
- ‚úÖ Simple undetected –±—Ä–∞—É–∑–µ—Ä (undetected-chromedriver)
- ‚úÖ –í—Å–µ –õ–°–î (–°–∞–º–æ–∫–∞—Ç, –ê—à–∞–Ω, –õ–µ–Ω—Ç–∞ –∏ —Ç.–¥.)
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å qrator_init –∏ –±–µ–∑ –Ω–µ–≥–æ

## –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Å—Ç–∞—è (—Ç–æ–ª—å–∫–æ URL + body), –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
2. –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ (3)
3. –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–∞—É–∑–∞ (3 —Å–µ–∫—É–Ω–¥—ã)

–î–ª—è –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤ –º–æ–∂–Ω–æ:
- –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞–ª–∏—á–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø—Ä–æ—Ñ–∏–ª—è
- –°–¥–µ–ª–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º—ã–º–∏
- –î–æ–±–∞–≤–∏—Ç—å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—É—é –∑–∞–¥–µ—Ä–∂–∫—É –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏
