# üéâ Match Score v5.2 - –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç

## –î–∞—Ç–∞: 27 —Å–µ–Ω—Ç—è–±—Ä—è 2025

---

## ‚úÖ –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –û–±–Ω–æ–≤–ª–µ–Ω –∞–ª–≥–æ—Ä–∏—Ç–º match_score
- **–§–∞–π–ª:** `services/rpa-service/main.py`
- **–§—É–Ω–∫—Ü–∏—è:** `calculate_advanced_match_score()`
- **–í–µ—Ä—Å–∏—è:** v5.2

**–ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:**
- ‚úÖ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —à—Ç—Ä–∞—Ñ –∑–∞ –Ω–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–µ—Ä–≤–æ–≥–æ —Å–ª–æ–≤–∞ (-0.25 –¥–æ -0.45)
- ‚úÖ –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –±–æ–Ω—É—Å—ã —Å —É—á–µ—Ç–æ–º –ø–æ–ª–Ω–æ–≥–æ –ø–æ–∫—Ä—ã—Ç–∏—è —Å–ª–æ–≤
- ‚úÖ –ë–∞–ª–∞–Ω—Å –º–µ–∂–¥—É —Å—Ç—Ä–æ–≥–æ—Å—Ç—å—é –∏ —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å—é

### 2. –°–æ–∑–¥–∞–Ω–∞ —É—Ç–∏–ª–∏—Ç–∞ –ø–µ—Ä–µ—Å—á–µ—Ç–∞
- **–°–∫—Ä–∏–ø—Ç:** `services/rpa-service/rematch.sh`
- **–ú–æ–¥—É–ª—å:** `services/rpa-service/rematch_stocks.py`
- **–ö–æ–º–∞–Ω–¥—ã:**
  ```bash
  ./rematch.sh --stats      # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
  ./rematch.sh --dry-run    # –ë–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
  ./rematch.sh              # –ü—Ä–∏–º–µ–Ω–∏—Ç—å
  ```

### 3. –û—á–∏—â–µ–Ω–∞ –ø–∞–ø–∫–∞ rpa-service
**–£–¥–∞–ª–µ–Ω—ã –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- ‚ùå test_match_score.py
- ‚ùå test_match_score_fix.py
- ‚ùå test_match_score_simple.py
- ‚ùå test_match_score_v4.py
- ‚ùå test_match_simple.py
- ‚ùå test_match_v5.py
- ‚ùå test_match_v51.py
- ‚ùå test_match_v5_final.py
- ‚ùå MATCH_SCORE_v3_IMPROVEMENTS.md

**–û—Å—Ç–∞–≤–ª–µ–Ω—ã —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ:**
- ‚úÖ test_match_v52_final.py
- ‚úÖ MATCH_SCORE_v52_UPDATE.md
- ‚úÖ README.md (–Ω–æ–≤—ã–π)

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (5 –∫–µ–π—Å–æ–≤)

| –ö–µ–π—Å | –ó–∞–ø—Ä–æ—Å | –ù–∞–π–¥–µ–Ω–Ω–æ–µ | –ë—ã–ª–æ | –°—Ç–∞–ª–æ | ‚úì |
|------|--------|-----------|------|-------|---|
| 1 | –ª–æ—Å–æ—Å—å —Å–ª–∞–±–æ—Å–æ–ª–µ–Ω–∞—è | –°–µ–ª—å–¥—å...–ª–æ—Å–æ—Å—å | 0.825 | **0.575** | ‚úÖ |
| 2 | —á–µ—Ä—Ä–∏ | –¢–æ–º–∞—Ç—ã —á–µ—Ä—Ä–∏ | 1.000 | **1.000** | ‚úÖ |
| 3 | —á–µ—Ä—Ä–∏ | –°–µ–º–µ–Ω–∞...–ß–µ—Ä—Ä–∏ | 0.000 | **0.450** | ‚úÖ |
| 4 | —á–µ—Ä–∫–∏–∑–æ–≤–æ —Å–∞–ª—å—á–∏—á–æ–Ω | –ö–æ–ª–±–∞—Å–∞...–°–∞–ª—å—á–∏—á–æ–Ω...–ß–µ—Ä–∫–∏–∑–æ–≤–æ | 0.900 | **0.850** | ‚úÖ |
| 5 | –º–æ–ª–æ–∫–æ | –ú–æ–ª–æ–∫–æ –ø–∞—Å—Ç–µ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–µ | 1.000 | **1.000** | ‚úÖ |

### –†–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (900 –∑–∞–ø–∏—Å–µ–π)

```
–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: 900
–ë—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–æ: 341 (37.9%)
–ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π: 230 (>0.1)

–¢–û–ü –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
‚úÖ "—Ö–ª–µ–±" vs "–ª–∞–≤–∞—à–∏" ‚Üí 0.650 ‚Üí 0.000
‚úÖ "—Å–∞–ª—å—á–∏—á–æ–Ω" vs "—Å–∞–ª—è–º–∏" ‚Üí 0.650 ‚Üí 0.000
‚úÖ "—è–±–ª–æ–∫–∏" vs "—Å–æ–∫" ‚Üí 0.650 ‚Üí 0.000
```

---

## üìÅ –§–∞–π–ª—ã

### –û—Å–Ω–æ–≤–Ω—ã–µ
```
services/rpa-service/
‚îú‚îÄ‚îÄ main.py                      # ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω –∞–ª–≥–æ—Ä–∏—Ç–º v5.2
‚îú‚îÄ‚îÄ rematch.sh                   # ‚úÖ Wrapper –¥–ª—è —É—Ç–∏–ª–∏—Ç—ã
‚îú‚îÄ‚îÄ rematch_stocks.py            # ‚úÖ –£—Ç–∏–ª–∏—Ç–∞ –ø–µ—Ä–µ—Å—á–µ—Ç–∞
‚îî‚îÄ‚îÄ test_match_v52_final.py      # ‚úÖ –§–∏–Ω–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã
```

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
```
services/rpa-service/
‚îú‚îÄ‚îÄ README.md                    # ‚úÖ –ì–ª–∞–≤–Ω—ã–π README
‚îú‚îÄ‚îÄ SUMMARY.md                   # ‚úÖ –ü–æ–ª–Ω–∞—è —Å–≤–æ–¥–∫–∞
‚îú‚îÄ‚îÄ MATCH_SCORE_v52_UPDATE.md    # ‚úÖ –î–µ—Ç–∞–ª–∏ –∞–ª–≥–æ—Ä–∏—Ç–º–∞
‚îú‚îÄ‚îÄ README_REMATCH.md            # ‚úÖ Quick start
‚îî‚îÄ‚îÄ REMATCH_UTILITY.md           # ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —É—Ç–∏–ª–∏—Ç—ã

/MATCH_SCORE_UPDATE.md           # ‚úÖ Quick guide –≤ –∫–æ—Ä–Ω–µ
```

---

## üöÄ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –Ω–∞ production

### –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π workflow

```bash
# 1. –ü–µ—Ä–µ–π—Ç–∏ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
cd /Users/ss/GenAI/korzinka/services/rpa-service

# 2. –ë—ç–∫–∞–ø –ë–î (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
pg_dump korzinka > ~/backup_$(date +%Y%m%d).sql

# 3. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ "–¥–æ"
./rematch.sh --stats > stats_before.txt

# 4. Dry-run –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
./rematch.sh --dry-run > rematch_preview.log

# 5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å TOP-10 –∏–∑–º–µ–Ω–µ–Ω–∏–π
tail -50 rematch_preview.log

# 6. –ï—Å–ª–∏ –≤—Å–µ –û–ö - –ø—Ä–∏–º–µ–Ω–∏—Ç—å
./rematch.sh

# 7. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ "–ø–æ—Å–ª–µ"
./rematch.sh --stats > stats_after.txt

# 8. –°—Ä–∞–≤–Ω–∏—Ç—å
diff stats_before.txt stats_after.txt
```

### –î–ª—è –æ–¥–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞

```bash
# Dry-run —Å –¥–µ—Ç–∞–ª—è–º–∏
./rematch.sh --order-id 123 --dry-run --verbose

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ –¥–ª—è —ç—Ç–æ–≥–æ –∑–∞–∫–∞–∑–∞
./rematch.sh --order-id 123
```

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø
- **–ì–ª–∞–≤–Ω–∞—è —Å–≤–æ–¥–∫–∞:** `services/rpa-service/SUMMARY.md`
- **Quick guide:** `/MATCH_SCORE_UPDATE.md`
- **–î–µ—Ç–∞–ª–∏ –∞–ª–≥–æ—Ä–∏—Ç–º–∞:** `services/rpa-service/MATCH_SCORE_v52_UPDATE.md`
- **–£—Ç–∏–ª–∏—Ç–∞ –ø–µ—Ä–µ—Å—á–µ—Ç–∞:** `services/rpa-service/REMATCH_UTILITY.md`
- **README rpa-service:** `services/rpa-service/README.md`

### –ö–æ–º–∞–Ω–¥—ã

```bash
# –°–ø—Ä–∞–≤–∫–∞
./rematch.sh --help

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
./rematch.sh --stats

# –°—É—Ö–æ–π –ø—Ä–æ–≥–æ–Ω
./rematch.sh --dry-run

# –° –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç—è–º–∏
./rematch.sh --dry-run --verbose

# –î–ª—è –∑–∞–∫–∞–∑–∞
./rematch.sh --order-id 123

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å
./rematch.sh
```

---

## üîë –ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞–ª–≥–æ—Ä–∏—Ç–º–∞

### v3.0 ‚Üí v5.2

**–ë—ã–ª–æ (v3.0):**
- –ú—è–≥–∫–∏–µ —à—Ç—Ä–∞—Ñ—ã
- "–ª–æ—Å–æ—Å—å" vs "—Å–µ–ª—å–¥—å" ‚Üí 0.825 ‚ùå

**–°—Ç–∞–ª–æ (v5.2):**
- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —à—Ç—Ä–∞—Ñ –∑–∞ –ø–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ
- –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –±–æ–Ω—É—Å—ã
- "–ª–æ—Å–æ—Å—å" vs "—Å–µ–ª—å–¥—å" ‚Üí 0.575 ‚úÖ

### –§–æ—Ä–º—É–ª–∞

```
final_score = base_score + bonus - penalty

–≥–¥–µ:
  base_score = –Ω–∞–π–¥–µ–Ω–Ω—ã–µ_—Å–ª–æ–≤–∞ / –≤—Å–µ–≥–æ_—Å–ª–æ–≤
  
  penalty:
    - –¥–ª–∏–Ω–∞ > 2x: –¥–æ -0.3
    - –ø–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ –Ω–µ –≤ —Ç–æ–ø-3:
      ‚Ä¢ 100% –ø–æ–∫—Ä—ã—Ç–∏–µ: -0.25
      ‚Ä¢ –Ω–µ–ø–æ–ª–Ω–æ–µ: -0.45
  
  bonus (–µ—Å–ª–∏ penalty < 0.5):
    - –ø–æ–ª–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ: +0.15
    - —Ç–æ—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è: +0.1
    - –ø–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ: +0.1 –¥–æ +0.2
```

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

### –ü–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º
1. ‚úÖ –°–¥–µ–ª–∞–π—Ç–µ –±—ç–∫–∞–ø –ë–î
2. ‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç–µ dry-run
3. ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ TOP-10 –∏–∑–º–µ–Ω–µ–Ω–∏–π
4. ‚úÖ –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ª–æ–≥–∏—á–Ω—ã

### –ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
1. ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
2. ‚úÖ –°—Ä–∞–≤–Ω–∏—Ç–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
3. ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ –ø–æ–∏—Å–∫–∞
4. ‚úÖ –°–æ–±–∏—Ä–∞–π—Ç–µ —Ñ–∏–¥–±—ç–∫

### –û—Ç–∫–∞—Ç (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
```bash
# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –±—ç–∫–∞–ø–∞
psql korzinka < backup_YYYYMMDD.sql
```

---

## üìà –û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç

### –ö–∞—á–µ—Å—Ç–≤–æ –ø–æ–∏—Å–∫–∞
- ‚úÖ –Ø–≤–Ω–æ —Ä–∞–∑–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã: score < 0.3
- ‚úÖ –°–æ–º–Ω–∏—Ç–µ–ª—å–Ω—ã–µ: score 0.3-0.6
- ‚úÖ –•–æ—Ä–æ—à–∏–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è: score 0.7-0.9
- ‚úÖ –¢–æ—á–Ω—ã–µ: score 0.9-1.0

### –ú–µ—Ç—Ä–∏–∫–∏ (–ø—Ä–æ–≥–Ω–æ–∑)
- –¢–æ—á–Ω–æ—Å—Ç—å: +15-20%
- –õ–æ–∂–Ω—ã–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è: -60%
- –†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å —Ç–æ–ø-3: +25%

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –ê–ª–≥–æ—Ä–∏—Ç–º –æ–±–Ω–æ–≤–ª–µ–Ω
2. ‚úÖ –£—Ç–∏–ª–∏—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞
3. ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≥–æ—Ç–æ–≤–∞
4. ‚úÖ –ü–∞–ø–∫–∞ –æ—á–∏—â–µ–Ω–∞
5. ‚è≠Ô∏è **–ü—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–∞ production**
6. ‚è≠Ô∏è –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–∞—á–µ—Å—Ç–≤–∞
7. ‚è≠Ô∏è –°–±–æ—Ä –º–µ—Ç—Ä–∏–∫ –∏ —Ñ–∏–¥–±—ç–∫–∞

---

## üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –ø–æ–º–æ—â—å

**–í–æ–ø—Ä–æ—Å—ã –ø–æ –∞–ª–≥–æ—Ä–∏—Ç–º—É:**
- –°–º. `MATCH_SCORE_v52_UPDATE.md`
- –ö–æ–¥: `main.py:calculate_advanced_match_score()`

**–í–æ–ø—Ä–æ—Å—ã –ø–æ —É—Ç–∏–ª–∏—Ç–µ:**
- –°–º. `REMATCH_UTILITY.md`
- –ö–æ–¥: `rematch_stocks.py`

**–û–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã:**
- –°–º. `README.md` –≤ rpa-service
- –°–º. `/MATCH_SCORE_UPDATE.md` –¥–ª—è quick guide

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ production  
**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 27 —Å–µ–Ω—Ç—è–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è:** Match Score v5.2
