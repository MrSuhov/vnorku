# Magnit Module - –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ –ø—Ä–æ–¥–µ–ª–∞–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã

## ‚úÖ –ß—Ç–æ –≥–æ—Ç–æ–≤–æ

### 1. –û—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥—É–ª—å: `magnit.py`
**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `/Users/ss/GenAI/korzinka/services/rpa-service/magnit.py`

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ (refresh_access_token)
- ‚úÖ –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ HTTP –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ (build_base_headers)
- ‚úÖ –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤ (search_products)
- ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏ –≤ –ë–î (get_session_data, update_session_data)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏
- ‚úÖ –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ JWT –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –∂–∏–∑–Ω–∏
- ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Device ID –∏ Sentry trace headers

**–ü—É–±–ª–∏—á–Ω—ã–π API:**
```python
initialize_magnit_session(session_id, refresh_token)  # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
search_products(query, session_id)                     # –ü–æ–∏—Å–∫
refresh_token_if_needed(session_id)                    # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
```

### 2. –¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç: `test_magnit.py`
**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `/Users/ss/GenAI/korzinka/services/rpa-service/test_magnit.py`

**–¢–µ—Å—Ç—ã:**
- Test 1: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Å—Å–∏–∏ —Å refresh token
- Test 2: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
- Test 3: –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤ "–®–∞—Ä–º—ç–ª—å"

### 3. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: `MAGNIT_MODULE_README.md`
**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `/Users/ss/GenAI/korzinka/services/rpa-service/MAGNIT_MODULE_README.md`

–ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é, —Å—Ç—Ä—É–∫—Ç—É—Ä–µ, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º –∏ –ø—Ä–∏–º–µ—Ä–∞–º.

### 4. –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ `requirements.txt`: `PyJWT==2.8.0`
- ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –≤ venv

### 5. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ —Ç–µ—Å—Ç–æ–≤–∞—è —Å–µ—Å—Å–∏—è (ID=999) –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚úÖ –ú–æ–¥—É–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ JSON –ø–æ–ª–µ `data` –≤ `user_sessions`

## ‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: X-Request-Sign

**–ü—Ä–æ–±–ª–µ–º–∞:** Magnit API —Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥–ø–∏—Å—å `X-Request-Sign` (128 hex —Å–∏–º–≤–æ–ª–æ–≤).

**–¢–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ:** STUB (–∑–∞–≥–ª—É—à–∫–∞) - —Ñ—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É.

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- ‚ö†Ô∏è API –º–æ–∂–µ—Ç –æ—Ç–∫–ª–æ–Ω—è—Ç—å –∑–∞–ø—Ä–æ—Å—ã –±–µ–∑ –ø–æ–¥–ø–∏—Å–∏
- ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è reverse engineering –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

**–í–∞—Ä–∏–∞–Ω—Ç—ã —Ä–µ—à–µ–Ω–∏—è:**
1. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –±–µ–∑ –ø–æ–¥–ø–∏—Å–∏ (–º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤)
2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å mock-–ø–æ–¥–ø–∏—Å—å –∏–∑ –ª–æ–≥–æ–≤ (–≤—Ä–µ–º–µ–Ω–Ω–æ)
3. –î–µ–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –∏–∑–≤–ª–µ—á—å –∞–ª–≥–æ—Ä–∏—Ç–º (–ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ)

## üß™ –ö–∞–∫ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

### –®–∞–≥ 1: –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å venv
```bash
cd /Users/ss/GenAI/korzinka
source venv/bin/activate
```

### –®–∞–≥ 2: –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
```bash
cd services/rpa-service
python3 test_magnit.py
```

### –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:
- ‚úÖ **Test 1 (Initialize):** PASS - —Ç–æ–∫–µ–Ω –¥–æ–ª–∂–µ–Ω –æ–±–Ω–æ–≤–∏—Ç—å—Å—è
- ‚úÖ **Test 2 (Refresh):** PASS - —Ç–æ–∫–µ–Ω –∞–∫—Ç—É–∞–ª—å–Ω—ã–π
- ‚ö†Ô∏è **Test 3 (Search):** –ú–û–ñ–ï–¢ –ù–ï –ü–†–û–ô–¢–ò –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è X-Request-Sign

### –í–æ–∑–º–æ–∂–Ω—ã–µ –æ—à–∏–±–∫–∏ –ø—Ä–∏ Test 3:
- **401/403:** API —Ç—Ä–µ–±—É–µ—Ç X-Request-Sign ‚Üí –Ω—É–∂–µ–Ω reverse engineering
- **200 OK:** –û—Ç–ª–∏—á–Ω–æ! API —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –ø–æ–¥–ø–∏—Å–∏ ‚Üí –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
- **–î—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞:** –°–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥ –∏ response body –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

## üìä –î–∞–Ω–Ω—ã–µ –∏–∑ –ª–æ–≥–æ–≤

–ò–∑–≤–ª–µ—á–µ–Ω–æ –∏–∑ `flows_dump.mitm.candidates.json`:

### –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (refresh token)
- **URL:** `POST https://id.magnit.ru/v1/auth/token/refresh`
- **Body:** `{"aud":"loyalty-mobile","refreshToken":"<uuid>"}`
- **Response:** `{"accessToken":"<jwt>","refreshToken":"<uuid>"}`
- **–¢–µ—Å—Ç–æ–≤—ã–π refresh token:** `bdab3844-fed9-4ad6-bb20-5024cd4d38f0`

### –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤
- **URL:** `POST https://middle-api.magnit.ru/v1/goods/multisearch`
- **Body:** 
  ```json
  {
    "term": "–®–∞—Ä–º—ç–ª—å",
    "stores": [
      {"storeType":"express","storeCode":"778168"},
      {"storeType":"cosmetic","storeCode":"398156"},
      {"storeType":"dostavka","storeCode":"997753"}
    ],
    "catalogType": "2",
    "includeAdultGoods": true
  }
  ```

### –ó–∞–≥–æ–ª–æ–≤–∫–∏ (–≤—Å–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã)
- ‚úÖ `Authorization: Bearer <JWT>`
- ‚úÖ `X-Device-ID: <UUID>`
- ‚úÖ `X-Device-Platform: iOS`
- ‚úÖ `X-Platform-Version: 26.0.1`
- ‚úÖ `X-App-Version: 8.72.0`
- ‚úÖ `User-Agent: MagnitOmni/8.72.0 (...)`
- ‚úÖ `sentry-trace`, `baggage` (Sentry tracking)
- ‚ö†Ô∏è `X-Request-Sign` - **STUB** (–Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)

## üìù –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î

–¢–∞–±–ª–∏—Ü–∞ `user_sessions`, –ø–æ–ª–µ `data` (JSON):
```json
{
  "magnit_device_id": "7a7d5943-c54b-4447-bfa7-5b38ae6a2bab",
  "magnit_access_token": "eyJhbGci...",
  "magnit_refresh_token": "bdab3844-fed9-4ad6-bb20-5024cd4d38f0",
  "magnit_token_expires_at": "2025-10-06T12:00:00Z"
}
```

## üîÑ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ (–¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è):
1. **–ó–∞–ø—É—Å—Ç–∏—Ç—å test_magnit.py** - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å
2. **–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç Test 3:**
   - –ï—Å–ª–∏ **PASS** ‚Üí API —Ä–∞–±–æ—Ç–∞–µ—Ç, –º–æ–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å
   - –ï—Å–ª–∏ **FAIL —Å 401/403** ‚Üí –Ω–∞—á–∞—Ç—å reverse engineering X-Request-Sign
   - –ï—Å–ª–∏ **–¥—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞** ‚Üí –∏–∑—É—á–∏—Ç—å response –∏ –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å –ø–∞—Ä—Å–µ—Ä

### –ï—Å–ª–∏ API —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ X-Request-Sign:
3. –î–æ—Ä–∞–±–æ—Ç–∞—Ç—å –ø–∞—Ä—Å–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ (`parse_search_results`)
4. –î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–æ—Ä–∑–∏–Ω—ã –∏ –∑–∞–∫–∞–∑–æ–≤
5. –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å RPA workflow

### –ï—Å–ª–∏ API —Ç—Ä–µ–±—É–µ—Ç X-Request-Sign:
3. –î–µ–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞—Ç—å –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (IPA/APK)
4. –ù–∞–π—Ç–∏ —Ñ—É–Ω–∫—Ü–∏—é –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–∏
5. –ò–∑–≤–ª–µ—á—å —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á
6. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–ª–≥–æ—Ä–∏—Ç–º –≤ `calculate_request_sign()`

## üìÅ –§–∞–π–ª—ã –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞

1. **–ú–æ–¥—É–ª—å:** `/Users/ss/GenAI/korzinka/services/rpa-service/magnit.py`
2. **–¢–µ—Å—Ç—ã:** `/Users/ss/GenAI/korzinka/services/rpa-service/test_magnit.py`
3. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** `/Users/ss/GenAI/korzinka/services/rpa-service/MAGNIT_MODULE_README.md`
4. **–õ–æ–≥–∏ —Ç—Ä–∞—Ñ–∏–∫–∞:** `/Users/ss/GenAI/korzinka/services/rpa-service/magnit/flows_dump.mitm.candidates.json`

## üéØ –ö—Ä–∞—Ç–∫–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è

```bash
# 1. –ü–µ—Ä–µ–π—Ç–∏ –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞
cd /Users/ss/GenAI/korzinka

# 2. –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å venv
source venv/bin/activate

# 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
cd services/rpa-service
python3 test_magnit.py

# 4. –ò–∑—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É
```

---

**–°—Ç–∞—Ç—É—Å:** MVP –≥–æ—Ç–æ–≤, —Ç—Ä–µ–±—É–µ—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –≤–æ–∑–º–æ–∂–Ω–æ–π –¥–æ—Ä–∞–±–æ—Ç–∫–∏ X-Request-Sign
**–î–∞—Ç–∞:** 05.10.2025
