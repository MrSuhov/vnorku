# NumPy Optimizer Integration Guide

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

**NumPy –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä:**
- **–í—Ä–µ–º—è:** ~1.1 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è 1.68M –∫–æ–º–±–∏–Ω–∞—Ü–∏–π
- **–°–∫–æ—Ä–æ—Å—Ç—å:** ~1,500,000 –∫–æ–º–±–∏–Ω–∞—Ü–∏–π/—Å–µ–∫—É–Ω–¥—É  
- **–£—Å–∫–æ—Ä–µ–Ω–∏–µ:** **~75√ó –±—ã—Å—Ç—Ä–µ–µ** —á–µ–º Legacy –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä

**–†–∞–∑–±–∏–≤–∫–∞ –ø–æ —ç—Ç–∞–ø–∞–º (–¥–ª—è 1.68M –∫–æ–º–±–∏–Ω–∞—Ü–∏–π):**
1. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö: 0.02 —Å–µ–∫
2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∞—Ç—Ä–∏—Ü—ã –∏–Ω–¥–µ–∫—Å–æ–≤ (51.3 MB): 0.04 —Å–µ–∫
3. –í–µ–∫—Ç–æ—Ä–Ω—ã–π —Ä–∞—Å—á—ë—Ç –±–∞–∑–æ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫: 0.11 —Å–µ–∫ (**15M –∫–æ—Ä–∑–∏–Ω/—Å–µ–∫!**)
4. –ü—Ä–µ–¥—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–æ–ø-100K: 0.02 —Å–µ–∫
5. –†–∞—Å—á—ë—Ç –¥–æ—Å—Ç–∞–≤–∫–∏: 0.87 —Å–µ–∫ (115K –∫–æ—Ä–∑–∏–Ω/—Å–µ–∫)
6. –û—Ç–±–æ—Ä —Ç–æ–ø-N: 0.01 —Å–µ–∫
7. –ó–∞–ø–∏—Å—å –≤ –ë–î: 0.02 —Å–µ–∫

---

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ Python —Å–∫—Ä–∏–ø—Ç (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –¥–≤–∏–∂–∫–∞ (NumPy –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
python3 services/optimizer/optimize.py 25

# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ NumPy
python3 services/optimizer/optimize.py 25 --engine numpy

# –° –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
python3 services/optimizer/optimize.py 25 --engine numpy --top-n 5 --top-k-prefilter 50000

# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ Legacy (—Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è)
python3 services/optimizer/optimize.py 25 --engine legacy
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ß–µ—Ä–µ–∑ bash —Å–∫—Ä–∏–ø—Ç

```bash
# –ë–∞–∑–æ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
./services/optimizer/optimize_order_py.sh 25

# –° –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
./services/optimizer/optimize_order_py.sh 25 --engine numpy --top-n 10

# –ü–æ–º–æ—â—å
./services/optimizer/optimize_order_py.sh
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ò–∑ Python –∫–æ–¥–∞

```python
from services.optimizer.optimize import optimize_order_unified

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä
result = optimize_order_unified(
    order_id=25,
    db_connection_string="postgresql://...",
    engine="auto"
)

# NumPy –≤–µ—Ä—Å–∏—è
result = optimize_order_unified(
    order_id=25,
    db_connection_string="postgresql://...",
    engine="numpy",
    top_k_prefilter=100000,
    top_n_final=10
)

# Legacy –≤–µ—Ä—Å–∏—è
result = optimize_order_unified(
    order_id=25,
    db_connection_string="postgresql://...",
    engine="legacy",
    top_n=10
)

print(f"–í—Ä–µ–º—è: {result['elapsed_time']:.2f} —Å–µ–∫")
print(f"–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {result['performance_comb_per_sec']:,} –∫–æ–º–±/—Å–µ–∫")
```

---

## üì¶ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã

### NumPy Optimizer

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –¢–∏–ø | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|-----|--------------|----------|
| `order_id` | int | **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ** | ID –∑–∞–∫–∞–∑–∞ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ |
| `engine` | str | `"auto"` | –î–≤–∏–∂–æ–∫: `"numpy"`, `"legacy"`, –∏–ª–∏ `"auto"` |
| `top_k_prefilter` | int | `100000` | –ö–æ–ª-–≤–æ –∫–æ–º–±–∏–Ω–∞—Ü–∏–π –¥–ª—è –ø—Ä–µ–¥—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ |
| `top_n_final` | int | `10` | –ö–æ–ª-–≤–æ —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö –∫–æ—Ä–∑–∏–Ω –¥–ª—è –∑–∞–ø–∏—Å–∏ |

### Legacy Optimizer

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –¢–∏–ø | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|-----|--------------|----------|
| `order_id` | int | **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ** | ID –∑–∞–∫–∞–∑–∞ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ |
| `top_n` | int | `10` | –ö–æ–ª-–≤–æ –∫–æ—Ä–∑–∏–Ω –¥–ª—è –∑–∞–ø–∏—Å–∏ |

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ NumPy –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä–∞

```
1. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ NumPy –º–∞—Å—Å–∏–≤—ã
   ‚Üì
2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–Ω–¥–µ–∫—Å–Ω–æ–π –º–∞—Ç—Ä–∏—Ü—ã –∫–æ–º–±–∏–Ω–∞—Ü–∏–π (memory-efficient)
   ‚Üì
3. –í–µ–∫—Ç–æ—Ä–Ω—ã–π —Ä–∞—Å—á—ë—Ç –±–∞–∑–æ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫ (total_loss, total_goods_cost)
   ‚Üì
4. –ü—Ä–µ–¥—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è: –æ—Ç–±–æ—Ä —Ç–æ–ø-K –ø–æ losses
   ‚Üì
5. –†–∞—Å—á—ë—Ç –¥–æ—Å—Ç–∞–≤–∫–∏ –¥–ª—è –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–æ–º–±–∏–Ω–∞—Ü–∏–π
   ‚Üì
6. –§–∏–Ω–∞–ª—å–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏ –æ—Ç–±–æ—Ä —Ç–æ–ø-N
   ‚Üì
7. –ó–∞–ø–∏—Å—å –≤ –ë–î
```

### –ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏

**–î–ª—è 1.68M –∫–æ–º–±–∏–Ω–∞—Ü–∏–π (8 —Ç–æ–≤–∞—Ä–æ–≤ √ó 6 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤):**
- –ò–Ω–¥–µ–∫—Å–Ω–∞—è –º–∞—Ç—Ä–∏—Ü–∞: ~51 MB
- –î–∞–Ω–Ω—ã–µ (losses, costs, etc): ~1 KB
- –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–∞—Å—Å–∏–≤—ã: ~20 MB
- **–ò—Ç–æ–≥–æ:** ~70-80 MB

**–î–ª—è 10M –∫–æ–º–±–∏–Ω–∞—Ü–∏–π:**
- –ò–Ω–¥–µ–∫—Å–Ω–∞—è –º–∞—Ç—Ä–∏—Ü–∞: ~305 MB
- –î–∞–Ω–Ω—ã–µ: ~1 KB  
- –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–∞—Å—Å–∏–≤—ã: ~120 MB
- **–ò—Ç–æ–≥–æ:** ~430-450 MB

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–±–∏–Ω–∞—Ü–∏–π:** ~50M (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ –ø–∞–º—è—Ç—å—é)
   - –î–ª—è –±–æ–ª—å—à–∏—Ö –∑–∞–∫–∞–∑–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Legacy –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä
   
2. **–ü—Ä–µ–¥—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞** –¥–ª—è –∑–∞–∫–∞–∑–æ–≤ > 5M –∫–æ–º–±–∏–Ω–∞—Ü–∏–π
   - –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è `top_k_prefilter=100000`

3. **–†–∞—Å—á—ë—Ç –¥–æ—Å—Ç–∞–≤–∫–∏** - —Å–∞–º–∞—è –º–µ–¥–ª–µ–Ω–Ω–∞—è —á–∞—Å—Ç—å (~80% –≤—Ä–µ–º–µ–Ω–∏)
   - –ß–∞—Å—Ç–∏—á–Ω–æ –≤–µ–∫—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –Ω–æ —Å–æ–¥–µ—Ä–∂–∏—Ç Python —Ü–∏–∫–ª—ã

---

## üìã –õ–æ–≥–∏

### NumPy Optimizer
```bash
tail -f logs/optimizer_numpy.log
```

### Legacy Optimizer
```bash
tail -f logs/optimizer.log
```

---

## üêõ –û—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ NumPy

```bash
python3 -c "import numpy; print(f'NumPy version: {numpy.__version__}')"
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –¢–µ—Å—Ç NumPy –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä–∞
python3 services/optimizer/test_numpy_optimizer.py

# –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å Legacy
python3 services/optimizer/optimize.py 25 --engine numpy
python3 services/optimizer/optimize.py 25 --engine legacy
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

```bash
# –í—Å–µ –∫–æ—Ä–∑–∏–Ω—ã –∑–∞–∫–∞–∑–∞
psql $DATABASE_URL -c "SELECT * FROM basket_analyses WHERE order_id = 25 ORDER BY basket_rank;"

# –õ—É—á—à–∞—è –∫–æ—Ä–∑–∏–Ω–∞
psql $DATABASE_URL -c "
SELECT 
    basket_id,
    basket_rank,
    total_loss,
    total_goods_cost,
    total_delivery_cost,
    total_cost,
    total_loss_and_delivery
FROM basket_analyses 
WHERE order_id = 25 
ORDER BY basket_rank 
LIMIT 1;
"
```

---

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### .env –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

```bash
# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
DATABASE_URL=postgresql://korzinka_user:korzinka_pass@localhost:5432/korzinka
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

–î–ª—è –æ—á–µ–Ω—å –±–æ–ª—å—à–∏—Ö –∑–∞–∫–∞–∑–æ–≤ (> 10M –∫–æ–º–±–∏–Ω–∞—Ü–∏–π):

```python
# –£–≤–µ–ª–∏—á–∏—Ç—å –ø—Ä–µ–¥—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é
top_k_prefilter = 500000  # –≤–º–µ—Å—Ç–æ 100000

# –ò–ª–∏ —É–º–µ–Ω—å—à–∏—Ç—å –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
top_k_prefilter = 50000
```

---

## üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è —Å Legacy –Ω–∞ NumPy

**–®–∞–≥ 1:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å NumPy
```bash
python3 -c "import numpy"
```

**–®–∞–≥ 2:** –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–º –∑–∞–∫–∞–∑–µ
```bash
python3 services/optimizer/optimize.py <test_order_id> --engine numpy
```

**–®–∞–≥ 3:** –°—Ä–∞–≤–Ω–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
```bash
# NumPy
psql $DATABASE_URL -c "SELECT * FROM basket_analyses WHERE order_id = <id> ORDER BY basket_rank LIMIT 1;"

# Legacy (–¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è)
python3 services/optimizer/optimize.py <id> --engine legacy
psql $DATABASE_URL -c "SELECT * FROM basket_analyses WHERE order_id = <id> ORDER BY basket_rank LIMIT 1;"
```

**–®–∞–≥ 4:** –û–±–Ω–æ–≤–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç—ã
```bash
# –°—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–±
./services/optimizer/optimize_order.sh <order_id>

# –ù–æ–≤—ã–π —Å–ø–æ—Å–æ–±
./services/optimizer/optimize_order_py.sh <order_id>
```

---

## üìà –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å NumPy –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä:
- ‚úÖ –ó–∞–∫–∞–∑—ã —Å < 50M –∫–æ–º–±–∏–Ω–∞—Ü–∏–π
- ‚úÖ –¢—Ä–µ–±—É–µ—Ç—Å—è –±—ã—Å—Ç—Ä–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (< 2 —Å–µ–∫)
- ‚úÖ NumPy –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–∏

### –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Legacy –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä:
- ‚ö†Ô∏è –ó–∞–∫–∞–∑—ã —Å > 50M –∫–æ–º–±–∏–Ω–∞—Ü–∏–π
- ‚ö†Ô∏è NumPy –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
- ‚ö†Ô∏è –ù—É–∂–Ω–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ —Å—Ç–∞—Ä—ã–º –∫–æ–¥–æ–º

### –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:

| –ö–æ–º–±–∏–Ω–∞—Ü–∏–π | top_k_prefilter | –û–∂–∏–¥–∞–µ–º–æ–µ –≤—Ä–µ–º—è |
|-----------|-----------------|-----------------|
| < 1M | 50,000 | < 1 —Å–µ–∫ |
| 1M - 5M | 100,000 | 1-3 —Å–µ–∫ |
| 5M - 20M | 200,000 | 3-10 —Å–µ–∫ |
| 20M - 50M | 500,000 | 10-30 —Å–µ–∫ |
| > 50M | Legacy | –≤–∞—Ä—å–∏—Ä—É–µ—Ç—Å—è |

---

## üéØ –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **‚úÖ –°–î–ï–õ–ê–ù–û:** –ü–æ–ª–Ω–∞—è –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –±–∞–∑–æ–≤—ã—Ö —Ä–∞—Å—á—ë—Ç–æ–≤
2. **‚úÖ –°–î–ï–õ–ê–ù–û:** –ò–Ω–¥–µ–∫—Å–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–º–±–∏–Ω–∞—Ü–∏–π
3. **‚úÖ –°–î–ï–õ–ê–ù–û:** –ü—Ä–µ–¥—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–ª—è –±–æ–ª—å—à–∏—Ö –∑–∞–∫–∞–∑–æ–≤
4. **üîÑ –í –ü–†–û–¶–ï–°–°–ï:** –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –æ—Ç–±–æ—Ä–∞ –º–æ–Ω–æ-–∫–æ—Ä–∑–∏–Ω
5. **üìã TODO:** –ü–æ–ª–Ω–∞—è –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ä–∞—Å—á—ë—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
6. **üìã TODO:** –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –±–∞—Ç—á–µ–π
7. **üìã TODO:** –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è –ø–æ—Ö–æ–∂–∏—Ö –∑–∞–∫–∞–∑–æ–≤

---

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

**–ü—Ä–æ–±–ª–µ–º—ã –∏–ª–∏ –≤–æ–ø—Ä–æ—Å—ã?**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `tail -100 logs/optimizer_numpy.log`
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ NumPy —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: `pip install numpy`
- –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Legacy: `--engine legacy`
