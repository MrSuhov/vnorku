# –û–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä –∑–∞–∫–∞–∑–æ–≤ Korzinka

## üì¶ –ß—Ç–æ —ç—Ç–æ?

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –õ–°–î —Å —É—á–µ—Ç–æ–º:
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —Ü–µ–Ω—ã –Ω–∞ –∫–∞–∂–¥—ã–π —Ç–æ–≤–∞—Ä
- –°—Ç–æ–∏–º–æ—Å—Ç–∏ –¥–æ—Å—Ç–∞–≤–∫–∏
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö —Å—É–º–º –∑–∞–∫–∞–∑–∞
- –£—Å–ª–æ–≤–∏–π –¥–æ—Å—Ç–∞–≤–∫–∏ –∫–∞–∂–¥–æ–≥–æ –õ–°–î

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞
```bash
cd services/optimizer
psql $DATABASE_URL -f install.sql
```

### 2. –ó–∞–ø—É—Å–∫ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (–∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞)
```bash
./optimize_order.sh <order_id> [top_n]
```

**–ü—Ä–∏–º–µ—Ä:**
```bash
./optimize_order.sh 1 3  # –¢–æ–ø-3 –∫–æ—Ä–∑–∏–Ω—ã –¥–ª—è –∑–∞–∫–∞–∑–∞ ‚Ññ1
```

### 3. –ü—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
```bash
./services/optimizer/show_results.sh 1
```

–ò–ª–∏ —á–µ—Ä–µ–∑ SQL:
```sql
SELECT * FROM basket_analyses WHERE order_id = 1;
```

## üìä –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –≠—Ç–∞–ø 1: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–º–±–∏–Ω–∞—Ü–∏–π
- –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –±–µ—Ä—É—Ç—Å—è –≤—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Å—Ç–æ–∫–∏ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –õ–°–î
- –ì–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –≤–æ–∑–º–æ–∂–Ω—ã–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ (pieces) –æ—Ç 1 –¥–æ over_requested_quantity
- –†–µ–∑—É–ª—å—Ç–∞—Ç ‚Üí —Ç–∞–±–ª–∏—Ü–∞ `order_combinations`

### –≠—Ç–∞–ø 2: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ—Ä–∑–∏–Ω
- CROSS JOIN –≤—Å–µ—Ö –∫–æ–º–±–∏–Ω–∞—Ü–∏–π —Ç–æ–≤–∞—Ä–æ–≤ (–¥–µ–∫–∞—Ä—Ç–æ–≤–æ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ)
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è: pieces √ó base_quantity ‚â§ over_requested_quantity
- –†–µ–∑—É–ª—å—Ç–∞—Ç ‚Üí —Ç–∞–±–ª–∏—Ü–∞ `valid_baskets` (~650k –∫–æ—Ä–∑–∏–Ω –¥–ª—è 4 —Ç–æ–≤–∞—Ä–æ–≤)

### –≠—Ç–∞–ø 3: –†–∞—Å—á–µ—Ç –¥–æ—Å—Ç–∞–≤–∫–∏
- –î–ª—è –∫–∞–∂–¥–æ–π –∫–æ—Ä–∑–∏–Ω—ã –≥—Ä—É–ø–ø–∏—Ä—É—é—Ç—Å—è —Ç–æ–≤–∞—Ä—ã –ø–æ –õ–°–î
- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è subtotal –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –õ–°–î
- –ü—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ –∏–∑ delivery_cost_model
- –£—á–∏—Ç—ã–≤–∞—é—Ç—Å—è min_order_amount –∏ delivery_topup

### –≠—Ç–∞–ø 4: –í—ã–±–æ—Ä –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã—Ö
- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ total_loss + total_delivery_cost
- –í—ã–±–æ—Ä —Ç–æ–ø-N –∫–æ—Ä–∑–∏–Ω
- –†–µ–∑—É–ª—å—Ç–∞—Ç ‚Üí —Ç–∞–±–ª–∏—Ü–∞ `basket_analyses`

## üìã –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
services/optimizer/
‚îú‚îÄ‚îÄ install.sql                       # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ–π —Å–∏—Å—Ç–µ–º—ã
‚îú‚îÄ‚îÄ optimizer_tables.sql              # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü
‚îú‚îÄ‚îÄ optimizer_procedures.sql          # –ü—Ä–æ—Ü–µ–¥—É—Ä—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ delivery_calculator.sql           # –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
‚îú‚îÄ‚îÄ calculate_optimized_baskets.sql   # –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ optimize_order_fast.sh            # CLI: –±—ã—Å—Ç—Ä–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
‚îú‚îÄ‚îÄ show_results.sh                   # CLI: –≤—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
‚îú‚îÄ‚îÄ README.md                         # –ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îî‚îÄ‚îÄ SUMMARY.md                        # –ò—Ç–æ–≥–æ–≤–∞—è —Å–≤–æ–¥–∫–∞
```

## üîß API

### SQL –ø—Ä–æ—Ü–µ–¥—É—Ä—ã
```sql
-- –ü–æ–ª–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω
CALL generate_valid_baskets(<order_id>);
CALL calculate_optimized_baskets(<order_id>, <top_n>);

-- –ü–æ—à–∞–≥–æ–≤–æ
CALL generate_order_combinations(<order_id>);
CALL generate_valid_baskets(<order_id>);
CALL calculate_optimized_baskets(<order_id>, <top_n>);
```

### SQL —Ñ—É–Ω–∫—Ü–∏—è
```sql
-- –†–∞—Å—á–µ—Ç –¥–æ—Å—Ç–∞–≤–∫–∏ –¥–ª—è –õ–°–î
SELECT * FROM calculate_delivery_fee(<lsd_config_id>, <order_amount>);
```

## üìà –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

**–ó–∞–∫–∞–∑ —Å 4 —Ç–æ–≤–∞—Ä–∞–º–∏:**
- –ö–æ–º–±–∏–Ω–∞—Ü–∏–π: ~200
- –í–∞–ª–∏–¥–Ω—ã—Ö –∫–æ—Ä–∑–∏–Ω: ~650,000
- –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ~13 —Å–µ–∫—É–Ω–¥
- –†–µ–∑—É–ª—å—Ç–∞—Ç: —Ç–æ–ø-3 –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –∫–æ—Ä–∑–∏–Ω—ã

## ‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. **–†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è 4 —Ç–æ–≤–∞—Ä–æ–≤** - –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω–∞ –ø–æ–¥ 4 —Ç–æ–≤–∞—Ä–∞
2. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –¥–ª—è >5 —Ç–æ–≤–∞—Ä–æ–≤ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è >1 –º–∏–Ω—É—Ç—ã
3. **–î–µ—Ç–∞–ª–∏ —Ç–æ–≤–∞—Ä–æ–≤** - –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö —Ç–æ–ª—å–∫–æ subtotal –ø–æ –õ–°–î, –±–µ–∑ —Å–ø–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
4. **–ü—Ä–æ–º–æ–∫–æ–¥—ã** - –ø–æ–∫–∞ –Ω–µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ —Ä–∞—Å—á–µ—Ç

## üìù TODO

- [ ] –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–ª—è –ª—é–±–æ–≥–æ N —Ç–æ–≤–∞—Ä–æ–≤
- [ ] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π —Ç–æ–≤–∞—Ä–æ–≤ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
- [ ] –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- [README.md](services/optimizer/README.md) - –ø–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [SUMMARY.md](services/optimizer/SUMMARY.md) - –∏—Ç–æ–≥–æ–≤–∞—è —Å–≤–æ–¥–∫–∞ –ø–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

## üéØ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

### –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- View `fprice_optimizer` - –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ —Ç–æ–≤–∞—Ä/–õ–°–î —Å —Ü–µ–Ω–∞–º–∏
- –¢–∞–±–ª–∏—Ü–∞ `lsd_configs` - –º–æ–¥–µ–ª–∏ –¥–æ—Å—Ç–∞–≤–∫–∏
- –¢–∞–±–ª–∏—Ü—ã `orders` / `order_items` - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ

### –í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- –¢–∞–±–ª–∏—Ü–∞ `basket_analyses` - —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–ª—è Telegram-–±–æ—Ç–∞

### –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥
–ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –≤–∞—Ä–∏–∞–Ω—Ç–∞ –∏–∑ `basket_analyses`:
1. –ü—Ä–æ—á–∏—Ç–∞—Ç—å `lsd_breakdown`
2. –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∑–∞–∫–∞–∑—ã –≤ –∫–∞–∂–¥–æ–º –õ–°–î —á–µ—Ä–µ–∑ RPA
3. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥—ã
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å
