# –ú–µ—Ö–∞–Ω–∏–∑–º Retry –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤

## –û–±–∑–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π

**–ü—Ä–æ–±–ª–µ–º–∞:** –†–∞–Ω—å—à–µ retry —Ä–∞–±–æ—Ç–∞–ª –Ω–∞ —É—Ä–æ–≤–Ω–µ "–Ω–∞—à–ª–æ—Å—å –ª–∏ —Ö–æ—Ç—å —á—Ç–æ-—Ç–æ –≤ –õ–°–î". –ï—Å–ª–∏ –∏–∑ 5 —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞—à–ª–æ—Å—å 4, —Å–∏—Å—Ç–µ–º–∞ —Å—á–∏—Ç–∞–ª–∞ —ç—Ç–æ —É—Å–ø–µ—Ö–æ–º –∏ –Ω–µ –¥–µ–ª–∞–ª–∞ retry –¥–ª—è –Ω–µ–Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞.

**–†–µ—à–µ–Ω–∏–µ:** –¢–µ–ø–µ—Ä—å retry —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —É—Ä–æ–≤–Ω–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤. –°–∏—Å—Ç–µ–º–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∫–∞–∫–∏–µ –∏–º–µ–Ω–Ω–æ —Ç–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞—à–ª–∏—Å—å –∏ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –ø–æ–∏—Å–∫ —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–∏—Ö.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### 1. RPA Service (`rpa-service/main.py`)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `/search/products`:**
```python
# –í–æ–∑–≤—Ä–∞—â–∞–µ–º–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
{
    "success": true,
    "data": {
        "results_found": 4,
        "results_saved": 4,
        "failed_products": [5]  # NEW: —Å–ø–∏—Å–æ–∫ order_item_id –±–µ–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    }
}
```

**–õ–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è failed_products:**
```python
searched_item_ids = {product['order_item_id'] for product in request.products}
found_item_ids = {result.order_item_id for result in product_search_results}
failed_products = list(searched_item_ids - found_item_ids)
```

### 2. Order Service (`order-service/main.py`)

#### –û—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫ (_search_products_in_batches)

**–°—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö:**
- `product_retry_counts = {(lsd_id, order_item_id): retry_count}` - —Å—á–µ—Ç—á–∏–∫ –ø–æ–ø—ã—Ç–æ–∫ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–∞–∂–¥–æ–º –õ–°–î
- `retry_queue = [(lsd, failed_product_ids), ...]` - –æ—á–µ—Ä–µ–¥—å –Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫

**–ü—Ä–æ—Ü–µ—Å—Å:**

1. **–ü–µ—Ä–≤–∏—á–Ω—ã–π –ø–æ–∏—Å–∫:**
   - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—Å–µ –õ–°–î –±–∞—Ç—á–∞–º–∏
   - –ü–æ–ª—É—á–∞–µ–º `(lsd, stocks_count, failed_product_ids)` –æ—Ç –∫–∞–∂–¥–æ–≥–æ –õ–°–î
   - –î–ª—è –∫–∞–∂–¥–æ–≥–æ failed —Ç–æ–≤–∞—Ä–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—á–µ—Ç—á–∏–∫ –ø–æ–ø—ã—Ç–æ–∫
   - –ï—Å–ª–∏ –ø–æ–ø—ã—Ç–æ–∫ < 3 ‚Üí –¥–æ–±–∞–≤–ª—è–µ–º –≤ retry_queue

2. **Retry –ø—Ä–æ—Ü–µ—Å—Å:**
   - –ë–µ—Ä–µ–º –±–∞—Ç—á–∏ –∏–∑ retry_queue
   - –í—ã–∑—ã–≤–∞–µ–º `_process_retry_batch` —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —Ç–æ–≤–∞—Ä–∞–º–∏
   - –ü–æ–≤—Ç–æ—Ä—è–µ–º –ø–æ–∏—Å–∫ —Ç–æ–ª—å–∫–æ –¥–ª—è failed —Ç–æ–≤–∞—Ä–æ–≤
   - –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä —Å–Ω–æ–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Üí –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É–µ–º —Å—á–µ—Ç—á–∏–∫
   - –ü–æ—Å–ª–µ 3 –ø–æ–ø—ã—Ç–æ–∫ ‚Üí –ø—Ä–µ–∫—Ä–∞—â–∞–µ–º retry –¥–ª—è —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞

#### –í–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–π

**_process_lsd_batch:**
```python
-> List[tuple[Dict[str, Any], int, List[int]]]
# (lsd, stocks_count, failed_product_ids)
```

**_search_products_in_lsd_isolated:**
```python
-> tuple[int, List[int]]
# (stocks_count, failed_product_ids)
```

**_search_products_in_lsd:**
```python
-> tuple[int, List[int]]
# (stocks_count, failed_product_ids)
```

**_process_retry_batch:**
```python
-> List[tuple[Dict[str, Any], int, List[int]]]
# (lsd, stocks_count, still_failed_ids)
```

## –ü—Ä–∏–º–µ—Ä —Ä–∞–±–æ—Ç—ã

### –°—Ü–µ–Ω–∞—Ä–∏–π: 5 —Ç–æ–≤–∞—Ä–æ–≤, 1 –Ω–µ –Ω–∞–π–¥–µ–Ω

**–ü–µ—Ä–≤—ã–π –ø–æ–∏—Å–∫:**
```
Order Items: [1, 2, 3, 4, 5]
–°–∞–º–æ–∫–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç: found=[1,2,3,4], failed=[5]
```

**–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```
‚úÖ –°–∞–º–æ–∫–∞—Ç: 4 stocks found
‚ö†Ô∏è –°–∞–º–æ–∫–∞—Ç: 1 products not found
  üîÅ Product 5: retry 1/3
```

**Retry –ø–æ–ø—ã—Ç–∫–∞ 1:**
```
Retry queue: [(–°–∞–º–æ–∫–∞—Ç, [5])]
–ò—â–µ–º —Ç–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä 5 –≤ –°–∞–º–æ–∫–∞—Ç–µ
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç retry:**
```
–ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω:
  ‚úÖ –°–∞–º–æ–∫–∞—Ç (retry): 1 stocks found
  
–ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω:
  ‚ö†Ô∏è –°–∞–º–æ–∫–∞—Ç (retry): 1 still not found
  üîÅ Product 5: retry 2/3
```

**–ü–æ—Å–ª–µ 3 –ø–æ–ø—ã—Ç–æ–∫:**
```
‚ùå Product 5: max retries exceeded
(–∑–∞–ø–∏—Å—å –≤ lsd_stocks –ù–ï —Å–æ–∑–¥–∞–µ—Ç—Å—è)
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **–¢–æ—á–Ω–æ—Å—Ç—å:** Retry —Ç–æ–ª—å–∫–æ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –Ω–µ–Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
2. **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:** –ù–µ —Ç—Ä–∞—Ç–∏–º –≤—Ä–µ–º—è –Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ —É–∂–µ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
3. **–ö–æ–Ω—Ç—Ä–æ–ª—å:** –û—Ç–¥–µ–ª—å–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ –ø–æ–ø—ã—Ç–æ–∫ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–∞–∂–¥–æ–º –õ–°–î
4. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ü–æ–Ω—è—Ç–Ω–æ –∫–∞–∫–æ–π –∏–º–µ–Ω–Ω–æ —Ç–æ–≤–∞—Ä –Ω–∞ –∫–∞–∫–æ–π –ø–æ–ø—ã—Ç–∫–µ

## –ù–∞—Å—Ç—Ä–æ–π–∫–∏

`config/settings.py`:
```python
max_concurrent_browsers: int = 3  # –†–∞–∑–º–µ—Ä –±–∞—Ç—á–∞ –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
```

–ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ –≤ –∫–æ–¥–µ:
```python
max_retries = 3  # –ú–∞–∫—Å–∏–º—É–º 3 –ø–æ–ø—ã—Ç–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
```

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

- –ü—Ä–∏ –æ—à–∏–±–∫–µ RPA ‚Üí –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ –±–∞—Ç—á–∞ —Å—á–∏—Ç–∞—é—Ç—Å—è failed
- –ü—Ä–∏ –æ—à–∏–±–∫–µ –≤ `_search_products_in_lsd_isolated` ‚Üí –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –±–∞—Ç—á–∞ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ failed_products
- –ü—Ä–∏ –æ—à–∏–±–∫–µ –≤ `_process_lsd_batch` ‚Üí –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –∫–∞–∫ failed
- –¢–æ–≤–∞—Ä—ã –±–µ–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ù–ï —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `lsd_stocks` (–Ω–µ—Ç –∑–∞–ø–∏—Å–∏ = –Ω–µ –Ω–∞–π–¥–µ–Ω)

## –õ–æ–≥–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

### –ü–µ—Ä–≤–∏—á–Ω—ã–π –ø–æ–∏—Å–∫
```
üöÄ Starting batched parallel search: 2 LSDs, batch size=3
üì¶ Created 1 batches of LSDs

üîÑ Processing batch 1/1: 2 LSDs
  ‚úÖ –°–∞–º–æ–∫–∞—Ç: 4 stocks found
  ‚ö†Ô∏è –°–∞–º–æ–∫–∞—Ç: 1 products not found
    üîÅ Product 5: retry 1/3
  ‚úÖ –û–∑–æ–Ω: 5 stocks found
```

### Retry –ø—Ä–æ—Ü–µ—Å—Å
```
üîÅ Processing retry queue: 1 LSD-product combinations
üîÑ Retry batch 1/1: 1 combinations
  ‚úÖ –°–∞–º–æ–∫–∞—Ç (retry): 1 stocks found
```

### –ú–∞–∫—Å–∏–º—É–º –ø–æ–ø—ã—Ç–æ–∫
```
  ‚ö†Ô∏è –°–∞–º–æ–∫–∞—Ç: 1 products not found
    üîÅ Product 5: retry 2/3
  ‚ö†Ô∏è –°–∞–º–æ–∫–∞—Ç: 1 products not found
    üîÅ Product 5: retry 3/3
  ‚ö†Ô∏è –°–∞–º–æ–∫–∞—Ç: 1 products not found
    ‚ùå Product 5: max retries exceeded
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –í—Å–µ —Ç–æ–≤–∞—Ä—ã –Ω–∞–π–¥–µ–Ω—ã —Å –ø–µ—Ä–≤–æ–≥–æ —Ä–∞–∑–∞
```
–í—Ö–æ–¥: 5 —Ç–æ–≤–∞—Ä–æ–≤, –≤—Å–µ –Ω–∞–π–¥–µ–Ω—ã
–†–µ–∑—É–ª—å—Ç–∞—Ç: 5 –∑–∞–ø–∏—Å–µ–π –≤ lsd_stocks, retry queue –ø—É—Å—Ç
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –û–¥–∏–Ω —Ç–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω, –Ω–∞–π–¥–µ–Ω —Å retry
```
–í—Ö–æ–¥: 5 —Ç–æ–≤–∞—Ä–æ–≤, 4 –Ω–∞–π–¥–µ–Ω—ã, 1 –Ω–µ –Ω–∞–π–¥–µ–Ω
–ü–æ–ø—ã—Ç–∫–∞ 1: —Ç–æ–≤–∞—Ä 5 –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Üí retry
–ü–æ–ø—ã—Ç–∫–∞ 2: —Ç–æ–≤–∞—Ä 5 –Ω–∞–π–¥–µ–Ω ‚Üí 5 –∑–∞–ø–∏—Å–µ–π –≤ lsd_stocks
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ—Å–ª–µ 3 –ø–æ–ø—ã—Ç–æ–∫
```
–í—Ö–æ–¥: 5 —Ç–æ–≤–∞—Ä–æ–≤, 4 –Ω–∞–π–¥–µ–Ω—ã, 1 –Ω–µ –Ω–∞–π–¥–µ–Ω
–ü–æ–ø—ã—Ç–∫–∏ 1-3: —Ç–æ–≤–∞—Ä 5 –Ω–µ –Ω–∞–π–¥–µ–Ω
–†–µ–∑—É–ª—å—Ç–∞—Ç: 4 –∑–∞–ø–∏—Å–∏ –≤ lsd_stocks, —Ç–æ–≤–∞—Ä 5 –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 4: –†–∞–∑–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã –≤ —Ä–∞–∑–Ω—ã—Ö –õ–°–î
```
–í—Ö–æ–¥: 5 —Ç–æ–≤–∞—Ä–æ–≤ –≤ –°–∞–º–æ–∫–∞—Ç–µ –∏ –û–∑–æ–Ω–µ
–°–∞–º–æ–∫–∞—Ç: —Ç–æ–≤–∞—Ä—ã [1,2,3,4] –Ω–∞–π–¥–µ–Ω—ã, [5] –Ω–µ –Ω–∞–π–¥–µ–Ω
–û–∑–æ–Ω: –≤—Å–µ —Ç–æ–≤–∞—Ä—ã [1,2,3,4,5] –Ω–∞–π–¥–µ–Ω—ã
Retry: –ø–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞ 5 —Ç–æ–ª—å–∫–æ –≤ –°–∞–º–æ–∫–∞—Ç–µ
```

## –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π retry:** –£–≤–µ–ª–∏—á–∏–≤–∞—Ç—å –ø–∞—É–∑—É –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏ (exponential backoff)
2. **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞:** –°–æ—Ö—Ä–∞–Ω—è—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ failed —Ç–æ–≤–∞—Ä–∞–º –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞
3. **–£–º–Ω—ã–π retry:** –ò–∑–º–µ–Ω—è—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–∫–∞—Ö
4. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:** –ò–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ —Ç–æ–≤–∞—Ä–∞—Ö, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫
