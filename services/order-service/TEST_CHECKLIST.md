# –ß–µ–∫-–ª–∏—Å—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ delivery_cost_model –≤ PDF

**–î–∞—Ç–∞:** 2025-10-10  
**–ó–∞–¥–∞—á–∞:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ PDF-–æ—Ç—á—ë—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ –¥–æ—Å—Ç–∞–≤–∫–µ

---

## üìã –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞

- [ ] –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã:
  - [ ] `services/order-service/sql/get_mono_baskets.sql`
  - [ ] `services/order-service/pdf_generator.py`
- [ ] –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å order-service (–µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω)

---

## üß™ –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ SQL-–∑–∞–ø—Ä–æ—Å–æ–≤

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞:
```bash
cd /Users/ss/GenAI/korzinka/services/order-service
python test_delivery_cost_model.py
```

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
- [ ] ‚úÖ –ù–∞–π–¥–µ–Ω order_id —Å –¥–∞–Ω–Ω—ã–º–∏
- [ ] ‚úÖ –î–ª—è –º–æ–Ω–æ–∫–æ—Ä–∑–∏–Ω: "delivery_cost_model –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
- [ ] ‚úÖ –î–ª—è –ª—É—á—à–µ–π –∫–æ—Ä–∑–∏–Ω—ã: "delivery_cost_model –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
- [ ] ‚úÖ –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É lsd_stocks –∏ basket_combinations

### –ï—Å–ª–∏ —Ç–µ—Å—Ç –Ω–µ –ø—Ä–æ–π–¥–µ–Ω:
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ RPA: `/Users/ss/GenAI/korzinka/logs/rpa_service.log`
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ RPA –∏–∑–≤–ª—ë–∫ delivery_cost_model –ø—Ä–∏ –ø–æ–∏—Å–∫–µ
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å SQL –≤ –ë–î –≤—Ä—É—á–Ω—É—é (—Å–º. –Ω–∏–∂–µ)

---

## üß™ –¢–µ—Å—Ç 2: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞

### –®–∞–≥–∏:
1. [ ] –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑ –≤ Telegram –≥—Ä—É–ø–ø–µ
2. [ ] –î–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞ (—Å—Ç–∞—Ç—É—Å VALIDATING ‚Üí OPTIMIZED)
3. [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ order-service –Ω–∞ –Ω–∞–ª–∏—á–∏–µ:
   ```
   üìä [Best Basket] Using delivery_cost_model from basket_combinations
   üìä [Mono Basket] Using delivery_cost_model from basket_combinations
   ```

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–æ–≥–æ–≤:
```bash
# –ü–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å—Ç—Ä–æ–∫ –ª–æ–≥–æ–≤ order-service
tail -100 /Users/ss/GenAI/korzinka/logs/order_service.log | grep "delivery_cost_model"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ WARNING –ª–æ–≥–æ–≤
tail -100 /Users/ss/GenAI/korzinka/logs/order_service.log | grep "‚ö†Ô∏è"
```

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
- [ ] –ù–µ—Ç WARNING: "No delivery_cost_model found"
- [ ] –ï—Å—Ç—å INFO: "Using delivery_cost_model from basket_combinations"

---

## üß™ –¢–µ—Å—Ç 3: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ PDF

### –®–∞–≥–∏:
1. [ ] –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å PDF –¥–ª—è –∑–∞–∫–∞–∑–∞
2. [ ] –û—Ç–∫—Ä—ã—Ç—å PDF –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–¥–µ–ª–∞ "–õ—É—á—à–∞—è –∫–æ—Ä–∑–∏–Ω–∞":
- [ ] –ï—Å—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫: "**–£—Å–ª–æ–≤–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏ –ø–æ —Å–µ—Ä–≤–∏—Å–∞–º:**"
- [ ] –î–ª—è –∫–∞–∂–¥–æ–≥–æ LSD –ø–æ–∫–∞–∑–∞–Ω—ã —É—Å–ª–æ–≤–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏
- [ ] –§–æ—Ä–º–∞—Ç —É—Å–ª–æ–≤–∏–π:
  ```
  –ù–∞–∑–≤–∞–Ω–∏–µ LSD:
  ‚Ä¢ –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞: X —Ä—É–±
  ‚Ä¢ –î–∏–∞–ø–∞–∑–æ–Ω—ã –¥–æ—Å—Ç–∞–≤–∫–∏:
    - –û—Ç X –¥–æ Y —Ä—É–±: Z —Ä—É–±
    - –û—Ç Y —Ä—É–±: –±–µ—Å–ø–ª–∞—Ç–Ω–æ
  ```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–¥–µ–ª–∞ "–ú–æ–Ω–æ–∫–æ—Ä–∑–∏–Ω—ã":
- [ ] –î–ª—è –∫–∞–∂–¥–æ–π –º–æ–Ω–æ–∫–æ—Ä–∑–∏–Ω—ã –µ—Å—Ç—å –±–ª–æ–∫ "**–£—Å–ª–æ–≤–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏:**"
- [ ] –£—Å–ª–æ–≤–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –§–æ—Ä–º–∞—Ç –∞–Ω–∞–ª–æ–≥–∏—á–µ–Ω –ª—É—á—à–µ–π –∫–æ—Ä–∑–∏–Ω–µ

### –ï—Å–ª–∏ —É—Å–ª–æ–≤–∏—è –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è:
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ WARNING: "No delivery_cost_model"
- –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç (–¢–µ—Å—Ç 1)
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –ë–î –≤—Ä—É—á–Ω—É—é (—Å–º. –Ω–∏–∂–µ)

---

## üß™ –¢–µ—Å—Ç 4: –†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ë–î

### –ü–æ–ª—É—á–∏—Ç—å order_id –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–∫–∞–∑–∞:
```sql
SELECT id, status, created_at 
FROM orders 
ORDER BY created_at DESC 
LIMIT 1;
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å delivery_cost_model –≤ basket_combinations:
```sql
SELECT 
    bc.basket_id,
    lc.display_name,
    bc.delivery_cost_model
FROM basket_combinations bc
JOIN lsd_configs lc ON lc.id = bc.lsd_config_id
WHERE bc.order_id = <ORDER_ID>
  AND bc.delivery_cost_model IS NOT NULL
LIMIT 5;
```

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
- [ ] –ï—Å—Ç—å –∑–∞–ø–∏—Å–∏ —Å –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º delivery_cost_model
- [ ] JSON —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–ª—é—á "delivery_cost"
- [ ] –í–Ω—É—Ç—Ä–∏ "delivery_cost" –µ—Å—Ç—å –º–∞—Å—Å–∏–≤ —Å –æ–±—ä–µ–∫—Ç–∞–º–∏ (min, max, fee, label)

### –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç:
```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å lsd_stocks
SELECT 
    ls.id,
    lc.display_name,
    ls.delivery_cost_model
FROM lsd_stocks ls
JOIN lsd_configs lc ON lc.id = ls.lsd_config_id
WHERE ls.order_id = <ORDER_ID>
  AND ls.delivery_cost_model IS NOT NULL
LIMIT 5;
```

- [ ] –ï—Å–ª–∏ –≤ lsd_stocks –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ, –Ω–æ –≤ basket_combinations –Ω–µ—Ç:
  - **–ü—Ä–æ–±–ª–µ–º–∞:** –î–∞–Ω–Ω—ã–µ –Ω–µ –∫–æ–ø–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ—Ä–∑–∏–Ω—ã
  - **–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥ –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä–∞ –∫–æ—Ä–∑–∏–Ω

- [ ] –ï—Å–ª–∏ –≤ lsd_stocks –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö:
  - **–ü—Ä–æ–±–ª–µ–º–∞:** RPA –Ω–µ –∏–∑–≤–ª–µ–∫–∞–µ—Ç delivery_cost_model
  - **–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å RPA –∫–æ–Ω—Ñ–∏–≥ –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ LSD

---

## üß™ –¢–µ—Å—Ç 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö LSD

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å PDF –¥–ª—è –∑–∞–∫–∞–∑–æ–≤, –≤–∫–ª—é—á–∞—é—â–∏—Ö:
- [ ] –Ø–Ω–¥–µ–∫—Å –õ–∞–≤–∫–∞
- [ ] –°–±–µ—Ä–ú–∞—Ä–∫–µ—Ç
- [ ] –°–∞–º–æ–∫–∞—Ç
- [ ] –î—Ä—É–≥–∏–µ LSD (–µ—Å–ª–∏ –µ—Å—Ç—å)

–î–ª—è –∫–∞–∂–¥–æ–≥–æ LSD:
- [ ] –£—Å–ª–æ–≤–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏ –ø–æ–∫–∞–∑–∞–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞ —É–∫–∞–∑–∞–Ω–∞
- [ ] –î–∏–∞–ø–∞–∑–æ–Ω—ã –¥–æ—Å—Ç–∞–≤–∫–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–º –Ω–∞ —Å–∞–π—Ç–µ LSD

---

## üß™ –¢–µ—Å—Ç 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ edge cases

### –°–ª—É—á–∞–π 1: –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–æ—Ä–∑–∏–Ω–∞ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ LSD
- [ ] PDF –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É—Å–ª–æ–≤–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏ –¥–ª—è –ö–ê–ñ–î–û–ì–û LSD –æ—Ç–¥–µ–ª—å–Ω–æ
- [ ] –£—Å–ª–æ–≤–∏—è –Ω–µ –¥—É–±–ª–∏—Ä—É—é—Ç—Å—è

### –°–ª—É—á–∞–π 2: –ú–æ–Ω–æ–∫–æ—Ä–∑–∏–Ω–∞
- [ ] –£—Å–ª–æ–≤–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏ –ø–æ–∫–∞–∑–∞–Ω—ã —Ç–æ–ª—å–∫–æ –¥–ª—è –æ–¥–Ω–æ–≥–æ LSD
- [ ] –ù–µ—Ç –ø—É—Å—Ç—ã—Ö –±–ª–æ–∫–æ–≤

### –°–ª—É—á–∞–π 3: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ delivery_cost_model
- [ ] PDF –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç: "–î–∞–Ω–Ω—ã–µ –æ –¥–æ—Å—Ç–∞–≤–∫–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç"
- [ ] –í –ª–æ–≥–∞—Ö –µ—Å—Ç—å WARNING

---

## ‚úÖ –ò—Ç–æ–≥–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

–ü–æ—Å–ª–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤:
- [ ] PDF —Å–æ–¥–µ—Ä–∂–∏—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏
- [ ] –õ–æ–≥–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∞—Ç WARNING –æ missing delivery_cost_model
- [ ] –î–∞–Ω–Ω—ã–µ –≤ PDF —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å –¥–∞–Ω–Ω—ã–º–∏ –Ω–∞ —Å–∞–π—Ç–∞—Ö LSD
- [ ] –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ

---

## üêõ –û—Ç–ª–∞–¥–∫–∞ –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞: "No delivery_cost_model found"

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å RPA –ª–æ–≥–∏:
   ```bash
   tail -200 /Users/ss/GenAI/korzinka/logs/rpa_service.log | grep "delivery_ranges"
   ```
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å RPA –∫–æ–Ω—Ñ–∏–≥ –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ LSD:
   ```sql
   SELECT id, display_name, search_config_rpa->>'delivery_ranges' 
   FROM lsd_configs 
   WHERE display_name = '<LSD_NAME>';
   ```
3. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `delivery_ranges.enabled = true`

**–†–µ—à–µ–Ω–∏–µ:**
- –û–±–Ω–æ–≤–∏—Ç—å RPA –∫–æ–Ω—Ñ–∏–≥
- –ò–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å fallback –≤ –∫–æ–¥ (—É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ –≤ lsd_stocks)

---

### –ü—Ä–æ–±–ª–µ–º–∞: PDF –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É—Å–ª–æ–≤–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –º–µ—Ç–æ–¥ `_create_section0_best_basket` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ DEBUG:
   ```bash
   tail -100 /Users/ss/GenAI/korzinka/logs/order_service.log | grep "Parse Delivery"
   ```

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥ –≤ pdf_generator.py
- –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –±–ª–æ–∫ —É—Å–ª–æ–≤–∏–π –¥–æ—Å—Ç–∞–≤–∫–∏ –Ω–µ –±—ã–ª —É–¥–∞–ª—ë–Ω

---

## üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:
- –õ–æ–≥–∏ RPA: `/Users/ss/GenAI/korzinka/logs/rpa_service.log`
- –õ–æ–≥–∏ Order: `/Users/ss/GenAI/korzinka/logs/order_service.log`
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: `PDF_DELIVERY_FIX_2025-10-10.md`
