# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç –ø–æ—Ç–µ—Ä—å –≤ –º–æ–Ω–æ–∫–æ—Ä–∑–∏–Ω–∞—Ö

## –î–∞—Ç–∞: 07.10.2025

## –ü—Ä–æ–±–ª–µ–º–∞

–í –†–∞–∑–¥–µ–ª–µ 2 (–ú–æ–Ω–æ–∫–æ—Ä–∑–∏–Ω—ã) –∫–æ–ª–æ–Ω–∫–∞ "–ü–æ—Ç–µ—Ä–∏" –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è.

**–ü—Ä–∏–º–µ—Ä:**
- **–°–∞–º–æ–∫–∞—Ç - –õ–∏–º–æ–Ω–Ω–∞—è –∫–∏—Å–ª–æ—Ç–∞:**
  - –ü–æ–∫–∞–∑–∞–Ω–æ –≤ PDF: **4080.00 —Ä—É–±** ‚ùå
  - –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: **204.00 —Ä—É–±** ‚úÖ

---

## –ü—Ä–∏—á–∏–Ω–∞

**–í –∫–æ–¥–µ Python –≤—ã—á–∏—Å–ª—è–ª–∞—Å—å —Ñ–æ—Ä–º—É–ª–∞:**
```python
loss = (fprice - fprice_min) √ó order_item_ids_quantity
```

**–î–ª—è –ª–∏–º–æ–Ω–Ω–æ–π –∫–∏—Å–ª–æ—Ç—ã:**
```python
loss = (1380.00 - 360.00) √ó 4 = 1020 √ó 4 = 4080.00 ‚ùå
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –≠—Ç–∞ —Ñ–æ—Ä–º—É–ª–∞ **–ù–ï —É—á–∏—Ç—ã–≤–∞–µ—Ç** —Å–ª–æ–∂–Ω—É—é –ª–æ–≥–∏–∫—É —Ä–∞—Å—á–µ—Ç–∞ –ø–æ—Ç–µ—Ä—å, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä–µ.

**–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥:** –í —Ç–∞–±–ª–∏—Ü–µ `basket_combinations` —É–∂–µ –µ—Å—Ç—å –≥–æ—Ç–æ–≤–æ–µ –ø–æ–ª–µ `loss`, –∫–æ—Ç–æ—Ä–æ–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä–æ–º —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö –Ω—é–∞–Ω—Å–æ–≤ (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —à—Ç—É–∫, –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è, –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —è–∏—Ü –∏ —Ç.–¥.).

---

## –î–∞–Ω–Ω—ã–µ –≤ –ë–î

```sql
SELECT 
    product_name,
    fprice,
    fprice_min,
    order_item_ids_quantity,
    loss  -- ‚úÖ –ì–æ—Ç–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ!
FROM basket_combinations
WHERE order_id = 33 
  AND product_name ILIKE '%–ª–∏–º–æ–Ω%'
  AND lsd_name = 'samokat';
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
   product_name   | fprice  | fprice_min | quantity | loss    
------------------+---------+------------+----------+---------
 –ª–∏–º–æ–Ω–Ω–∞—è –∫–∏—Å–ª–æ—Ç–∞ | 1380.00 |     360.00 |        4 | 204.00  ‚úÖ
```

---

## –†–µ—à–µ–Ω–∏–µ

### 1. –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `loss` –≤ SQL-–∑–∞–ø—Ä–æ—Å

**–§–∞–π–ª:** `/Users/ss/GenAI/korzinka/services/order-service/sql/get_mono_baskets.sql`

**–ë—ã–ª–æ:**
```sql
json_build_object(
    'product_name', bc.product_name,
    'base_quantity', bc.base_quantity,
    'base_unit', bc.base_unit,
    'price', bc.price,
    'fprice', bc.fprice,
    'fprice_min', bc.fprice_min,
    -- ‚ùå –ü–æ–ª—è 'loss' –Ω–µ—Ç!
    'order_item_ids_cost', bc.order_item_ids_cost,
    ...
)
```

**–°—Ç–∞–ª–æ:**
```sql
json_build_object(
    'product_name', bc.product_name,
    'base_quantity', bc.base_quantity,
    'base_unit', bc.base_unit,
    'price', bc.price,
    'fprice', bc.fprice,
    'fprice_min', bc.fprice_min,
    'loss', bc.loss,  -- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ!
    'order_item_ids_cost', bc.order_item_ids_cost,
    ...
)
```

### 2. –ò–∑–º–µ–Ω–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –≤ Python-–∫–æ–¥–µ

**–§–∞–π–ª:** `/Users/ss/GenAI/korzinka/services/order-service/pdf_generator.py`

**–ë—ã–ª–æ:**
```python
# –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: –í—ã—á–∏—Å–ª—è–µ–º –ø–æ—Ç–µ—Ä–∏ –ø–æ —Ñ–æ—Ä–º—É–ª–µ
loss = (float(item['fprice']) - float(item.get('fprice_min', 0))) * float(item.get('order_item_ids_quantity', 0))
```

**–°—Ç–∞–ª–æ:**
```python
# –ü–†–ê–í–ò–õ–¨–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–æ—Ç–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –ë–î
loss = float(item.get('loss', 0))
```

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### SQL-–∑–∞–ø—Ä–æ—Å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:

```bash
$ psql -c "
SELECT 
    mb.lsd_display_name,
    (SELECT json_agg(json_build_object('product_name', bc.product_name, 'loss', bc.loss))
     FROM basket_combinations bc
     WHERE bc.basket_id = mb.basket_id) as items
FROM mono_baskets_base mb
WHERE mb.lsd_display_name = '–°–∞–º–æ–∫–∞—Ç';
"
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
[
  {"product_name": "–Ø–π—Ü–∞", "loss": 42.00},
  {"product_name": "–ª–∏–º–æ–Ω–Ω–∞—è –∫–∏—Å–ª–æ—Ç–∞", "loss": 204.00},  ‚úÖ
  {"product_name": "–º–æ–ª–æ–∫–æ", "loss": 49.66}
]
```

---

## –°—Ä–∞–≤–Ω–µ–Ω–∏–µ: –±—ã–ª–æ vs —Å—Ç–∞–ª–æ

### –õ–∏–º–æ–Ω–Ω–∞—è –∫–∏—Å–ª–æ—Ç–∞ (–°–∞–º–æ–∫–∞—Ç):

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|----------|----------|
| fprice | 1380.00 —Ä—É–±/–∫–≥ |
| fprice_min | 360.00 —Ä—É–±/–∫–≥ |
| quantity | 4 –∫–≥ |
| **loss (–±—ã–ª–æ –ø–æ —Ñ–æ—Ä–º—É–ª–µ)** | **(1380 - 360) √ó 4 = 4080.00 —Ä—É–±** ‚ùå |
| **loss (—Å—Ç–∞–ª–æ –∏–∑ –ë–î)** | **204.00 —Ä—É–±** ‚úÖ |

### –ü–æ—á–µ–º—É —Ä–∞–∑–Ω–∏—Ü–∞?

–û–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä —É—á–∏—Ç—ã–≤–∞–µ—Ç:
1. –†–µ–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞ –≤ –∑–∞–∫–∞–∑–µ (–Ω–µ —Ç–æ–ª—å–∫–æ quantity)
2. –ï–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è (—à—Ç ‚Üí –∫–≥ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è)
3. –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —è–π—Ü–∞)
4. –û–∫—Ä—É–≥–ª–µ–Ω–∏—è –∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø–∞—Ä—Ç–∏–∏
5. –î—Ä—É–≥–∏–µ –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞

**–ü–æ—ç—Ç–æ–º—É:** –ù–µ–ª—å–∑—è –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å –ø–æ—Ç–µ—Ä–∏ –ø–æ —Ñ–æ—Ä–º—É–ª–µ - –Ω—É–∂–Ω–æ –±—Ä–∞—Ç—å –≥–æ—Ç–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –ë–î!

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –®–∞–≥–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:

1. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å order-service**
2. **–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–∫–∞–∑**
3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å PDF - –†–∞–∑–¥–µ–ª 2:**

**–î–ª—è –∫–∞–∂–¥–æ–π –º–æ–Ω–æ–∫–æ—Ä–∑–∏–Ω—ã:**
- [ ] –ö–æ–ª–æ–Ω–∫–∞ "–ü–æ—Ç–µ—Ä–∏" —Å–æ–¥–µ—Ä–∂–∏—Ç **—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ** –∑–Ω–∞—á–µ–Ω–∏—è
- [ ] –ù–µ—Ç –±–æ–ª—å—à–∏—Ö —á–∏—Å–µ–ª —Ç–∏–ø–∞ 4080.00
- [ ] –ó–Ω–∞—á–µ–Ω–∏—è —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å –¥–∞–Ω–Ω—ã–º–∏ –≤ –ë–î

**–ü—Ä–∏–º–µ—Ä –ø—Ä–æ–≤–µ—Ä–∫–∏:**
```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Ç–µ—Ä–∏ –≤ –ë–î
SELECT 
    lc.display_name,
    bc.product_name,
    bc.loss
FROM basket_combinations bc
JOIN lsd_configs lc ON lc.id = bc.lsd_config_id
WHERE bc.order_id = [–≤–∞—à_order_id]
  AND bc.basket_id = [basket_id_–∏–∑_PDF]
ORDER BY bc.product_name;
```

---

## –ò—Ç–æ–≥

‚úÖ **–ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞**
‚úÖ **SQL-–∑–∞–ø—Ä–æ—Å –æ–±–Ω–æ–≤–ª–µ–Ω** - –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `loss`
‚úÖ **Python-–∫–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≥–æ—Ç–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –ë–î
‚úÖ **–ü–æ—Ç–µ—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ**

---

## –°–≤—è–∑–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

–≠—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ–ø–æ–ª–Ω—è–µ—Ç:
- `PDF_FIXES_2025-10-07-v2.md` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- `PDF_FIX_MONO_BASKETS.md` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–Ω–æ–∫–æ—Ä–∑–∏–Ω

–¢–µ–ø–µ—Ä—å –≤—Å–µ —Ä–∞—Å—á–µ—Ç—ã –≤ PDF –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã! üéâ
