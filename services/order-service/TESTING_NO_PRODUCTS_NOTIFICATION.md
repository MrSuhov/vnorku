# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è "–ü–æ–¥—Ö–æ–¥—è—â–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤ –Ω–µ –Ω–∞—à–ª–æ—Å—å"

## –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

1. Order Service –∑–∞–ø—É—â–µ–Ω
2. Telegram –±–æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
3. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç—É–ø–Ω–∞

## –°—Ü–µ–Ω–∞—Ä–∏–π —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π (—Ç–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã)

1. –°–æ–∑–¥–∞–π—Ç–µ –∑–∞–∫–∞–∑ —Å —Ç–æ–≤–∞—Ä–∞–º–∏, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –Ω–∏ –≤ –æ–¥–Ω–æ–º –õ–°–î
2. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –∑–∞–∫–∞–∑
3. –î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞ (–ø–æ–∏—Å–∫–∞ –≤ –õ–°–î)
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ:
   - –í `optimizer.log` –ø–æ—è–≤–∏–ª–∞—Å—å —Å—Ç—Ä–æ–∫–∞: `WARNING –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ fprice_optimizer –¥–ª—è –∑–∞–∫–∞–∑–∞ X`
   - –í `order-service.log` –ø–æ—è–≤–∏–ª–∞—Å—å —Å—Ç—Ä–æ–∫–∞: `‚ö†Ô∏è Order X: No products found in fprice_optimizer`
   - –í `order-service.log` –ø–æ—è–≤–∏–ª–∞—Å—å —Å—Ç—Ä–æ–∫–∞: `‚ùå Order X: OPTIMIZING ‚Üí FAILED (no products found)`
   - –í `order-service.log` –ø–æ—è–≤–∏–ª–∞—Å—å —Å—Ç—Ä–æ–∫–∞: `üì§ Sending failure notification to user for order X`
   - –í Telegram –≥—Ä—É–ø–ø–µ –ø–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ: `‚ùå –ü–æ–¥—Ö–æ–¥—è—â–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤ –Ω–µ –Ω–∞—à–ª–æ—Å—å`

### –í–∞—Ä–∏–∞–Ω—Ç 2: –°–∏–º—É–ª—è—Ü–∏—è —á–µ—Ä–µ–∑ –ë–î (–¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)

#### –®–∞–≥ 1: –°–æ–∑–¥–∞–π—Ç–µ –∑–∞–∫–∞–∑ —Å —Å—Ç–∞—Ç—É—Å–æ–º ANALYSIS_COMPLETE –Ω–æ –ë–ï–ó –¥–∞–Ω–Ω—ã—Ö –≤ fprice_optimizer

```sql
-- 1. –ù–∞–π–¥–∏—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∑–∞–∫–∞–∑
SELECT id, status FROM orders WHERE id = <order_id>;

-- 2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ fprice_optimizer –ø—É—Å—Ç–∞ –¥–ª—è —ç—Ç–æ–≥–æ –∑–∞–∫–∞–∑–∞
SELECT COUNT(*) FROM fprice_optimizer WHERE order_id = <order_id>;
-- –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 0

-- 3. –ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ –∑–∞–∫–∞–∑ –≤ ANALYSIS_COMPLETE
UPDATE orders 
SET status = 'ANALYSIS_COMPLETE',
    analysis_completed_at = NOW()
WHERE id = <order_id>;
```

#### –®–∞–≥ 2: –î–æ–∂–¥–∏—Ç–µ—Å—å —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥. –í —Ç–µ—á–µ–Ω–∏–µ 10-20 —Å–µ–∫—É–Ω–¥ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏–∑–æ–π—Ç–∏:

1. Order Service –æ–±–Ω–∞—Ä—É–∂–∏—Ç –∑–∞–∫–∞–∑ –≤ ANALYSIS_COMPLETE
2. –ó–∞–ø—É—Å—Ç–∏—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é
3. –ü–æ–ª—É—á–∏—Ç —Å—Ç–∞—Ç—É—Å "no_data"
4. –û—Ç–ø—Ä–∞–≤–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

#### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç

```sql
-- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞
SELECT 
    id, 
    status, 
    error_details,
    results_sent_at
FROM orders 
WHERE id = <order_id>;

-- –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
-- status = 'FAILED'
-- error_details —Å–æ–¥–µ—Ä–∂–∏—Ç: {"error_type": "no_products_found", "user_message": "‚ùå –ü–æ–¥—Ö–æ–¥—è—â–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤ –Ω–µ –Ω–∞—à–ª–æ—Å—å", ...}
-- results_sent_at = <timestamp>

-- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
SELECT 
    id,
    order_id,
    message_text,
    response_status,
    created_at
FROM user_messages
WHERE order_id = <order_id>
ORDER BY created_at DESC
LIMIT 5;

-- –î–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç–µ–∫—Å—Ç–æ–º "‚ùå –ü–æ–¥—Ö–æ–¥—è—â–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤ –Ω–µ –Ω–∞—à–ª–æ—Å—å"
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤

### optimizer.log
```bash
tail -f /Users/ss/GenAI/korzinka/logs/optimizer.log | grep "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö"
```

–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:
```
2025-10-05 23:23:33 WARNING –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ fprice_optimizer –¥–ª—è –∑–∞–∫–∞–∑–∞ 30
```

### order-service.log
```bash
tail -f /Users/ss/GenAI/korzinka/logs/order-service.log | grep -E "(No products found|FAILED notification|Sending failure)"
```

–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:
```
2025-10-05 23:23:34 WARNING ‚ö†Ô∏è Order 30: No products found in fprice_optimizer
2025-10-05 23:23:34 INFO ‚ùå Order 30: OPTIMIZING ‚Üí FAILED (no products found)
2025-10-05 23:23:34 ERROR ‚ùå Optimization failed for order 30
2025-10-05 23:23:34 ERROR    Error: no_products_found
2025-10-05 23:23:34 INFO üì§ Sending failure notification to user for order 30
2025-10-05 23:23:34 INFO ‚úÖ Telegram message sent to -1001234567890
2025-10-05 23:23:34 INFO üíæ Logged message to DB (message_id=123, order_id=30)
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ Telegram

1. –û—Ç–∫—Ä–æ–π—Ç–µ –≥—Ä—É–ø–ø—É, –≥–¥–µ –±—ã–ª —Å–æ–∑–¥–∞–Ω –∑–∞–∫–∞–∑
2. –ù–∞–π–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏—Å—Ö–æ–¥–Ω—ã–º —Å–ø–∏—Å–∫–æ–º —Ç–æ–≤–∞—Ä–æ–≤
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –±–æ—Ç –æ—Ç–≤–µ—Ç–∏–ª –Ω–∞ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–º: **"‚ùå –ü–æ–¥—Ö–æ–¥—è—â–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤ –Ω–µ –Ω–∞—à–ª–æ—Å—å"**

## –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–∏–ª–æ—Å—å

**–ü—Ä–∏–∑–Ω–∞–∫–∏:**
- –í –ª–æ–≥–∞—Ö –µ—Å—Ç—å `No products found`, –Ω–æ –Ω–µ—Ç `Sending failure notification`
- `results_sent_at = NULL` –≤ –ë–î

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `tg_group` –Ω–µ NULL –≤ —Ç–∞–±–ª–∏—Ü–µ `orders`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `telegram_message_id` –Ω–µ NULL
3. –î–æ–∂–¥–∏—Ç–µ—Å—å —Å–ª–µ–¥—É—é—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (10 —Å–µ–∫—É–Ω–¥)
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏

### –ü—Ä–æ–±–ª–µ–º–∞: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

**–ü—Ä–∏–∑–Ω–∞–∫–∏:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏–ª –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```sql
SELECT COUNT(*) 
FROM user_messages 
WHERE order_id = <order_id> 
  AND message_text LIKE '%–ü–æ–¥—Ö–æ–¥—è—â–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤ –Ω–µ –Ω–∞—à–ª–æ—Å—å%';
```

**–ü—Ä–∏—á–∏–Ω–∞:**
- –°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ `results_sent_at` –Ω–µ –æ–±–Ω–æ–≤–∏–ª–æ—Å—å –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏ –∫–æ–º–º–∏—Ç–∞ –≤ –ë–î
- –í—Ä—É—á–Ω—É—é –æ–±–Ω–æ–≤–∏—Ç–µ `results_sent_at`:
```sql
UPDATE orders SET results_sent_at = NOW() WHERE id = <order_id>;
```

### –ü—Ä–æ–±–ª–µ–º–∞: Telegram bot token –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω

**–ü—Ä–∏–∑–Ω–∞–∫–∏:**
- –í –ª–æ–≥–∞—Ö: `Failed to send Telegram message (status 401): Unauthorized`

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `.env` —Ñ–∞–π–ª –Ω–∞ –Ω–∞–ª–∏—á–∏–µ `TELEGRAM_BOT_TOKEN`
- –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ Order Service

## –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

```bash
# 1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ Order Service
cd /Users/ss/GenAI/korzinka
# ... –∫–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞ order-service

# 2. –í –¥—Ä—É–≥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ —Å–ª–µ–¥–∏—Ç–µ –∑–∞ –ª–æ–≥–∞–º–∏
tail -f logs/order-service.log logs/optimizer.log

# 3. –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–∫–∞–∑ —Å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ —Ç–æ–≤–∞—Ä–∞–º–∏
# (—á–µ—Ä–µ–∑ Telegram –±–æ—Ç –∏–ª–∏ API)

# 4. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ü–∏–∫–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ (~30-60 —Å–µ–∫—É–Ω–¥)

# 5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –ë–î
psql $DATABASE_URL -c "SELECT id, status, error_details, results_sent_at FROM orders WHERE id = <order_id>;"

# 6. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Telegram –≥—Ä—É–ø–ø—É –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
```

## –û–∂–∏–¥–∞–µ–º–æ–µ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏

- **–ê–Ω–∞–ª–∏–∑ –∑–∞–∫–∞–∑–∞**: 10-30 —Å–µ–∫—É–Ω–¥ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –õ–°–î)
- **–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ ANALYSIS_COMPLETE**: –¥–æ 10 —Å–µ–∫—É–Ω–¥ (—Ü–∏–∫–ª –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞)
- **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ no_data**: 1-2 —Å–µ–∫—É–Ω–¥—ã
- **–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**: 1-3 —Å–µ–∫—É–Ω–¥—ã

**–û–±—â–µ–µ –≤—Ä–µ–º—è**: 20-50 —Å–µ–∫—É–Ω–¥ –æ—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ –¥–æ –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.
