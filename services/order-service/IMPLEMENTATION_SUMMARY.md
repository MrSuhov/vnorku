# üìä –†–µ–∞–ª–∏–∑–∞—Ü–∏—è PDF-–æ—Ç—á–µ—Ç–æ–≤ –¥–ª—è Korzinka - –°–≤–æ–¥–∫–∞

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã

### 1. SQL-–∑–∞–ø—Ä–æ—Å—ã (–≠—Ç–∞–ø 1)
- ‚úÖ `get_min_prices.sql` - –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ —Ü–µ–Ω–∞–º–∏ (loss=0)
- ‚úÖ `get_mono_baskets.sql` - –ø–æ–ª—É—á–µ–Ω–∏–µ –º–æ–Ω–æ-–∫–æ—Ä–∑–∏–Ω —Å –¥–µ—Ç–∞–ª—è–º–∏

### 2. PDF-–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä (–≠—Ç–∞–ø 2)
- ‚úÖ –°–æ–∑–¥–∞–Ω `pdf_generator.py` —Å –∫–ª–∞—Å—Å–æ–º `OrderReportGenerator`
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–∏—Ä–∏–ª–ª–∏—Ü—ã (DejaVuSans —à—Ä–∏—Ñ—Ç—ã)
- ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å–µ—Ä–æ-–±–µ–ª–∞—è —Ü–≤–µ—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞
- ‚úÖ –°–æ–∑–¥–∞–Ω **–†–∞–∑–¥–µ–ª 1: –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã** —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏:
  - –¢–æ–≤–∞—Ä
  - –°–µ—Ä–≤–∏—Å
  - –õ—É—á—à–∞—è —Ü–µ–Ω–∞ (fprice)
  - –ï–¥. –∏–∑–º.
  - –ö–æ–ª-–≤–æ
  - –°—É–º–º–∞ –Ω–∞ –ø–æ–ª–∫–µ
  - –ö–æ–ª-–≤–æ –≤ –∑–∞–∫–∞–∑–µ
  - –ï–¥. –∏–∑–º. –≤ –∑–∞–∫–∞–∑–µ
  - –§–æ—Ä–º—É–ª–∞ —Ä–∞—Å—á—ë—Ç–∞ fprice
- ‚úÖ –°–æ–∑–¥–∞–Ω **–†–∞–∑–¥–µ–ª 2: –ú–æ–Ω–æ–∫–æ—Ä–∑–∏–Ω—ã** —Å:
  - –¢–∞–±–ª–∏—Ü–µ–π —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ LSD
  - –ò—Ç–æ–≥–∞–º–∏ (—Ç–æ–≤–∞—Ä—ã, —Ç–æ–ø–∞–ø, –¥–æ—Å—Ç–∞–≤–∫–∞, –ø–æ—Ç–µ—Ä–∏)
  - –£—Å–ª–æ–≤–∏—è–º–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ (–∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è, –º–∏–Ω–∏–º—É–º, –¥–∏–∞–ø–∞–∑–æ–Ω—ã)
- ‚úÖ –ê–ª—å–±–æ–º–Ω–∞—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è A4
- ‚úÖ –§—É–Ω–∫—Ü–∏—è `_create_fprice_calculation()` –¥–ª—è —Ñ–æ—Ä–º—É–ª

### 3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ main.py (–≠—Ç–∞–ø 3)
- ‚úÖ –°–æ–∑–¥–∞–Ω `telegram_document_sender.py` –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ PDF –≤ Telegram
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `process_optimized_orders()`:
  - –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–æ–ø-1 –∫–æ—Ä–∑–∏–Ω—ã —Ç–µ–∫—Å—Ç–æ–º
  - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ PDF-–æ—Ç—á–µ—Ç–∞
  - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –ë–î
- ‚úÖ –£–¥–∞–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–æ–ø-2 –∏ —Ç–æ–ø-3 –∫–æ—Ä–∑–∏–Ω —Ç–µ–∫—Å—Ç–æ–º

### 4. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ –º–æ–¥–µ–ª—å `UserMessage`:
  - `is_document` (Boolean)
  - `filename` (String)
  - `file_size` (Integer)
  - `message_text` —Ç–µ–ø–µ—Ä—å nullable
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è `add_document_fields_to_user_messages.sql`

### 5. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- ‚úÖ `PDF_README.md` - –ø–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- ‚úÖ `install_pdf_module.sh` - —Å–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏
- ‚úÖ `test_pdf_generation.py` - —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç
- ‚úÖ `requirements.txt` - –¥–æ–±–∞–≤–ª–µ–Ω reportlab==4.0.7

## üìÅ –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

```
services/order-service/
‚îú‚îÄ‚îÄ pdf_generator.py                 # 456 —Å—Ç—Ä–æ–∫
‚îú‚îÄ‚îÄ telegram_document_sender.py      # 160 —Å—Ç—Ä–æ–∫
‚îú‚îÄ‚îÄ test_pdf_generation.py           # 150 —Å—Ç—Ä–æ–∫
‚îú‚îÄ‚îÄ install_pdf_module.sh            # 40 —Å—Ç—Ä–æ–∫
‚îú‚îÄ‚îÄ PDF_README.md                    # –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îî‚îÄ‚îÄ sql/
    ‚îú‚îÄ‚îÄ get_min_prices.sql           # SQL –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ 1
    ‚îî‚îÄ‚îÄ get_mono_baskets.sql         # SQL –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ 2

sql/
‚îî‚îÄ‚îÄ add_document_fields_to_user_messages.sql  # –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î

shared/database/
‚îî‚îÄ‚îÄ models.py                        # –û–±–Ω–æ–≤–ª–µ–Ω–∞ –º–æ–¥–µ–ª—å UserMessage

requirements.txt                     # –î–æ–±–∞–≤–ª–µ–Ω reportlab
```

## üéØ –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

1. **–î–≤–∞ —Ä–∞–∑–¥–µ–ª–∞ –≤–º–µ—Å—Ç–æ —Ç—Ä–µ—Ö** - —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
2. **LSD —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é** - –µ—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ LSD –∏–º–µ—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—É—é –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Ü–µ–Ω—É
3. **–§–æ—Ä–º—É–ª–∞ —Ä–∞—Å—á–µ—Ç–∞ fprice** - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–∞–∫ –≤—ã—á–∏—Å–ª–µ–Ω–∞ —Ü–µ–Ω–∞
4. **–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Å—Ç–æ–∏–º–æ—Å—Ç–∏** - –º–æ–Ω–æ-–∫–æ—Ä–∑–∏–Ω—ã –æ—Ç –¥–µ—à–µ–≤–æ–π –∫ –¥–æ—Ä–æ–≥–æ–π
5. **–ê–ª—å–±–æ–º–Ω–∞—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è** - –¥–ª—è —à–∏—Ä–æ–∫–∏—Ö —Ç–∞–±–ª–∏—Ü
6. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –ë–î** - –≤—Å–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ PDF –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
cd /Users/ss/GenAI/korzinka/services/order-service
bash install_pdf_module.sh
```

### 2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –¢–µ—Å—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF
python test_pdf_generation.py 16

# –ì–¥–µ 16 - ID —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∑–∞–∫–∞–∑–∞
```

### 3. –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞

```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å order-service
cd /Users/ss/GenAI/korzinka
# ... –∫–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–∞
```

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

1. –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–∫–∞–∑ —á–µ—Ä–µ–∑ –ø–æ–ª–Ω—ã–π —Ñ–ª–æ—É
2. –î–æ–∂–¥–∞—Ç—å—Å—è —Å—Ç–∞—Ç—É—Å–∞ OPTIMIZED
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ Telegram:
   - ‚úâÔ∏è –¢–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç–æ–ø-1 –∫–æ—Ä–∑–∏–Ω–æ–π
   - üìÑ PDF-—Ñ–∞–π–ª —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º –æ—Ç—á–µ—Ç–æ–º
4. –û—Ç–∫—Ä—ã—Ç—å PDF –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:
   - –ö–∏—Ä–∏–ª–ª–∏—Ü–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
   - –¢–∞–±–ª–∏—Ü—ã —á–∏—Ç–∞–µ–º—ã
   - –î–∞–Ω–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã

## ‚ö†Ô∏è –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. **–®—Ä–∏—Ñ—Ç—ã DejaVu** - —Ç—Ä–µ–±—É—é—Ç—Å—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∏—Ä–∏–ª–ª–∏—Ü—ã
   - –ï—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Helvetica (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ)
   
2. **–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –µ–¥–∏–Ω–∏—Ü** - —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –≤ `_convert_to_base_unit()`
   - TODO: –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–Ω—É—é –ª–æ–≥–∏–∫—É –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –º–µ–∂–¥—É –µ–¥–∏–Ω–∏—Ü–∞–º–∏

3. **–†–∞–∑–º–µ—Ä PDF** - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω, –Ω–æ –ø—Ä–∏ –æ—á–µ–Ω—å –±–æ–ª—å—à–æ–º –∑–∞–∫–∞–∑–µ –º–æ–∂–µ—Ç –±—ã—Ç—å > 1 MB
   - –û–±—ã—á–Ω–æ < 100 KB

## üìä –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

- **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF:** ~0.5-2 —Å–µ–∫
- **–û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram:** ~1-3 —Å–µ–∫
- **–û–±—â–µ–µ –≤—Ä–µ–º—è:** ~2-5 —Å–µ–∫ –Ω–∞ –∑–∞–∫–∞–∑

## üé® –î–∏–∑–∞–π–Ω-—Ä–µ—à–µ–Ω–∏—è

1. **–ê–ª—å–±–æ–º–Ω–∞—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è** - –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è —à–∏—Ä–æ–∫–æ–π —Ç–∞–±–ª–∏—Ü—ã –≤ –†–∞–∑–¥–µ–ª–µ 1
2. **–°–µ—Ä–æ-–±–µ–ª–∞—è —Å—Ö–µ–º–∞** - –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –≤–∏–¥, —Ö–æ—Ä–æ—à–∞—è —á–∏—Ç–∞–µ–º–æ—Å—Ç—å
3. **–§–æ—Ä–º—É–ª–∞ —Ä–∞—Å—á–µ—Ç–∞** - –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
4. **–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Ü–µ–Ω–µ** - –æ—Ç –≤—ã–≥–æ–¥–Ω–æ–≥–æ –∫ –Ω–µ–≤—ã–≥–æ–¥–Ω–æ–º—É
5. **–ü–æ–¥—Ä–æ–±–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏** - –≤–∫–ª—é—á–µ–Ω—ã –≤ –∫–∞–∂–¥—É—é –º–æ–Ω–æ-–∫–æ—Ä–∑–∏–Ω—É

## üîÑ –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º –∫–æ–¥–µ

### main.py
- **–£–¥–∞–ª–µ–Ω–æ:** –õ–æ–≥–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–æ–ø-2 –∏ —Ç–æ–ø-3 –∫–æ—Ä–∑–∏–Ω —Ç–µ–∫—Å—Ç–æ–º
- **–î–æ–±–∞–≤–ª–µ–Ω–æ:** –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ PDF
- **–ò–∑–º–µ–Ω–µ–Ω–æ:** `process_optimized_orders()` - —É–ø—Ä–æ—â–µ–Ω–∞ –ª–æ–≥–∏–∫–∞

### models.py
- **–ò–∑–º–µ–Ω–µ–Ω–æ:** `UserMessage.message_text` - —Ç–µ–ø–µ—Ä—å nullable
- **–î–æ–±–∞–≤–ª–µ–Ω–æ:** 3 –Ω–æ–≤—ã—Ö –ø–æ–ª—è –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

## ‚ú® –¢—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã

| –≠—Ç–∞–ø | –ó–∞–¥–∞—á–∞ | –§–∞–∫—Ç |
|------|--------|------|
| 1 | SQL-–∑–∞–ø—Ä–æ—Å—ã | 1.5 —á |
| 2 | PDF-–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä | 4 —á |
| 3 | –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è | 1.5 —á |
| 4 | –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ | - |
| 5 | –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è | 1 —á |
| **–ò–¢–û–ì–û** | | **8 —á–∞—Å–æ–≤** |

## üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö

- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏: `/Users/ss/GenAI/korzinka/logs/order-service.log`
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É `user_messages` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫
- –°–º. —Ä–∞–∑–¥–µ–ª "–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫" –≤ `PDF_README.md`

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é
**–î–∞—Ç–∞:** 2025-10-06
