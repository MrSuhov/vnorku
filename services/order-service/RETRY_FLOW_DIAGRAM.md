# Retry Flow Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│                    ORDER SERVICE: Начало анализа                │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│  _search_products_in_batches(order_items, active_lsds)          │
│  • order_items = [1, 2, 3, 4, 5]                                │
│  • active_lsds = [Самокат, Озон]                                │
│  • product_retry_counts = {}                                    │
│  • retry_queue = []                                             │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│              ПЕРВИЧНЫЙ ПОИСК - Батч 1: [Самокат, Озон]          │
└─────────────────────────────────────────────────────────────────┘
                                ↓
                    ┌───────────┴───────────┐
                    ↓                       ↓
        ┌────────────────────┐  ┌────────────────────┐
        │  RPA: САМОКАТ      │  │  RPA: ОЗОН         │
        │  Products: [1-5]   │  │  Products: [1-5]   │
        └────────────────────┘  └────────────────────┘
                    ↓                       ↓
        ┌────────────────────┐  ┌────────────────────┐
        │  Found: [1,2,3,4]  │  │  Found: [1,2,3,4,5]│
        │  Failed: [5]       │  │  Failed: []        │
        └────────────────────┘  └────────────────────┘
                    ↓                       ↓
        ┌────────────────────┐  ┌────────────────────┐
        │  Return:           │  │  Return:           │
        │  (4, [5])          │  │  (5, [])           │
        └────────────────────┘  └────────────────────┘
                    └───────────┬───────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│                    АНАЛИЗ РЕЗУЛЬТАТОВ БАТЧА                      │
│                                                                  │
│  Самокат:                                                        │
│    ✅ stocks_found = 4                                          │
│    ⚠️  failed_products = [5]                                    │
│    → Product 5 в retry_queue: retry_count = 1/3                │
│                                                                  │
│  Озон:                                                           │
│    ✅ stocks_found = 5                                          │
│    ✅ failed_products = []                                      │
│    → Ничего не добавляем в retry_queue                         │
│                                                                  │
│  product_retry_counts = {(1, 5): 1}  # (lsd_id, item_id)       │
│  retry_queue = [(Самокат, [5])]                                 │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│                    RETRY ПРОЦЕСС                                 │
│                                                                  │
│  retry_queue = [(Самокат, [5])]                                 │
│                                                                  │
│  → Создаем retry батч: [(Самокат, [5])]                        │
│  → Фильтруем order_items: failed_items = [item_5]              │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│              RETRY ПОИСК - Только товар 5 в Самокате            │
└─────────────────────────────────────────────────────────────────┘
                                ↓
                        ┌───────────────┐
                        │  RPA: САМОКАТ │
                        │  Products: [5]│ ← ТОЛЬКО failed товар!
                        └───────────────┘
                                ↓
                    ┌───────────┴───────────┐
                    ↓                       ↓
        ┌────────────────────┐  ┌────────────────────┐
        │  Найден?           │  │  Не найден?        │
        │  Found: [5]        │  │  Found: []         │
        │  Failed: []        │  │  Failed: [5]       │
        └────────────────────┘  └────────────────────┘
                    ↓                       ↓
        ┌────────────────────┐  ┌────────────────────┐
        │  ✅ УСПЕХ          │  │  ⚠️ ПОВТОРИТЬ      │
        │  Return: (1, [])   │  │  Return: (0, [5])  │
        │                    │  │                    │
        │  product_retry     │  │  product_retry     │
        │  _counts = {}      │  │  _counts = {       │
        │  (очищаем)         │  │    (1,5): 2        │
        │                    │  │  }                 │
        │  Сохранено в БД!   │  │                    │
        └────────────────────┘  │  retry_count < 3?  │
                                │  → retry снова     │
                                │                    │
                                │  retry_count = 3?  │
                                │  → СТОП, max       │
                                │    retries         │
                                └────────────────────┘
                                        ↓
                            ┌───────────────────────┐
                            │  После 3 попыток:     │
                            │  ❌ Product 5:        │
                            │     max retries       │
                            │     exceeded          │
                            │                       │
                            │  → НЕТ записи в БД    │
                            └───────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                    ИТОГОВЫЙ РЕЗУЛЬТАТ В БД                       │
│                                                                  │
│  lsd_stocks для Самокат:                                         │
│    - order_item_id: 1 ✅                                        │
│    - order_item_id: 2 ✅                                        │
│    - order_item_id: 3 ✅                                        │
│    - order_item_id: 4 ✅                                        │
│    - order_item_id: 5 ❌ (отсутствует - не найден)             │
│                                                                  │
│  lsd_stocks для Озон:                                            │
│    - order_item_id: 1 ✅                                        │
│    - order_item_id: 2 ✅                                        │
│    - order_item_id: 3 ✅                                        │
│    - order_item_id: 4 ✅                                        │
│    - order_item_id: 5 ✅                                        │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                         ЛЕГЕНДА                                  │
│                                                                  │
│  ✅ - Успех / Найдено                                           │
│  ⚠️  - Внимание / Требуется retry                               │
│  ❌ - Ошибка / Не найдено после всех попыток                    │
│  → - Переход к следующему шагу                                  │
│  [X] - Список товаров                                           │
│  (X, [Y]) - Tuple: (количество найденных, список failed)        │
└─────────────────────────────────────────────────────────────────┘
```

## Ключевые моменты

1. **Первичный поиск**: Все товары ищутся во всех ЛСД параллельно
2. **Анализ результатов**: Определяются failed товары для каждого ЛСД
3. **Retry queue**: Создается только для failed товаров
4. **Retry поиск**: Ищутся ТОЛЬКО failed товары в конкретных ЛСД
5. **Счетчик попыток**: Индивидуальный для каждой пары (lsd_id, order_item_id)
6. **Максимум попыток**: 3 попытки, затем товар считается ненайденным
7. **База данных**: Только найденные товары сохраняются в lsd_stocks
