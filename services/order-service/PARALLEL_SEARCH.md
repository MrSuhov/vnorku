# ะะฐัะฐะปะปะตะปัะฝัะน ะฟะพะธัะบ ัะพะฒะฐัะพะฒ ะฒ ะะกะ

## ๐ ะะฑะทะพั

ะะตะฐะปะธะทะพะฒะฐะฝ ะฟะฐัะฐะปะปะตะปัะฝัะน ะฟะพะธัะบ ัะพะฒะฐัะพะฒ ะฟะพ ะฝะตัะบะพะปัะบะธะผ ะะกะ ั ะธัะฟะพะปัะทะพะฒะฐะฝะธะตะผ ะฑะฐััะตะน.

## ๐ฏ ะัะฝะพะฒะฝัะต ะฒะพะทะผะพะถะฝะพััะธ

### 1. ะะฐััะธะฝะณ
- ะะกะ ะดะตะปัััั ะฝะฐ ะฑะฐััะธ ะฟะพ N ะฑัะฐัะทะตัะพะฒ (ะฝะฐัััะฐะธะฒะฐะตััั)
- ะะฝัััะธ ะฑะฐััะฐ ะฟะพะธัะบ ะฒัะฟะพะปะฝัะตััั **ะฟะฐัะฐะปะปะตะปัะฝะพ**
- ะะฐััะธ ะฒัะฟะพะปะฝััััั **ะฟะพัะปะตะดะพะฒะฐัะตะปัะฝะพ** (ะดะปั ะบะพะฝััะพะปั ะฝะฐะณััะทะบะธ)

### 2. Retry ะผะตัะฐะฝะธะทะผ
- **Retry ัะตะฟะตัั ะฒะฝัััะธ RPA-ัะตัะฒะธัะฐ** - ะฑะพะปะตะต ัััะตะบัะธะฒะฝะพ
- ะ `perform_product_search_with_cdp_cookies()` ะฒะฝัััะธ ะพะดะฝะพะน ะฑัะฐัะทะตัะฝะพะน ัะตััะธะธ
- ะะฐะบัะธะผัะผ 3 ะฟะพะฟััะบะธ ะฝะฐ ัะพะฒะฐั ะฒะฝัััะธ ะพะดะฝะพะน ัะตััะธะธ
- ะะต ะฟะตัะตะพัะบััะฒะฐะตั ะฑัะฐัะทะตั - ะธัะฟะพะปัะทัะตั ัั ะถะต ัะตััะธั

### 3. ะะทะพะปััะธั ะะ
- ะะฐะถะดัะน ะะกะ ัะฐะฑะพัะฐะตั ัะพ ัะฒะพะตะน async ัะตััะธะตะน ะะ
- ะะตั race conditions ะฟัะธ ะทะฐะฟะธัะธ ะฒ `lsd_stocks`
- Commit ะฟัะพะธััะพะดะธั ััะฐะทั ะฟะพัะปะต ะทะฐะฒะตััะตะฝะธั ะฟะพะธัะบะฐ ะฒ ะะกะ

## โ๏ธ ะะฐัััะพะนะบะธ

ะ `.env` ะธะปะธ `config/settings.py`:

```env
# ะะพะปะธัะตััะฒะพ ะฑัะฐัะทะตัะพะฒ ะฒ ะพะดะฝะพะผ ะฑะฐััะต (ะฟะฐัะฐะปะปะตะปัะฝะพ)
MAX_CONCURRENT_BROWSERS=3
```

## ๐ ะััะธัะตะบัััะฐ

```
Order Service: perform_order_analysis()
    โ
_search_products_in_batches()
    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Batch 1: [ะะกะ1, ะะกะ2, ะะกะ3] (parallel)  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Batch 2: [ะะกะ4, ะะกะ5, ะะกะ6] (parallel)  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ
    ... (ะพััะฐะปัะฝัะต ะฑะฐััะธ)
    โ
    
RPA Service: perform_product_search_with_cdp_cookies()
    โ
    Retry ะฒะฝัััะธ ะพะดะฝะพะน ัะตััะธะธ (ะดะพ 3 ัะฐะท)
```

## ๐ ะัะธะผะตั ะปะพะณะพะฒ

```
๐ Starting batched parallel search: 14 LSDs, batch size=3
๐ฆ Created 5 batches of LSDs

๐ Processing batch 1/5: 3 LSDs
  โ ะกะฐะผะพะบะฐั: 45 stocks found
  โ ะฏะฝะดะตะบั ะะฐะฒะบะฐ: 38 stocks found
  โ๏ธ ะะบััะะธะปะป: no stocks found

๐ Processing batch 2/5: 3 LSDs
  โ Ozon: 52 stocks found
  ...

๐ Batched search completed: 210 total stocks found

--- ะ RPA-ัะตัะฒะธัะต ะดะปั ะฟัะพะฑะปะตะผะฝะพะณะพ ะะกะ ---
โ๏ธ 3 products not found on first attempt
๐ RETRY PHASE: attempting 3 products again (attempt 1/3)
  โ Found 2 products on retry
  โ๏ธ 1 product still not found
๐ RETRY PHASE: attempting 1 products again (attempt 2/3)
  โ Found 1 product on retry
โ Search complete: 45/45 products found after retries
```

## ๐ง ะคัะฝะบัะธะธ

### `_search_products_in_batches()`
ะะปะฐะฒะฝะฐั ััะฝะบัะธั ะดะปั ะฟะฐัะฐะปะปะตะปัะฝะพะณะพ ะฟะพะธัะบะฐ:
- ะกะพะทะดะฐะตั ะฑะฐััะธ ะะกะ
- ะะฐะฟััะบะฐะตั ะฟะฐัะฐะปะปะตะปัะฝัะน ะฟะพะธัะบ ะฒ ะฑะฐััะฐั
- ะะพะทะฒัะฐัะฐะตั ะพะฑัะตะต ะบะพะปะธัะตััะฒะพ ะฝะฐะนะดะตะฝะฝัั stocks

### `_process_lsd_batch()`
ะะฑัะฐะฑะพัะบะฐ ะพะดะฝะพะณะพ ะฑะฐััะฐ ะฟะฐัะฐะปะปะตะปัะฝะพ:
- ะกะพะทะดะฐะตั asyncio.Task ะดะปั ะบะฐะถะดะพะณะพ ะะกะ
- ะัะฟะพะปัะทัะตั `asyncio.gather()` ั `return_exceptions=True`
- ะะพะทะฒัะฐัะฐะตั ัะฟะธัะพะบ (lsd, stocks_count)

### `_search_products_in_lsd_isolated()`
ะะทะพะปะธัะพะฒะฐะฝะฝัะน ะฟะพะธัะบ ะฒ ะพะดะฝะพะผ ะะกะ:
- ะกะพะทะดะฐะตั ัะพะฑััะฒะตะฝะฝัั ัะตััะธั ะะ
- ะัะทัะฒะฐะตั `_search_products_in_lsd()`
- ะะพะผะผะธัะธั ัะตะทัะปััะฐัั ะฝะตะผะตะดะปะตะฝะฝะพ
- ะะพะทะฒัะฐัะฐะตั ะบะพะปะธัะตััะฒะพ ะฝะฐะนะดะตะฝะฝัั stocks

### `_search_products_in_lsd()`
ะะพะธัะบ ัะพะฒะฐัะพะฒ ัะตัะตะท RPA Service:
- ะะพะดะณะพัะฐะฒะปะธะฒะฐะตั ะดะฐะฝะฝัะต ะดะปั RPA
- ะัะทัะฒะฐะตั RPA-ัะตัะฒะธั ัะตัะตะท HTTP
- ะะพะทะฒัะฐัะฐะตั ะบะพะปะธัะตััะฒะพ ัะพััะฐะฝะตะฝะฝัั ัะตะทัะปััะฐัะพะฒ

## โ๏ธ ะะฐะถะฝัะต ะผะพะผะตะฝัั

1. **ะะทะพะปััะธั ะะ**: ะบะฐะถะดัะน ะะกะ ัะฐะฑะพัะฐะตั ัะพ ัะฒะพะตะน async ัะตััะธะตะน
2. **Retry ะฒ RPA**: ะฟะพะฒัะพัะฝัะต ะฟะพะฟััะบะธ ะะะฃะขะะ ะฑัะฐัะทะตัะฝะพะน ัะตััะธะธ (ัััะตะบัะธะฒะฝะตะต)
3. **ะะณัะฐะฝะธัะตะฝะธะต ะฝะฐะณััะทะบะธ**: ะฑะฐััะธ ะฒัะฟะพะปะฝััััั ะฟะพัะปะตะดะพะฒะฐัะตะปัะฝะพ
4. **ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ**: exceptions ะปะพะฒัััั ัะตัะตะท `return_exceptions=True`
5. **ะะตั ะดัะฑะปะธัะพะฒะฐะฝะธั retry**: retry ัะพะปัะบะพ ะฒ RPA-ัะตัะฒะธัะต, ะฝะต ะฝะฐ ััะพะฒะฝะต ะฑะฐััะตะน

## ๐ ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั

**ะะพ ะธะทะผะตะฝะตะฝะธะน:**
- 14 ะะกะ ร 30 ัะตะบ = ~7 ะผะธะฝัั (ะฟะพัะปะตะดะพะฒะฐัะตะปัะฝะพ)

**ะะพัะปะต ะฑะฐััะธะฝะณะฐ:**
- 5 ะฑะฐััะตะน ร 30 ัะตะบ = ~2.5 ะผะธะฝััั (ะฟะฐัะฐะปะปะตะปัะฝะพ ะฟะพ 3)
- **ะัะพะณะพ: ~2.5 ะผะธะฝััั** (ััะบะพัะตะฝะธะต ะฒ 2.8 ัะฐะทะฐ)

**ะก retry ะฒ RPA:**
- Retry ะฝะต ะดะพะฑะฐะฒะปัะตั ะฒัะตะผะตะฝะธ (ะฒ ัะพะน ะถะต ัะตััะธะธ)
- ะขะพะปัะบะพ 2-ัะตะบัะฝะดะฝะฐั ะฟะฐัะทะฐ ะผะตะถะดั ัะพะฒะฐัะฐะผะธ

## ๐งช ะขะตััะธัะพะฒะฐะฝะธะต

ะะปั ัะตััะธัะพะฒะฐะฝะธั:

1. ะฃะฑะตะดะธัะตัั ััะพ ั ะฟะพะปัะทะพะฒะฐัะตะปั ะตััั ะฐะฒัะพัะธะทะฐัะธะธ ะฒ ะฝะตัะบะพะปัะบะธั ะะกะ
2. ะกะพะทะดะฐะนัะต ะทะฐะบะฐะท ัะตัะตะท ะฑะพัะฐ
3. ะะพะดัะฒะตัะดะธัะต ะทะฐะบะฐะท
4. ะะฐะฟัััะธัะต ะฐะฝะฐะปะธะท: `/orders/{order_id}/analyze`
5. ะะฐะฑะปัะดะฐะนัะต ะปะพะณะธ ั ะฟะฐัะฐะปะปะตะปัะฝัะผ ะฒัะฟะพะปะฝะตะฝะธะตะผ

## ๐ ะะพะทะผะพะถะฝัะต ัะปัััะตะฝะธั

- [ ] ะะธะฝะฐะผะธัะตัะบะฐั ะฐะดะฐะฟัะฐัะธั batch size ะฒ ะทะฐะฒะธัะธะผะพััะธ ะพั ะฝะฐะณััะทะบะธ
- [ ] ะัะธะพัะธัะธะทะฐัะธั ะะกะ ะฟะพ ัะบะพัะพััะธ ะพัะฒะตัะฐ
- [ ] ะะตััะธะบะธ ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััะธ (Prometheus)
- [ ] Graceful shutdown ะฟัะธ ะพัะผะตะฝะต ะทะฐะบะฐะทะฐ
