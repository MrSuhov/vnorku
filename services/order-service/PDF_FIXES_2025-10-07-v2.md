# Исправления PDF-генератора от 07.10.2025 (v2)

## Обзор проблем и решений

### ❌ Проблема 1: Отсутствие части товаров в Разделе 1 (например, Яйца)

**Причина:** SQL-запрос фильтровал только товары с `loss = 0`, исключая товары где нет таких вариантов.

**Решение:**
- ✅ Удален фильтр `AND bc.loss = 0` из основного запроса
- ✅ Добавлена сортировка `ORDER BY bc.order_item_id, bc.loss ASC` для приоритета товаров с меньшими потерями
- ✅ Теперь показываются ВСЕ товары из заказа, даже если для них нет варианта с нулевыми потерями

**Измененный файл:** `/Users/ss/GenAI/korzinka/services/order-service/sql/get_min_prices.sql`

---

### ❌ Проблема 2: Белый шрифт в заголовках таблиц не применился

**Причина:** Использование `bold_style` с `textColor=DARK_GREY` переопределяло белый цвет из `TableStyle`.

**Решение:**
- ✅ Создан новый стиль `table_header_style` с `textColor=WHITE`
- ✅ Все заголовки таблиц во всех разделах (0, 1, 2) обновлены для использования `table_header_style`
- ✅ Удалены теги `<b>...</b>` из текста заголовков (жирность задается стилем)

**Измененный файл:** `/Users/ss/GenAI/korzinka/services/order-service/pdf_generator.py`

**Код нового стиля:**
```python
self.table_header_style = ParagraphStyle(
    'TableHeader',
    parent=self.styles['Normal'],
    textColor=WHITE,
    fontSize=9,
    fontName=self.font_name_bold,
    alignment=TA_CENTER,
    spaceAfter=0
)
```

---

### ❌ Проблема 3: Использовать англоязычное имя ЛСД (lsd_name)

**Причина:** SQL использовал `lc.display_name` (русское название).

**Решение:**
- ✅ Изменено `lc.display_name` → `lc.lsd_name` в SQL-запросе
- ✅ Изменено `lsd_display_name` → `lsd_name` в агрегации

**Измененный файл:** `/Users/ss/GenAI/korzinka/services/order-service/sql/get_min_prices.sql`

**Результат:** В колонке "Сервис" Раздела 1 теперь отображаются англоязычные названия (например, "yandex_lavka" вместо "Яндекс Лавка").

---

### ❌ Проблема 4: Отсутствуют условия доставки в Разделе 2

**Решение:**
- ✅ Добавлен блок "Условия доставки" после строки с итогами
- ✅ Используется метод `_parse_delivery_model()` для форматирования
- ✅ Выводится минимальная сумма заказа и диапазоны стоимости доставки

**Измененный файл:** `/Users/ss/GenAI/korzinka/services/order-service/pdf_generator.py`

**Пример вывода:**
```
ВСЕГО: 2500.00 руб | Итого потерь и доставок: 730.54 руб

Условия доставки:
• Минимальная сумма заказа: 0.00 руб
• Диапазоны доставки:
  - От 0.00 руб: 149.00 руб
  - От 1000.00 руб: 99.00 руб
  - От 2000.00 руб: бесплатно
```

---

### ❌ Проблема 5: Неправильный расчет потерь в Разделе 2

**Старая формула (НЕПРАВИЛЬНАЯ):**
```python
loss = float(item.get('order_item_ids_cost', 0)) - (float(item.get('fprice_min', 0)) * float(item.get('order_item_ids_quantity', 0)))
```

**Проблема:** Сравнивала общую стоимость товара с минимальной возможной стоимостью, что давало огромные отрицательные значения.

**Новая формула (ПРАВИЛЬНАЯ):**
```python
loss = (float(item['fprice']) - float(item.get('fprice_min', 0))) * float(item.get('order_item_ids_quantity', 0))
```

**Объяснение:**
- `fprice` = цена за кг/л в текущем ЛСД
- `fprice_min` = минимальная цена за кг/л среди всех ЛСД
- `order_item_ids_quantity` = количество в базовых единицах (кг/л)
- **Потери** = разница в цене за единицу × количество

**Пример расчета:**
- fprice = 1011.76 руб/кг
- fprice_min = 1011.65 руб/кг
- quantity = 0.09 кг
- **loss = (1011.76 - 1011.65) × 0.09 = 0.11 × 0.09 = 0.0099 ≈ 0.01 руб** ✅

**Измененный файл:** `/Users/ss/GenAI/korzinka/services/order-service/pdf_generator.py`

---

## Итоговый список изменений

### Файлы изменены:

1. **`/Users/ss/GenAI/korzinka/services/order-service/sql/get_min_prices.sql`**
   - Удален фильтр `loss = 0`
   - Изменено `display_name` → `lsd_name`
   - Добавлена сортировка по `loss ASC`

2. **`/Users/ss/GenAI/korzinka/services/order-service/pdf_generator.py`**
   - Добавлен стиль `table_header_style` с белым текстом
   - Обновлены заголовки таблиц во всех разделах (0, 1, 2)
   - Исправлена формула расчета потерь в Разделе 2
   - Добавлен блок "Условия доставки" в Раздел 2

---

## Тестирование

### Что проверять в новом PDF:

#### ✅ Раздел 1: Минимальные цены
- [ ] **Все товары** из заказа присутствуют в таблице (включая Яйца)
- [ ] Заголовки таблицы: **белый текст на сером фоне**
- [ ] Колонка "Сервис": **англоязычные названия** (yandex_lavka, samokat, etc.)

#### ✅ Раздел 2: Монокорзины
- [ ] Заголовки таблицы: **белый текст на сером фоне**
- [ ] Колонка "Потери": **корректные значения** (малые числа, не отрицательные)
- [ ] После строки "ВСЕГО" присутствует блок **"Условия доставки"**
- [ ] Условия доставки показывают минимальную сумму и диапазоны стоимости

#### ✅ Раздел 0: Лучшая корзина
- [ ] Заголовки таблицы: **белый текст на сером фоне**

---

## Примеры правильных значений

### Потери в Разделе 2:
```
Товар: Сливочное масло
fprice: 1011.76 руб/кг
fprice_min: 1011.65 руб/кг
Количество: 0.09 кг
Потери: (1011.76 - 1011.65) × 0.09 = 0.01 руб ✅
```

### Условия доставки:
```
Условия доставки:
• Минимальная сумма заказа: 0.00 руб
• Диапазоны доставки:
  - От 0.00 руб: 149.00 руб
  - От 1000.00 руб: 99.00 руб
  - От 2000.00 руб: бесплатно
```

---

## Команды для тестирования

```bash
# 1. Запуск order-service
cd /Users/ss/GenAI/korzinka/services/order-service
source ../../venv/bin/activate
python main.py

# 2. Создать тестовый заказ через Telegram
# 3. Дождаться статуса OPTIMIZED
# 4. Скачать и проверить PDF
```

---

## Дата изменений

**07.10.2025 (v2)** - Критические исправления: белый текст заголовков, все товары в Разделе 1, правильные потери, условия доставки, англоязычные имена ЛСД
